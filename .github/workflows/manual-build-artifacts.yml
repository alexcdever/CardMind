name: Manual Build Artifacts

on:
  workflow_dispatch:

concurrency:
  group: manual-build-artifacts-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  android-apk:
    name: Android APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust

      - name: Cache cargo installed tools
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin
          key: ${{ runner.os }}-cargo-bin-v1-frb-2.11.1-cargo-ndk

      - name: Prepare Flutter dependencies
        run: flutter pub get

      - name: Install flutter_rust_bridge codegen
        run: |
          if ! command -v flutter_rust_bridge_codegen >/dev/null 2>&1; then
            cargo install flutter_rust_bridge_codegen --version 2.11.1 --locked
          fi

      - name: Generate FRB bindings
        run: flutter_rust_bridge_codegen generate

      - name: Install Android Rust targets
        run: rustup target add aarch64-linux-android armv7-linux-androideabi x86_64-linux-android

      - name: Install cargo-ndk
        run: |
          if ! command -v cargo-ndk >/dev/null 2>&1; then
            cargo install cargo-ndk --locked
          fi

      - name: Build Rust Android libraries
        run: |
          mkdir -p ../android/app/src/main/jniLibs
          cargo ndk -o ../android/app/src/main/jniLibs -t armeabi-v7a -t arm64-v8a -t x86_64 build --release
        working-directory: rust

      - name: Build APK
        run: flutter build apk --release

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: cardmind-android-apk-${{ github.run_number }}
          path: build/app/outputs/flutter-apk/*.apk

  macos-app:
    name: macOS App
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust

      - name: Cache cargo installed tools
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin
          key: ${{ runner.os }}-cargo-bin-v1-frb-2.11.1

      - name: Prepare Flutter dependencies
        run: flutter pub get

      - name: Build Rust library
        run: cargo build --release
        working-directory: rust

      - name: Install flutter_rust_bridge codegen
        run: |
          if ! command -v flutter_rust_bridge_codegen >/dev/null 2>&1; then
            cargo install flutter_rust_bridge_codegen --version 2.11.1 --locked
          fi

      - name: Generate FRB bindings
        run: flutter_rust_bridge_codegen generate

      - name: Build macOS app
        run: flutter build macos --release

      - name: Pack macOS app
        run: |
          ditto -c -k --sequesterRsrc --keepParent build/macos/Build/Products/Release/cardmind.app cardmind-macos-release.zip

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: cardmind-macos-app-${{ github.run_number }}
          path: cardmind-macos-release.zip

  windows-app:
    name: Windows App
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust

      - name: Cache cargo installed tools
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\cargo\bin
          key: ${{ runner.os }}-cargo-bin-v1-frb-2.11.1

      - name: Prepare Flutter dependencies
        run: flutter pub get

      - name: Build Rust library
        run: cargo build --release
        working-directory: rust

      - name: Install flutter_rust_bridge codegen
        shell: pwsh
        run: |
          if (-not (Get-Command flutter_rust_bridge_codegen -ErrorAction SilentlyContinue)) {
            cargo install flutter_rust_bridge_codegen --version 2.11.1 --locked
          }

      - name: Generate FRB bindings
        run: flutter_rust_bridge_codegen generate

      - name: Build Windows app
        run: flutter build windows --release

      - name: Pack Windows app
        shell: pwsh
        run: Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath cardmind-windows-release.zip -Force

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: cardmind-windows-app-${{ github.run_number }}
          path: cardmind-windows-release.zip
