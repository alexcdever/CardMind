name: Release

on:
  push:
    branches:
      - release  # 仅 release 分支触发（HEAD 必须带 v* tag 才会发布）

# 明确声明需要的权限
permissions:
  contents: write  # 创建 release 和上传资产需要写权限

env:
  FLUTTER_VERSION: '3.38.5'
  RUST_VERSION: 'stable'

jobs:
  # 提取版本号，供其他 jobs 使用
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.resolve_tag.outputs.version }}
      tag: ${{ steps.resolve_tag.outputs.tag }}
      should_release: ${{ steps.resolve_tag.outputs.should_release }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Resolve tag on release HEAD
        id: resolve_tag
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --force
          tag=$(git tag --points-at HEAD --list 'v*' | sort -V | tail -n 1 || true)
          if [[ -z "$tag" ]]; then
            echo "No v* tag on release HEAD; skip publishing."
            echo "should_release=false" >> "$GITHUB_OUTPUT"
            echo "tag=" >> "$GITHUB_OUTPUT"
            echo "version=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "should_release=true" >> "$GITHUB_OUTPUT"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "version=${tag#v}" >> "$GITHUB_OUTPUT"

  build-android:
    name: Build Android
    needs: prepare
    if: needs.prepare.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android

      - name: Install cargo-ndk
        run: cargo install cargo-ndk

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26d
          add-to-path: true

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/target/
          key: ${{ runner.os }}-cargo-android-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}

      - name: Install dependencies
        run: flutter pub get

      - name: Install flutter_rust_bridge_codegen
        run: |
          if ! command -v flutter_rust_bridge_codegen &> /dev/null; then
            cargo install flutter_rust_bridge_codegen
          else
            echo "flutter_rust_bridge_codegen already installed"
          fi

      - name: Generate bridge code
        run: dart tool/generate_bridge.dart

      - name: Build Android
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: dart tool/build_all.dart --android

      - name: Rename APK
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk \
             cardmind-${{ needs.prepare.outputs.version }}-android.apk

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: cardmind-${{ needs.prepare.outputs.version }}-android.apk

  build-linux:
    name: Build Linux
    needs: prepare
    if: needs.prepare.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config libgtk-3-dev \
            liblzma-dev libstdc++-12-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/target/
          key: ${{ runner.os }}-cargo-linux-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}

      - name: Install dependencies
        run: flutter pub get

      - name: Install flutter_rust_bridge_codegen
        run: |
          if ! command -v flutter_rust_bridge_codegen &> /dev/null; then
            cargo install flutter_rust_bridge_codegen
          else
            echo "flutter_rust_bridge_codegen already installed"
          fi

      - name: Generate bridge code
        run: dart tool/generate_bridge.dart

      - name: Build Linux
        run: dart tool/build_all.dart --linux

      - name: Package Linux build
        run: |
          cd build/linux/x64/release/bundle
          tar -czf ../../../../../cardmind-${{ needs.prepare.outputs.version }}-linux.tar.gz *
          cd ../../../../..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-tarball
          path: cardmind-${{ needs.prepare.outputs.version }}-linux.tar.gz

  build-windows:
    name: Build Windows
    needs: prepare
    if: needs.prepare.outputs.should_release == 'true'
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}

      - name: Install dependencies
        run: flutter pub get

      - name: Install flutter_rust_bridge_codegen
        shell: bash
        run: |
          if ! command -v flutter_rust_bridge_codegen &> /dev/null; then
            cargo install flutter_rust_bridge_codegen
          else
            echo "flutter_rust_bridge_codegen already installed"
          fi

      - name: Generate bridge code
        run: dart tool/generate_bridge.dart

      - name: Build Windows
        run: dart tool/build_all.dart --windows

      - name: Package Windows build
        run: |
          Compress-Archive -Path build/windows/x64/runner/Release/* `
            -DestinationPath cardmind-${{ needs.prepare.outputs.version }}-windows.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip
          path: cardmind-${{ needs.prepare.outputs.version }}-windows.zip

  build-macos:
    name: Build macOS
    needs: prepare
    if: needs.prepare.outputs.should_release == 'true'
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}

      - name: Install dependencies
        run: flutter pub get

      - name: Install flutter_rust_bridge_codegen
        run: |
          if ! command -v flutter_rust_bridge_codegen &> /dev/null; then
            cargo install flutter_rust_bridge_codegen
          else
            echo "flutter_rust_bridge_codegen already installed"
          fi

      - name: Generate bridge code
        run: dart tool/generate_bridge.dart

      - name: Build macOS
        run: dart tool/build_all.dart --macos

      - name: Package macOS build
        run: |
          cd build/macos/Build/Products/Release
          zip -r ../../../../../cardmind-${{ needs.prepare.outputs.version }}-macos.zip cardmind.app
          cd ../../../../..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-zip
          path: cardmind-${{ needs.prepare.outputs.version }}-macos.zip

  build-ios:
    name: Build iOS
    needs: prepare
    if: needs.prepare.outputs.should_release == 'true'
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: aarch64-apple-ios,x86_64-apple-ios

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/target/
          key: ${{ runner.os }}-cargo-ios-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}

      - name: Install dependencies
        run: flutter pub get

      - name: Install flutter_rust_bridge_codegen
        run: |
          if ! command -v flutter_rust_bridge_codegen &> /dev/null; then
            cargo install flutter_rust_bridge_codegen
          else
            echo "flutter_rust_bridge_codegen already installed"
          fi

      - name: Generate bridge code
        run: dart tool/generate_bridge.dart

      - name: Build iOS
        run: dart tool/build_all.dart --ios

      - name: Package iOS build
        run: |
          cd build/ios/iphoneos
          zip -r ../../../cardmind-${{ needs.prepare.outputs.version }}-ios.zip Runner.app
          cd ../../..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-zip
          path: cardmind-${{ needs.prepare.outputs.version }}-ios.zip

  # 创建 release 并上传所有构建产物
  release:
    name: Create Release
    needs: [prepare, build-android, build-linux, build-windows, build-macos, build-ios]
    # 即使某些平台构建失败，也创建 release（只上传成功的平台）
    if: always() && needs.prepare.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: Display structure of downloaded files
        run: ls -R artifacts || echo "No artifacts found"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: CardMind ${{ needs.prepare.outputs.version }}
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
          body: |
            ## CardMind ${{ needs.prepare.outputs.version }}

            ### 下载

            以下为成功构建的平台（部分平台可能构建失败）：

            - **Android**: `cardmind-${{ needs.prepare.outputs.version }}-android.apk`
            - **Linux**: `cardmind-${{ needs.prepare.outputs.version }}-linux.tar.gz`
            - **Windows**: `cardmind-${{ needs.prepare.outputs.version }}-windows.zip`
            - **macOS**: `cardmind-${{ needs.prepare.outputs.version }}-macos.zip`
            - **iOS**: `cardmind-${{ needs.prepare.outputs.version }}-ios.zip`

            如某个平台文件不存在，说明该平台构建失败，请查看 [Actions](https://github.com/${{ github.repository }}/actions) 了解详情。

            ### 更新内容

            请查看 [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)

            ### 注意事项

            - iOS 和 macOS 版本未签名，仅供开发测试使用
            - 首次运行可能需要在系统偏好设置中允许
          files: |
            artifacts/android-apk/*.apk
            artifacts/linux-tarball/*.tar.gz
            artifacts/windows-zip/*.zip
            artifacts/macos-zip/*.zip
            artifacts/ios-zip/*.zip
