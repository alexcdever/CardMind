name: Dev Release

on:
  push:
    branches:
      - dev  # è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° dev åˆ†æ”¯

# æ˜ç¡®å£°æ˜éœ€è¦çš„æƒé™
permissions:
  contents: write  # åˆ›å»º release å’Œä¸Šä¼ èµ„äº§éœ€è¦å†™æƒé™

env:
  FLUTTER_VERSION: '3.38.5'
  RUST_VERSION: 'stable'

jobs:
  # æå–ç‰ˆæœ¬å·ï¼Œä¾›å…¶ä»– jobs ä½¿ç”¨
  prepare:
    name: Prepare Dev Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Get version from commit
        id: get_version
        run: |
          # ä½¿ç”¨æ—¥æœŸå’ŒçŸ­commit SHAä½œä¸ºdevç‰ˆæœ¬å·
          VERSION="dev-$(date +'%Y%m%d')-${GITHUB_SHA::7}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

  build-android:
    name: Build Android (Dev)
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android

      - name: Install cargo-ndk
        run: cargo install cargo-ndk

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26d
          add-to-path: true

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/target/
          key: ${{ runner.os }}-cargo-android-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}

      - name: Install dependencies
        run: flutter pub get

      - name: Install flutter_rust_bridge_codegen
        run: |
          if ! command -v flutter_rust_bridge_codegen &> /dev/null; then
            cargo install flutter_rust_bridge_codegen
          else
            echo "flutter_rust_bridge_codegen already installed"
          fi

      - name: Generate bridge code
        run: dart tool/generate_bridge.dart

      - name: Build Android
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: dart tool/build_all.dart --android

      - name: Rename APK
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk \
             cardmind-${{ needs.prepare.outputs.version }}-android.apk

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: cardmind-${{ needs.prepare.outputs.version }}-android.apk

  build-linux:
    name: Build Linux (Dev)
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config libgtk-3-dev \
            liblzma-dev libstdc++-12-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/target/
          key: ${{ runner.os }}-cargo-linux-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}

      - name: Install dependencies
        run: flutter pub get

      - name: Install flutter_rust_bridge_codegen
        run: |
          if ! command -v flutter_rust_bridge_codegen &> /dev/null; then
            cargo install flutter_rust_bridge_codegen
          else
            echo "flutter_rust_bridge_codegen already installed"
          fi

      - name: Generate bridge code
        run: dart tool/generate_bridge.dart

      - name: Build Linux
        run: dart tool/build_all.dart --linux

      - name: Package Linux build
        run: |
          cd build/linux/x64/release/bundle
          tar -czf ../../../../../cardmind-${{ needs.prepare.outputs.version }}-linux.tar.gz *
          cd ../../../../..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-tarball
          path: cardmind-${{ needs.prepare.outputs.version }}-linux.tar.gz

  build-windows:
    name: Build Windows (Dev)
    needs: prepare
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}

      - name: Install dependencies
        run: flutter pub get

      - name: Install flutter_rust_bridge_codegen
        shell: bash
        run: |
          if ! command -v flutter_rust_bridge_codegen &> /dev/null; then
            cargo install flutter_rust_bridge_codegen
          else
            echo "flutter_rust_bridge_codegen already installed"
          fi

      - name: Generate bridge code
        run: dart tool/generate_bridge.dart

      - name: Build Windows
        run: dart tool/build_all.dart --windows

      - name: Package Windows build
        run: |
          Compress-Archive -Path build/windows/x64/runner/Release/* `
            -DestinationPath cardmind-${{ needs.prepare.outputs.version }}-windows.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip
          path: cardmind-${{ needs.prepare.outputs.version }}-windows.zip

  build-macos:
    name: Build macOS (Dev)
    needs: prepare
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}

      - name: Install dependencies
        run: flutter pub get

      - name: Install flutter_rust_bridge_codegen
        run: |
          if ! command -v flutter_rust_bridge_codegen &> /dev/null; then
            cargo install flutter_rust_bridge_codegen
          else
            echo "flutter_rust_bridge_codegen already installed"
          fi

      - name: Generate bridge code
        run: dart tool/generate_bridge.dart

      - name: Build macOS
        run: dart tool/build_all.dart --macos

      - name: Package macOS build
        run: |
          cd build/macos/Build/Products/Release
          zip -r ../../../../../cardmind-${{ needs.prepare.outputs.version }}-macos.zip cardmind.app
          cd ../../../../..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-zip
          path: cardmind-${{ needs.prepare.outputs.version }}-macos.zip

  build-ios:
    name: Build iOS (Dev)
    needs: prepare
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: aarch64-apple-ios,x86_64-apple-ios

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/target/
          key: ${{ runner.os }}-cargo-ios-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}

      - name: Install dependencies
        run: flutter pub get

      - name: Install flutter_rust_bridge_codegen
        run: |
          if ! command -v flutter_rust_bridge_codegen &> /dev/null; then
            cargo install flutter_rust_bridge_codegen
          else
            echo "flutter_rust_bridge_codegen already installed"
          fi

      - name: Generate bridge code
        run: dart tool/generate_bridge.dart

      - name: Build iOS
        run: dart tool/build_all.dart --ios

      - name: Package iOS build
        run: |
          cd build/ios/iphoneos
          zip -r ../../../cardmind-${{ needs.prepare.outputs.version }}-ios.zip Runner.app
          cd ../../..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-zip
          path: cardmind-${{ needs.prepare.outputs.version }}-ios.zip

  # åˆ›å»º dev release å¹¶ä¸Šä¼ æ‰€æœ‰æ„å»ºäº§ç‰©
  release:
    name: Create Dev Release
    needs: [prepare, build-android, build-linux, build-windows, build-macos, build-ios]
    # å³ä½¿æŸäº›å¹³å°æ„å»ºå¤±è´¥ï¼Œä¹Ÿåˆ›å»º releaseï¼ˆåªä¸Šä¼ æˆåŠŸçš„å¹³å°ï¼‰
    if: always() && needs.prepare.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: Display structure of downloaded files
        run: ls -R artifacts || echo "No artifacts found"

      - name: Create Dev Release
        uses: softprops/action-gh-release@v2
        with:
          name: CardMind ${{ needs.prepare.outputs.version }}
          tag_name: ${{ needs.prepare.outputs.version }}
          draft: false
          prerelease: true  # æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          fail_on_unmatched_files: false
          body: |
            ## CardMind ${{ needs.prepare.outputs.version }}

            ğŸš§ **è¿™æ˜¯ä¸€ä¸ªå¼€å‘ç‰ˆæœ¬ (Dev Build)** ğŸš§

            æ­¤ç‰ˆæœ¬ä» `dev` åˆ†æ”¯è‡ªåŠ¨æ„å»ºï¼Œç”¨äºæµ‹è¯•å’Œå¼€å‘ç›®çš„ã€‚

            **æ„å»ºä¿¡æ¯**:
            - åˆ†æ”¯: `dev`
            - Commit: ${{ github.sha }}
            - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}

            ### ä¸‹è½½

            ä»¥ä¸‹ä¸ºæˆåŠŸæ„å»ºçš„å¹³å°ï¼ˆéƒ¨åˆ†å¹³å°å¯èƒ½æ„å»ºå¤±è´¥ï¼‰ï¼š

            - **Android**: `cardmind-${{ needs.prepare.outputs.version }}-android.apk`
            - **Linux**: `cardmind-${{ needs.prepare.outputs.version }}-linux.tar.gz`
            - **Windows**: `cardmind-${{ needs.prepare.outputs.version }}-windows.zip`
            - **macOS**: `cardmind-${{ needs.prepare.outputs.version }}-macos.zip`
            - **iOS**: `cardmind-${{ needs.prepare.outputs.version }}-ios.zip`

            å¦‚æŸä¸ªå¹³å°æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯´æ˜è¯¥å¹³å°æ„å»ºå¤±è´¥ï¼Œè¯·æŸ¥çœ‹ [Actions](https://github.com/${{ github.repository }}/actions) äº†è§£è¯¦æƒ…ã€‚

            ### âš ï¸ æ³¨æ„äº‹é¡¹

            - è¿™æ˜¯**æœªç»å……åˆ†æµ‹è¯•**çš„å¼€å‘ç‰ˆæœ¬ï¼Œå¯èƒ½å­˜åœ¨ä¸¥é‡bug
            - iOS å’Œ macOS ç‰ˆæœ¬æœªç­¾åï¼Œä»…ä¾›å¼€å‘æµ‹è¯•ä½¿ç”¨
            - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­å…è®¸
            - **ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨æ­¤ç‰ˆæœ¬**

            ### æœ€è¿‘çš„æäº¤

            ${{ github.event.head_commit.message }}
          files: |
            artifacts/android-apk/*.apk
            artifacts/linux-tarball/*.tar.gz
            artifacts/windows-zip/*.zip
            artifacts/macos-zip/*.zip
            artifacts/ios-zip/*.zip
