## Context

CardMind 已经实现了基础的 P2P 同步架构，但缺少桌面端专用的设备管理界面。桌面端与移动端有显著差异：更大的屏幕空间、鼠标键盘交互、文件上传便利性，以及不同的设备发现需求。

原始设计文档详细定义了桌面端设备管理的技术决策，包括使用 libp2p PeerId 作为设备标识、二维码包含 Multiaddr 列表、完全替代 mDNS 首次配对等核心特性。

## Goals / Non-Goals

**Goals:**
- 充分利用桌面端大屏幕空间，优化布局和交互
- 实现二维码上传功能，适应桌面端无摄像头的特性
- 添加内联设备名称编辑，提升桌面端用户体验
- 实现基于 libp2p PeerId 的统一设备标识系统
- 支持多网络协议和多地址的连接机制
- 提供安全的设备配对流程（二维码 + 6位验证码）

**Non-Goals:**
- 不支持移动端的摄像头扫描功能
- 不改变现有的同步引擎核心逻辑
- 不移除 mDNS 用于已配对设备的地址发现

## Decisions

### 1. 桌面端优先的大屏布局
**决策**: 采用桌面端专用的大屏幕布局设计
**理由**: 
- 桌面端屏幕空间充足，可以显示更多信息
- 鼠标交互支持更精细的操作（如内联编辑）
- 可以同时展示更多操作按钮和状态信息

### 2. 二维码上传替代扫描
**决策**: 桌面端支持二维码图片文件上传
**理由**:
- 桌面设备通常没有或摄像头位置不便
- 用户可以通过截图、文件传输等方式获取二维码图片
- 技术实现简单，无需处理摄像头权限
- 符合桌面端的交互习惯

### 3. libp2p PeerId 作为设备标识
**决策**: 直接使用 libp2p PeerId 作为设备唯一标识
**理由**:
- 避免维护两套 ID 系统（设备 ID + 网络 ID）
- PeerId 基于公钥，天然唯一且安全
- 网络层和应用层使用统一标识
- 简化代码逻辑和数据模型

### 4. Multiaddr 列表支持
**决策**: 二维码包含设备的所有 Multiaddr 地址
**理由**:
- 支持多种网络协议（TCP、QUIC 等）
- 支持多个网络接口（WiFi、以太网等）
- 提高连接成功率（尝试多个地址）
- 符合 libp2p 的多地址设计理念

### 5. 完全替代 mDNS 首次配对
**决策**: 移除 mDNS 用于首次配对，改用二维码 + 验证码
**理由**:
- 安全性：mDNS 广播无法验证设备身份
- 用户控制：二维码配对需要用户主动操作
- 隐私保护：不在局域网广播设备信息
- 跨网络支持：二维码可以跨子网配对

## Risks / Trade-offs

### 安全风险: 二维码文件泄露
**风险**: 二维码图片文件可能被恶意获取
**缓解**:
- 二维码包含时间戳，设置 10 分钟有效期
- 验证码提供二次安全保障
- 配对过程需要用户主动确认

### 复杂性风险: libp2p 集成
**风险**: libp2p 集成增加系统复杂性
**缓解**:
- 提供清晰的 FFI 接口层
- 实现完整的错误处理和恢复机制
- 添加详细的文档和测试覆盖

### 兼容性风险: 多平台支持
**风险**: 不同桌面平台的文件系统和权限差异
**缓解**:
- 使用标准的 ApplicationSupportDirectory
- 平台特定的权限处理
- 完整的多平台测试覆盖

### 性能风险: 大量设备列表
**风险**: 设备列表可能很大，影响渲染性能
**缓解**:
- 使用虚拟滚动和懒加载
- 实现设备列表缓存机制
- 优化排序和过滤算法

## Migration Plan

### Phase 1: Rust 端基础设施
1. 实现 libp2p 密钥对管理和存储
2. 创建信任列表 SQLite 表和接口
3. 添加 FFI 接口获取 PeerId 和设备信息
4. 实现配对验证码生成和验证逻辑

### Phase 2: 桌面端 UI 基础
1. 创建桌面端专用的 DeviceManagerPage 布局
2. 实现 CurrentDeviceCard 组件和内联编辑
3. 添加设备列表和状态显示
4. 实现空状态和未加入池状态

### Phase 3: 二维码功能
1. 实现二维码生成（包含 PeerId + Multiaddrs）
2. 添加二维码文件上传和解析功能
3. 实现拖拽上传支持
4. 添加二维码图片预览和验证

### Phase 4: 配对流程集成
1. 集成 Rust 端配对逻辑
2. 实现验证码显示和输入对话框
3. 添加配对成功/失败的反馈机制
4. 完善错误处理和边界情况

## Open Questions

1. **文件格式**: 二维码图片支持哪些格式（PNG、JPG、SVG）？
2. **文件大小**: 二维码图片文件大小限制是多少？
3. **地址优先级**: Multiaddr 列表的连接尝试顺序如何确定？
4. **密钥迁移**: 现有设备如何迁移到新的 PeerId 系统？
5. **离线发现**: 完全离线环境下如何进行设备发现？