## Context

CardMind 已经实现了 P2P 同步引擎的基础架构，但缺少移动端用户友好的设备管理界面。React UI 参考实现提供了完整的设备管理设计，我们需要将其适配到 Flutter 移动端，并遵循项目的平台特定设计原则。

原始设计文档详细定义了移动端设备管理的完整功能需求，包括安全的二维码配对、6 位验证码验证、设备状态显示和相机权限处理等核心特性。

## Goals / Non-Goals

**Goals:**
- 实现移动端专用的设备管理页面，优化触摸交互
- 提供安全的二维码设备配对流程（6 位验证码）
- 显示直观的设备状态和在线信息
- 支持设备名称编辑和设备列表管理
- 处理相机权限和各种错误场景
- 确保良好的性能表现和可访问性

**Non-Goals:**
- 不修改核心 P2P 同步逻辑
- 不支持桌面端（仅移动端）
- 不改变现有的设备发现机制

## Decisions

### 1. 移动端优先的触控设计
**决策**: 采用移动端专用的触控优化设计
**理由**: 
- 移动端触控交互与桌面端鼠标交互差异很大
- 需要考虑触摸目标大小、手势识别和键盘适配
- 遵循 Material Design 和 iOS Human Interface Guidelines

### 2. 二维码 + 验证码的安全配对机制
**决策**: 使用二维码扫描 + 6 位数字验证码的双重验证
**理由**:
- 二维码提供便捷的设备识别
- 6 位验证码确保配对过程的安全性
- 符合用户常见的安全验证模式
- 防止意外或恶意的设备配对

### 3. 标签页式配对界面
**决策**: 使用标签页切换"显示二维码"和"扫描二维码"
**理由**:
- 在同一对话框中提供完整的配对功能
- 减少界面层级和用户认知负担
- 符合移动端常见的标签页交互模式
- 节省屏幕空间

### 4. 状态优先的设备排序
**决策**: 在线设备优先 + 最后在线时间倒序
**理由**:
- 用户更关心当前可用的在线设备
- 便于快速识别和操作活跃设备
- 符合用户的直觉预期

### 5. 分层状态管理架构
**决策**: 使用 Riverpod 进行多层状态管理
**理由**:
- 提供响应式的状态更新机制
- 分离页面状态、设备列表和配对状态
- 支持实时更新和缓存优化
- 与 Flutter 生态系统良好集成

## Risks / Trade-offs

### 性能风险: 相机资源占用
**风险**: 相机扫描可能消耗大量电池和内存
**缓解**: 
- 仅在扫描标签页激活时初始化相机
- 使用较低分辨率（720p）减少资源占用
- 及时释放相机资源

### 安全风险: 二维码信息泄露
**风险**: 二维码可能被恶意扫描
**缓解**:
- 二维码包含时间戳，设置 10 分钟有效期
- 验证码提供二次安全保障
- 配对过程需要用户主动确认

### 用户体验风险: 权限被拒绝
**风险**: 用户拒绝相机权限导致功能不可用
**缓解**:
- 提供清晰的权限说明和引导
- 优雅处理权限被拒绝的情况
- 提供"去设置"快捷入口

### 复杂性风险: 状态管理过于复杂
**风险**: 配对流程涉及多个状态，难以维护
**缓解**:
- 使用清晰的状态枚举和转换规则
- 实现完整的状态验证和错误处理
- 提供详细的测试覆盖

## Migration Plan

### Phase 1: 数据模型和状态管理
1. 创建 Device、PairingRequest 等数据模型
2. 实现设备列表和配对状态管理
3. 添加单元测试覆盖（8 个测试）

### Phase 2: 核心 UI 组件
1. 实现 DeviceManagerPage 主页面
2. 创建 CurrentDeviceCard 和 DeviceListItem 组件
3. 实现编辑设备名称对话框

### Phase 3: 配对功能
1. 实现二维码生成和显示
2. 添加二维码扫描功能
3. 实现 6 位验证码输入和验证流程

### Phase 4: 集成和优化
1. 集成相机权限处理
2. 添加错误边界和异常处理
3. 实现性能优化和可访问性
4. 完善 Widget 测试（45 个测试）

## Open Questions

1. **相机性能**: 二维码扫描在不同设备上的性能表现如何？
2. **权限策略**: 如何优雅处理权限被永久拒绝的情况？
3. **网络适配**: 弱网络环境下配对流程的容错机制？
4. **离线配对**: 是否支持局域网离线环境下的设备配对？
5. **多语言**: 验证码和错误信息的多语言本地化策略？