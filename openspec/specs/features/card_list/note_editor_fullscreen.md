---
version: 2.0.0
status: draft
platform: mobile
---

# 移动端全屏笔记编辑器规格

## 元数据

- **功能名称**: 移动端全屏笔记编辑器 (NoteEditorFullscreen)
- **版本**: 2.0.0
- **状态**: 草稿
- **平台**: 移动端 (iOS/Android)
- **依赖**: Card 数据模型 (`rust/src/models/card.rs`)
- **参考**: `react_ui_reference/src/app/components/note-editor-fullscreen.tsx`

## 业务逻辑

### 核心功能

移动端全屏笔记编辑器提供沉浸式的笔记编辑体验，支持两种模式：

1. **新建模式** (card = null)
   - 创建新笔记
   - 标题和内容初始为空
   - 内容为空时可以直接关闭

2. **编辑模式** (card ≠ null)
   - 编辑现有笔记
   - 加载现有标题和内容
   - 内容不能为空

### 数据模型

```dart
// 复用现有的 Card 模型
import 'package:cardmind/bridge/models/card.dart';

class NoteEditorFullscreen extends StatefulWidget {
  final Card? card;              // null = 新建，非 null = 编辑
  final String currentDevice;    // 当前设备标识
  final bool isOpen;             // 是否打开
  final OnClose onClose;         // 关闭回调
  final OnSave onSave;           // 保存回调
}

typedef OnClose = void Function();
typedef OnSave = void Function(Card card);
```

### 保存机制

#### 自动保存
- **触发条件**: 标题或内容发生变化
- **防抖时间**: 1 秒
- **执行逻辑**:
  1. 取消之前的定时器
  2. 设置新定时器（1 秒）
  3. 1 秒后检查内容是否为空
  4. 如果内容不为空，调用 onSave 回调

#### 手动保存（完成按钮）
- **触发条件**: 用户点击"完成"按钮
- **执行逻辑**:
  1. 取消自动保存定时器
  2. 验证内容是否为空
  3. 如果内容为空，显示 Toast 提示
  4. 如果内容不为空：
     - 处理标题（空标题 → "无标题笔记"）
     - 调用 onSave 回调
     - 调用 onClose 回调

### 数据验证

#### 标题验证
- **空标题处理**: trim 后为空时，自动填充"无标题笔记"
- **长度限制**: 无限制，UI 自动换行

#### 内容验证
- **空内容定义**: trim 后为空字符串
- **新建模式**: 内容为空时可以关闭，不创建笔记
- **编辑模式**: 内容为空时不允许保存，显示错误提示

### 未保存更改检测

**检测条件**:
- 当前标题 ≠ 原始标题，或
- 当前内容 ≠ 原始内容，或
- 自动保存定时器正在运行（防抖期间）

**应用场景**:
- 点击关闭按钮时，决定是否显示确认对话框

## 交互逻辑

### 打开编辑器

**触发条件**: isOpen = true

**前置条件**: 无

**执行流程**:
1. 检查 card 参数
2. 如果 card ≠ null（编辑模式）：
   - 加载 card.title 到标题输入框
   - 加载 card.content 到内容输入框
   - 保存原始值（用于检测更改）
3. 如果 card = null（新建模式）：
   - 标题和内容为空
4. 显示编辑器（全屏滑入动画）

**后置条件**: 编辑器全屏显示

**动画**: 从底部滑入，时长 300ms

### 关闭编辑器

**触发条件**: 用户点击"×"按钮或按返回键

**前置条件**: 编辑器已打开

**执行流程**:
1. 检查是否有未保存的更改
2. 如果没有未保存的更改：
   - 调用 onClose 回调
   - 关闭编辑器（滑出动画）
3. 如果有未保存的更改：
   - 显示确认对话框
   - 等待用户选择

**后置条件**: 编辑器关闭或显示确认对话框

**动画**: 向底部滑出，时长 300ms

### 确认对话框

**触发条件**: 关闭编辑器时有未保存的更改

**对话框内容**:
- 标题: "有未保存的更改"
- 内容: "是否保存更改？"
- 按钮:
  - "保存并关闭"（主要按钮）
  - "放弃更改"（危险按钮）
  - "取消"（次要按钮）

**选项 1: 保存并关闭**
- 验证内容是否为空
- 如果内容为空，显示 Toast 提示，保持对话框打开
- 如果内容不为空，保存并关闭

**选项 2: 放弃更改**
- 直接关闭编辑器
- 不保存任何更改

**选项 3: 取消**
- 关闭对话框
- 返回编辑器继续编辑

### 自动保存

**触发条件**: 标题或内容输入框内容变化

**前置条件**: 编辑器已打开

**执行流程**:
1. 取消之前的自动保存定时器
2. 设置新的定时器（1 秒延迟）
3. 标记为有未保存的更改
4. 1 秒后执行保存：
   - 检查内容是否为空（trim）
   - 如果内容为空，不保存
   - 如果内容不为空：
     - 处理标题（空标题 → "无标题笔记"）
     - 调用 onSave 回调
     - 更新原始值
     - 清除未保存更改标记

**后置条件**: 数据已保存或等待保存

**防抖时间**: 1 秒

### 完成按钮

**触发条件**: 用户点击"完成"按钮

**前置条件**: 编辑器已打开

**执行流程**:
1. 取消自动保存定时器
2. 验证内容是否为空（trim）
3. 如果内容为空：
   - 显示 Toast 提示"内容不能为空"
   - 保持在编辑器中
   - 结束流程
4. 如果内容不为空：
   - 处理标题（空标题 → "无标题笔记"）
   - 调用 onSave 回调
   - 调用 onClose 回调
   - 关闭编辑器

**后置条件**: 数据已保存并关闭，或显示错误提示

## 边界与约束

### 数据边界

| 场景 | 约束 | 处理方式 |
|------|------|----------|
| 标题为空 | 允许 | 保存时自动填充"无标题笔记" |
| 内容为空（新建模式） | 允许 | 不创建笔记，直接关闭 |
| 内容为空（编辑模式） | 不允许 | 显示 Toast 提示"内容不能为空" |
| 标题超长 | 允许 | UI 自动换行显示 |
| 内容超长 | 允许 | 滚动显示 |
| card 为 null | 允许 | 新建模式 |
| card 不为 null | 允许 | 编辑模式 |
| currentDevice 为空 | 不允许 | 必须提供设备标识 |

### 交互边界

| 场景 | 约束 | 处理方式 |
|------|------|----------|
| 快速连续点击完成按钮 | 允许 | 防抖处理，只执行一次保存 |
| 自动保存期间点击完成 | 允许 | 取消自动保存，立即保存 |
| 自动保存期间点击关闭 | 允许 | 视为有未保存更改，显示确认对话框 |
| 确认对话框打开时点击外部 | 允许 | 关闭对话框，返回编辑器 |
| 编辑器打开时按返回键 | 允许 | 触发关闭按钮逻辑 |
| 新建模式空内容关闭 | 允许 | 直接关闭，不显示确认对话框 |
| 编辑模式空内容关闭 | 允许 | 显示确认对话框 |

### 性能约束

- 自动保存频率: 最多每秒 1 次（1 秒防抖）
- 输入响应时间: < 16ms
- 打开/关闭动画: 60fps，时长 300ms
- Toast 提示持续时间: 2 秒

## 组件接口

### NoteEditorFullscreen 组件

```dart
class NoteEditorFullscreen extends StatefulWidget {
  /// 笔记数据（null = 新建模式，非 null = 编辑模式）
  final Card? card;
  
  /// 当前设备标识
  final String currentDevice;
  
  /// 是否打开编辑器
  final bool isOpen;
  
  /// 关闭回调
  final OnClose onClose;
  
  /// 保存回调
  final OnSave onSave;

  const NoteEditorFullscreen({
    this.card,
    required this.currentDevice,
    required this.isOpen,
    required this.onClose,
    required this.onSave,
  });
}

typedef OnClose = void Function();
typedef OnSave = void Function(Card card);
```

## 测试用例

### 单元测试（8 个）

**UT-001: 测试初始状态创建（新建模式）**
- **输入**: card = null
- **预期**: title = "", content = "", hasUnsavedChanges = false

**UT-002: 测试初始状态创建（编辑模式）**
- **输入**: card = Card(title: "测试", content: "内容")
- **预期**: title = "测试", content = "内容", hasUnsavedChanges = false

**UT-003: 测试空标题处理**
- **输入**: title = "  ", content = "内容"
- **预期**: 保存时 title = "无标题笔记"

**UT-004: 测试空内容检测（新建模式）**
- **输入**: card = null, content = "  "
- **预期**: 可以关闭，不创建笔记

**UT-005: 测试空内容检测（编辑模式）**
- **输入**: card ≠ null, content = "  "
- **预期**: 不允许保存，显示错误提示

**UT-006: 测试未保存更改检测**
- **输入**: 原始 content = "旧内容", 当前 content = "新内容"
- **预期**: hasUnsavedChanges = true

**UT-007: 测试自动保存防抖**
- **输入**: 连续输入 5 个字符
- **预期**: 只触发 1 次自动保存（最后一次输入后 1 秒）

**UT-008: 测试回调类型定义**
- **输入**: OnSave, OnClose 回调函数
- **预期**: 类型定义正确，可正确调用

### Widget 测试（45 个）

#### 渲染测试（12 个）

**WT-001: 测试基本渲染（新建模式）**
- **输入**: card = null, isOpen = true
- **预期**: 正确渲染编辑器，标题和内容为空

**WT-002: 测试基本渲染（编辑模式）**
- **输入**: card = Card(title: "测试", content: "内容"), isOpen = true
- **预期**: 正确渲染编辑器，显示标题和内容

**WT-003: 测试工具栏渲染**
- **输入**: isOpen = true
- **预期**: 显示关闭按钮、"自动保存"文字、完成按钮

**WT-004: 测试标题输入框**
- **输入**: isOpen = true
- **预期**: 显示占位符"笔记标题"，字体 24px 粗体

**WT-005: 测试内容输入框**
- **输入**: isOpen = true
- **预期**: 显示占位符"开始写笔记..."，最小高度 60vh

**WT-006: 测试元数据渲染（编辑模式）**
- **输入**: card = Card(createdAt: 1234567890, updatedAt: 1234567900, lastEditDevice: "iPhone")
- **预期**: 显示创建时间、更新时间、最后编辑设备

**WT-007: 测试元数据渲染（新建模式）**
- **输入**: card = null
- **预期**: 不显示元数据区域

**WT-008: 测试工具栏高度**
- **输入**: SafeArea.top = 44
- **预期**: 工具栏高度 = 56 + 44 = 100px

**WT-009: 测试背景模糊效果**
- **输入**: isOpen = true
- **预期**: 工具栏背景有模糊效果

**WT-010: 测试全屏布局**
- **输入**: isOpen = true
- **预期**: 编辑器占据整个屏幕

**WT-011: 测试关闭状态**
- **输入**: isOpen = false
- **预期**: 不渲染编辑器

**WT-012: 测试时间格式**
- **输入**: createdAt = 1737878400000 (2026/1/26 14:00:00)
- **预期**: 显示 "2026/1/26 14:00:00"

#### 交互测试（20 个）

**WT-013: 测试输入标题**
- **操作**: 在标题输入框输入"测试标题"
- **预期**: 标题更新为"测试标题"

**WT-014: 测试输入内容**
- **操作**: 在内容输入框输入"测试内容"
- **预期**: 内容更新为"测试内容"

**WT-015: 测试点击完成按钮（有效内容）**
- **输入**: title = "标题", content = "内容"
- **操作**: 点击完成按钮
- **预期**: onSave 被调用，onClose 被调用

**WT-016: 测试点击完成按钮（空内容）**
- **输入**: title = "标题", content = ""
- **操作**: 点击完成按钮
- **预期**: 显示 Toast "内容不能为空"，不关闭编辑器

**WT-017: 测试点击关闭按钮（无更改）**
- **输入**: 无更改
- **操作**: 点击关闭按钮
- **预期**: onClose 被调用，不显示确认对话框

**WT-018: 测试点击关闭按钮（有更改）**
- **输入**: 修改了内容
- **操作**: 点击关闭按钮
- **预期**: 显示确认对话框

**WT-019: 测试确认对话框 - 保存并关闭**
- **输入**: 有未保存更改
- **操作**: 点击关闭按钮 → 选择"保存并关闭"
- **预期**: onSave 被调用，onClose 被调用

**WT-020: 测试确认对话框 - 放弃更改**
- **输入**: 有未保存更改
- **操作**: 点击关闭按钮 → 选择"放弃更改"
- **预期**: onClose 被调用，onSave 不被调用

**WT-021: 测试确认对话框 - 取消**
- **输入**: 有未保存更改
- **操作**: 点击关闭按钮 → 选择"取消"
- **预期**: 对话框关闭，返回编辑器

**WT-022: 测试自动保存触发**
- **操作**: 输入内容，等待 1 秒
- **预期**: onSave 被调用

**WT-023: 测试自动保存防抖**
- **操作**: 连续输入，间隔 < 1 秒
- **预期**: 只在最后一次输入后 1 秒触发保存

**WT-024: 测试完成按钮取消自动保存**
- **操作**: 输入内容，立即点击完成按钮
- **预期**: 立即保存，不等待 1 秒

**WT-025: 测试空标题自动填充**
- **输入**: title = "", content = "内容"
- **操作**: 点击完成按钮
- **预期**: 保存的 title = "无标题笔记"

**WT-026: 测试新建模式空内容关闭**
- **输入**: card = null, content = ""
- **操作**: 点击关闭按钮
- **预期**: 直接关闭，不显示确认对话框

**WT-027: 测试编辑模式空内容关闭**
- **输入**: card ≠ null, 删除所有内容
- **操作**: 点击关闭按钮
- **预期**: 显示确认对话框

**WT-028: 测试快速连续点击完成按钮**
- **操作**: 快速点击完成按钮 3 次
- **预期**: onSave 只被调用 1 次

**WT-029: 测试打开动画**
- **操作**: 设置 isOpen = true
- **预期**: 编辑器从底部滑入，时长 300ms

**WT-030: 测试关闭动画**
- **操作**: 点击关闭按钮（无更改）
- **预期**: 编辑器向底部滑出，时长 300ms

**WT-031: 测试返回键行为**
- **操作**: 按返回键
- **预期**: 触发关闭按钮逻辑

**WT-032: 测试确认对话框外部点击**
- **操作**: 显示确认对话框，点击外部
- **预期**: 对话框关闭，返回编辑器

#### 边界测试（13 个）

**WT-033: 测试超长标题**
- **输入**: title = "A" * 1000
- **预期**: 正常显示，自动换行

**WT-034: 测试超长内容**
- **输入**: content = "A" * 10000
- **预期**: 正常显示，可滚动

**WT-035: 测试标题只有空格**
- **输入**: title = "   ", content = "内容"
- **预期**: 保存时 title = "无标题笔记"

**WT-036: 测试内容只有空格（新建模式）**
- **输入**: card = null, content = "   "
- **预期**: 可以关闭，不创建笔记

**WT-037: 测试内容只有空格（编辑模式）**
- **输入**: card ≠ null, content = "   "
- **预期**: 点击完成显示 Toast 提示

**WT-038: 测试内容只有换行符**
- **输入**: content = "\n\n\n"
- **预期**: 视为空内容

**WT-039: 测试 card 为 null**
- **输入**: card = null
- **预期**: 新建模式，标题和内容为空

**WT-040: 测试 card 不为 null**
- **输入**: card = Card(...)
- **预期**: 编辑模式，加载现有数据

**WT-041: 测试无 SafeArea**
- **输入**: SafeArea.top = 0
- **预期**: 工具栏高度 = 56px

**WT-042: 测试有 SafeArea**
- **输入**: SafeArea.top = 44
- **预期**: 工具栏高度 = 100px

**WT-043: 测试自动保存期间关闭**
- **操作**: 输入内容，立即点击关闭按钮（< 1 秒）
- **预期**: 显示确认对话框

**WT-044: 测试确认对话框保存空内容**
- **输入**: 删除所有内容
- **操作**: 点击关闭 → 选择"保存并关闭"
- **预期**: 显示 Toast 提示，不关闭对话框

**WT-045: 测试元数据缺失字段**
- **输入**: card.lastEditDevice = null
- **预期**: 不显示"最后编辑设备"行

## 实现建议

### 性能优化

- 使用 `TextEditingController` 管理输入框状态
- 自动保存使用 `Timer` 实现防抖
- 避免不必要的 Widget 重建
- 使用 `const` 构造函数

### 状态管理

- 使用 `StatefulWidget` 管理编辑器状态
- 监听输入框变化，触发自动保存
- 维护原始值用于检测更改

### 数据验证

- 保存前 trim 标题和内容
- 空标题自动填充"无标题笔记"
- 空内容不允许保存（编辑模式）
- 新建模式空内容可以关闭

### 用户体验

- 全屏沉浸式编辑体验
- 自动保存减少数据丢失风险
- 确认对话框防止误操作
- Toast 提示清晰的错误信息
- 流畅的打开/关闭动画

## 参考资料

- React UI 参考: `react_ui_reference/src/app/components/note-editor-fullscreen.tsx`
- 设计文档: `docs/plans/2026-01-25-note-editor-fullscreen-ui-design.md`
- 数据模型: `rust/src/models/card.rs`
- Flutter TextField: https://api.flutter.dev/flutter/material/TextField-class.html
- Material Design 文本输入: https://m3.material.io/components/text-fields/overview
