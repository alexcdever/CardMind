# CardMind 可用化一体设计（读写分离 + 全功能 UI，2026-02-28）

## 1. 目标与范围
- 目标：让 App 达到“可日常使用”的完整状态，覆盖移动端与桌面端主路径。
- 约束：保持离线优先；同步异常不阻断本地卡片与池元数据写入。
- 范围（S1~S5 对齐并补齐落地）：
  - S1 引导分流：先本地使用 / 创建或加入池。
  - S2 卡片 CRUD：新增、检索、编辑、删除、恢复、保存反馈。
  - S3 池生命周期：创建池、加入池、审批、编辑池信息、成员退出、所有者解散池。
  - S4 跨页可达：设置页可一步切回卡片页与池页。
  - S5 全局同步异常：可见、可处理、不阻断本地编辑。

## 2. 核心架构（读写分离）

### 2.1 写模型（Source of Truth）
- 使用 Loro 文档作为数据真源：
  - 卡片数据（标题、正文、删除标记、更新时间等）。
  - 池元数据（池信息、成员、审批请求、角色、状态等）。
- 所有业务写入先落 Loro，保证离线写入能力与冲突合并能力。

### 2.2 读模型（查询优化）
- 使用 SQLite 作为查询侧读模型，不作为真源。
- Loro 变更通过订阅机制触发投影更新 SQLite：
  - Loro 变更事件 -> Projection Worker -> SQLite 增量更新。
- UI 列表/筛选/搜索/统计统一读 SQLite，避免在 Loro 上做复杂查询。

### 2.3 同步模型
- Flutter 通过 FRB 调用 Rust/iroh 同步能力。
- 网络同步成功后回写 Loro；Loro 再驱动 SQLite 投影更新。
- 形成单向一致链路：`User Action -> Loro -> SQLite Projection -> UI Query`，
  同步链路并行：`Loro <-> FRB/Rust/iroh`。

## 3. UI 信息架构与导航接线
- 移动端：底部 3 Tab（卡片 / 池 / 设置）。
- 桌面端：左导航 + 中列表 + 右详情/编辑的三栏模式。
- 导航壳为主入口，不再仅以 Onboarding 单页承载主流转。
- 引导页仅做首次分流；进入主壳后三域始终可达。

## 4. 领域设计

### 4.1 卡片域
- 写入：新建、编辑保存、删除、恢复都更新 Loro 卡片节点。
- 读取：卡片列表、搜索、过滤（含已删除视图）走 SQLite。
- 编辑反馈：明确“本地已保存”；离开保护提供三分支（保存并离开/放弃更改/取消）。

### 4.2 池域
- 实体：池基础信息、成员、审批请求、成员角色、池状态。
- 生命周期动作：
  - 创建池
  - 加入池（含 7 类错误映射）
  - 管理员审批（通过/拒绝，失败保留并可重试）
  - 编辑池信息（如名称、描述）
  - 成员退出
  - 所有者解散池（含后果确认与失败恢复）
- 读取：成员列表、审批队列、状态看板均走 SQLite 投影表。

### 4.3 设置域
- 展示设备身份、基础配置与排查入口。
- 保证从设置页一键返回卡片域与池域（无中间阻断）。

## 5. 状态流与一致性

### 5.1 启动
- `Booting -> LocalReady -> SyncProbing`。
- `LocalReady` 之后即允许完整本地操作；同步状态异步探测。

### 5.2 数据一致性
- 写入事务完成条件：Loro 写入成功即视为业务成功。
- SQLite 投影失败不回滚 Loro，但会进入“投影异常”可恢复状态并重试。
- 同步失败不影响 Loro 与 SQLite 本地链路，只影响远端一致性状态。

### 5.3 冲突与恢复
- 冲突由 Loro 合并策略吸收；合并结果继续驱动 SQLite 重算/增量更新。
- 对用户暴露“已本地保存 + 同步待恢复”组合反馈。

## 6. 错误处理与可观测反馈
- 加入池错误码统一映射“发生了什么 + 下一步动作 + 立即按钮”。
- 同步异常分级：
  - 弱提示：连接中/退化态。
  - 高亮提示：失败态，含 `retry` / `reconnect` / `view`。
- 池退出/解散失败进入可恢复状态（如部分清理失败 + 重试清理）。

## 7. 测试与门禁
- 交互入口必须有行为测试（按钮、列表项、菜单、快捷键、手势）。
- 核心路径必须覆盖成功 + 失败：
  - 卡片 CRUD 成功与恢复路径。
  - 池生命周期成功与失败（至少一条错误码分支）。
- 强制守卫：禁止空交互与无说明禁用交互。
- 必跑门禁：
  - `flutter analyze`
  - `flutter test`
  - `flutter test test/ui_interaction_governance_docs_test.dart`
  - `flutter test test/interaction_guard_test.dart`
  - `dart run tool/fractal_doc_check.dart --base <commit>`

## 8. 实施切片建议
1. 先接通主壳导航与页面可达（移动/桌面统一语义）。
2. 落卡片域写入与读模型投影，完成 CRUD 闭环。
3. 落池域全生命周期与错误恢复。
4. 接 FRB 同步与全局异常反馈。
5. 完成治理文档、测试矩阵与门禁全绿。

## 9. 不做项（本阶段）
- 不引入账号登录体系（使用设备身份 + 池内角色）。
- 不做多池并行视图。
- 不做高级权限系统与复杂诊断面板。
