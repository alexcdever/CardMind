# CardMind 全仓 rs/dart 文件头真实性清查设计（2026-02-28）

## 1. 目标与边界
- 目标：清查并修正全仓所有带文件头的 `.rs` 与 `.dart` 文件，消除复制粘贴式模板描述，确保文件头与文件真实职责一致。
- 范围：仅处理可维护源码中的“已有文件头”文件；自动生成文件不处理，且自动生成文件不应存在文件头信息。
- 非目标：不修改业务逻辑、不调整 API 行为、不升级文件头格式规范。

## 2. 约束与格式
- 文件头格式保持现状：三行键名固定为 `input`、`output`、`pos`。
- 继续保留治理约束语：修改本文件需同步更新文件头与所属 `DIR.md`。
- 本次仅做语义真实性修正，不引入新增字段或格式变更。

## 3. 执行方案（选型：方案 B）
- 采用“逐文件深读后逐个改写”的高准确率策略。
- 单文件闭环流程：`阅读文件 -> 提炼真实 input/output/pos -> 仅改文件头三行 -> 自检`。
- 处理顺序：`rust/src` -> `rust/tests` -> `lib` -> `test` -> 其余带文件头 `.rs/.dart` 文件。
- 质量优先于速度，不做批量模板替换。

## 4. 字段判定规则

### 4.1 input
- 写真实上游输入来源：函数参数、调用方传入、外部依赖返回、测试夹具构造数据。
- 禁止使用无证据泛化表述（如“用户操作”“外部参数”）作为统一模板。

### 4.2 output
- 写可观察输出：返回值、状态变更、持久化写入、网络发送、错误分支/异常暴露。
- 测试文件应体现“断言验证的行为输出”，而非实现细节复述。

### 4.3 pos
- 用一句话明确该文件职责边界与模块定位。
- 禁止目录级套话（如“通用模块”“负责读写”）在多个文件重复复用。

## 5. 异常与例外处理
- 职责混合文件：在 `pos` 明确其“协调/聚合”角色，不强行单一职责叙述。
- 语义不确定文件：进入“二次确认清单”，不凭猜测落注释。
- 自动生成文件：不纳入本次修正；若发现存在文件头，记录为治理异常项供后续清理。

## 6. 验收与交付
- 验收标准：文件头需满足“可区分、可验证、可维护”，且可直接映射当前文件真实职责。
- 质量检查：目录级抽样复读，确认无模板化残留、无跨文件同质描述。
- 规范校验：运行 `dart run tool/fractal_doc_check.dart --base <commit>`。
- 治理回归：运行 `flutter test test/ui_interaction_governance_docs_test.dart`。
- 交付物：
  - 已修复文件清单
  - 自动生成文件例外清单
  - 二次确认文件清单（如有）

## 7. 完成定义
- 全仓可维护 `.rs/.dart` 中“已有文件头”的文件均完成逐文件语义修正。
- 不存在可被任意文件复用的空泛模板句。
- 文档治理与交互治理相关校验通过。
