# 功能规格重构设计（features → card/pool/settings）

**目标**: 将 `docs/specs/features/` 重构为纯业务功能层，按 `card/`、`pool/`、`settings/` 三模块组织；功能规格只依赖领域与架构规格，**不得引用 UI 规格**；UI 规格继续归档在 `docs/specs/ui/`。

## 背景
当前 `features/` 中包含大量 UI/平台描述，导致功能层边界模糊，Flutter 与 Rust 的对接不再以业务规格为准。需要以“业务能力”为中心重构功能规格，使其对齐领域模型与架构设计。

## 设计原则
- **功能层纯业务**: 仅描述业务能力、约束、异常与结果，不出现平台/组件/交互控件/布局术语。
- **依赖清晰**: 只可引用 `docs/specs/domain/` 与 `docs/specs/architecture/`。
- **表达一致**: 使用 GIVEN-WHEN-THEN 场景描述。
- **层次隔离**: UI 规格只描述呈现与交互，不包含业务规则。
- **可验证**: 相关测试映射明确（Flutter/Rust）。

## 目录结构（目标态）
```
docs/specs/features/
├── card/
├── pool/
└── settings/
```

## 功能清单（最终版）

### features/card/
- 卡片创建：标题必填、内容可空、未加入池则拒绝创建。
- 卡片查看：标题/内容/创建与修改时间/标签/最后编辑设备/同步状态。
- 卡片编辑：修改标题与内容，更新修改时间与设备，变更需同步。
- 标签管理：新增/移除、禁止重复、区分大小写、变更需同步。
- 卡片删除：确认后软删除，可查询已删除记录，删除需同步。
- 卡片列表/搜索与过滤：搜索条件为空时返回所有 `deleted=false` 卡片；有搜索条件时叠加过滤；默认按 `updated_at` 倒序（从新到旧）；分页/加载交由 UI 规格定义。

### features/pool/
- 创建池：名称必填、密钥≥6、UUID v7、bcrypt 哈希、创建后自动加入并触发同步。
- 加入池：池 ID + 密钥校验、池存在性校验、单池约束。
- 单池约束：同设备仅一个池，已加入时拒绝创建/加入。
- 查看池信息：名称/ID/创建时间/设备数/卡片数。
- 成员管理：设备列表、在线状态、当前设备标记、成员增删。
- 池设置修改：更新名称、更新密钥（需验证旧密钥）、变更需同步。
- 离开池：确认后移除关系；仅清理本地属于该池的数据（卡片/池/同步元数据），本地独立数据保留；清除设备配置池 ID。
- 组池与发现：不对外暴露；仅二维码组池；同局域网；加入后设备在局域网内监听并广播 mDNS 以互相发现。
- 认证与安全：池 ID + 池密钥；libp2p 公私钥对白名单验证。
- 数据传输/同步：加入池即启动；支持增量/全量；版本追踪；冲突自动合并；失败可重试。

### features/settings/
- 设备名称管理：查看设备名称/ID/类型；修改名称并持久化；名称必填；变更同步。
- 外观设置：主题模式（浅/深/跟随系统）、文本大小；即时生效并持久化。
- 数据管理：查看存储占用；清除缓存（不清用户数据）；数据导入/导出（JSON）。
- 应用信息：版本/构建号/发布日期；开源库清单（区分 Flutter 与 Rust）。
- 设置结构：外观/设备/数据/关于分组。

## 拆分规则
1. 功能规格仅描述业务能力与约束，不含平台/组件/交互控件/布局术语。
2. 只能引用 `domain/` 与 `architecture/`，禁止引用 `ui/`。
3. 规格以用户旅程/业务动作表达（创建、查询、修改、删除、加入、离开等）。
4. 若现有文档混杂 UI，实现必须拆分为业务规格与 UI 规格。
5. UI 规格不得写业务规则，仅描述呈现与交互。

## 迁移流程
1. 新建 `docs/specs/features/card|pool|settings/` 与各模块 `README.md`。
2. 审阅旧 `features/` 目录，按拆分规则迁移业务内容到新模块。
3. UI 内容迁入 `docs/specs/ui/` 的对应目录。
4. **清理旧 `docs/specs/features/` 目录（不保留旧文件、不做指向）。**
5. 更新 `docs/specs/README.md` 的功能索引与统计。

## 验证方式
- 新目录结构与清单一致。
- 功能规格仅引用 domain/architecture，未引用 UI。
- 每份功能规格包含元数据（状态/依赖/相关测试）与场景描述。
- 索引更新正确，旧目录已清理。
