# 数据池组网与同步设计（2026-02-26）

## 目标
- 实现数据池组网与同步（iroh + discovery）
- 同步对象：池元数据 + 卡片数据（Loro）
- 全成员互联拓扑，应用前景运行时常驻同步
- 不使用 `pool_key`，加入依赖管理员审批 + `members` 白名单

## 非目标
- 不做多池并行
- 不做高级加密与复杂权限体系
- 不做后台常驻与系统级推送
- 不做跨池共享或外部导出

## 背景与约束
- 数据源：Loro 文档为真相源，SQLite 为查询缓存
- 身份：iroh `EndpointId` 作为成员唯一标识
- 发现：先本地发现，失败再公网发现（iroh 内置机制）
- 连接：全成员互联，不设置中心节点

## 架构概览
- 连接与发现层：iroh 负责发现与直连
- 会话管理：每个数据池一个会话管理器，维护对 `members` 的连接与心跳
- 同步协调器：负责全量/增量同步编排与补漏
- 协议与消息：控制面（加入/审批/转发）与数据面（池元数据/卡片同步）
- 数据层：Loro 快照与增量变更的导入/导出

## 协议与消息（概要）
- 连接握手：交换 `pool_id` 与 `endpoint_id`，校验白名单
- 加入请求：申请方 → 扫码者 → 管理员转发
- 审批结果：管理员 → 申请方（批准/拒绝/原因）
- 池元数据同步：快照或增量
- 卡片同步：按 `card_ids` 拉取缺失快照 + 增量变更广播
- 心跳：维持连接状态与重连触发

## 关键流程
### 加入与审批
1. 成员生成二维码：包含 `pool_id` + 管理员 `endpoint_id`
2. 申请方扫码后发送加入请求给扫码者
3. 扫码者转发给在线管理员；无在线管理员返回 `ADMIN_OFFLINE`
4. 管理员审批通过：将申请方 `endpoint_id` 写入 `members`
5. 管理员通知申请方加入成功

### 首次同步（加入后）
1. 申请方拉取池元数据 Loro 快照（members、card_ids）
2. 按 `card_ids` 拉取缺失卡片 Loro 快照
3. 建立与其他成员连接，进入常驻增量同步

### 增量同步
- Loro 变更产生后广播增量变更
- 断线重连后触发补漏：先池元数据，再补齐缺失卡片

### 成员移除
- 仅管理员可移除成员
- 移除后广播成员变更
- 被移除节点断开连接并清理本地池数据（Loro + SQLite）

## 安全与校验
- 不使用 `pool_key`
- 仅允许 `members` 白名单内的 `endpoint_id` 建立会话与同步
- 任何同步消息均需在握手校验通过后处理

## 错误码（核心）
- `ADMIN_OFFLINE`
- `REQUEST_TIMEOUT`
- `REJECTED_BY_ADMIN`
- `ALREADY_MEMBER`
- `NOT_MEMBER`

## 测试策略
- 加入流程：审批通过/拒绝/管理员离线
- 白名单校验：非成员同步请求被拒绝
- 同步流程：首次全量 + 增量变更 + 重连补漏
- 成员移除：移除后断连与本地清理

## 风险
- 无 `pool_key`：加入完全依赖管理员审批的安全性与可用性
- 全成员互联：连接数量随成员增长，需注意资源占用与重连风暴
