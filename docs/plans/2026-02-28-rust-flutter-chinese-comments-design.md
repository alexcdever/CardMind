# CardMind Rust/Flutter 中文注释补齐设计（2026-02-28）

## 1. 背景与目标
- 背景：当前仓库 Rust 与 Flutter 代码已具备功能实现，但注释语言与文档一致性不足，影响新成员理解与跨层协作效率。
- 目标：为手写业务代码与测试补齐中文注释，并同步满足 Fractal Documentation Standard（文件头 + 目录说明）要求。
- 非目标：不修改业务逻辑、不重构架构、不改动生成文件与构建产物。

## 2. 范围与边界
### 2.1 范围内
- Rust：`rust/src/**/*.rs`、`rust/tests/**/*.rs`（仅手写文件）。
- Flutter：`lib/**/*.dart`、`test/**/*.dart`（仅手写文件）。
- 文档：受影响目录下 `DIR.md`，以及 `.rs/.dart` 文件头注释。

### 2.2 范围外
- 生成文件：如 `lib/bridge_generated/**`、`rust/src/frb_generated.rs`。
- 构建与依赖产物：`build/`、`rust/target/`、`ios/Pods/` 等标准排除目录。
- 任何功能行为变化（API 语义、状态流、UI 交互逻辑）均不在本次变更范围。

## 3. 方案对比与选型
### 方案 A（选用）
- 做法：按目录分批推进（Rust src -> Rust tests -> Flutter lib/features -> Flutter test），每批执行“文件头 + 关键点中文注释 + DIR.md 同步 + 校验”。
- 优点：风险可控、审查清晰、便于定位回归问题。
- 缺点：整体文件改动量较大。

### 方案 B
- 做法：先统一补齐文件头和 `DIR.md`，第二轮再补函数/模块注释。
- 优点：可快速达成规范基线。
- 缺点：两轮改动导致 diff 分散，审查与回溯成本更高。

### 方案 C
- 做法：仅覆盖核心模块，其他文件最小处理。
- 优点：最快。
- 缺点：与“业务代码 + 测试全覆盖”的目标不一致。

## 4. 注释设计与写法规范
### 4.1 文件头规范
- 每个 `.dart/.rs` 文件补齐或修正三行文件头：`input`、`output`、`pos`。
- 文件头中明确维护约束：修改文件时需同步更新文件头与所属 `DIR.md`。

### 4.2 关键点注释策略
- 仅在以下位置添加中文注释：
  - 模块职责与边界；
  - 核心类型（struct/enum/class/state）语义；
  - 复杂函数（状态迁移、错误映射、边界条件、并发/异步控制）；
  - 测试中“场景意图 + 断言原因”。
- 不做逐行翻译，不给简单 getter/setter 或显而易见流程堆砌注释。

## 5. 架构与数据流说明策略
- Rust 侧重点：`models`、`store`、`net`、`api` 的职责与协作边界。
- Flutter 侧重点：`controller/service/state/page` 的事件与状态关系。
- 跨层调用链说明：`UI -> Controller/Service -> FRB -> Rust API -> Store/Net -> 返回状态/错误`。
- 注释目标是解释“为什么这样设计”，而不是重复“代码做了什么”。

## 6. 错误处理与可维护性
- 错误分支注释需区分：可恢复（重试/重连）与不可恢复（直接失败）。
- 错误映射注释需说明稳定依据（如错误码、上下文来源），避免未来映射漂移。
- 对测试中的失败路径保留最小必要注释，确保问题复现路径可读。

## 7. 执行步骤
1. 建立可改动文件清单，过滤生成文件与排除目录。
2. 先补文件头三行，再补关键点中文注释。
3. 同步更新受影响目录 `DIR.md`。
4. 分批自检并修正文案一致性（术语统一、避免歧义）。
5. 运行门禁与回归测试，确保变更不影响行为。

## 8. 测试与校验门禁
- 文档校验：`dart run tool/fractal_doc_check.dart --base <commit>`。
- 交互治理文档门禁：`flutter test test/ui_interaction_governance_docs_test.dart`。
- 交互守卫门禁：`flutter test test/interaction_guard_test.dart`。
- 回归建议：`flutter analyze`、`flutter test`、`cargo test`。

## 9. 风险与回滚
- 主要风险：批量注释改动导致冲突、漏更 `DIR.md`、术语不一致。
- 控制手段：按目录小批提交、每批执行校验、统一术语表。
- 回滚策略：按目录粒度回退最近一批注释改动，不触碰业务逻辑。

## 10. 验收标准（DoD）
- Rust 与 Flutter 手写业务代码 + 测试文件完成关键点中文注释补齐。
- 所有相关 `.rs/.dart` 文件满足文件头规范。
- 受影响目录 `DIR.md` 与实际文件职责一致。
- 文档与交互治理门禁通过，且无行为回归。
