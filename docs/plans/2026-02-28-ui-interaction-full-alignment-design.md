input: S1-S5 全量对齐目标、治理门禁与交互一致性约束
output: 全量交互对齐设计方案、状态流定义与验收测试策略
pos: UI 交互全量对齐设计文档（修改需同步实施计划与治理文档）
# CardMind UI 交互全量对齐设计（2026-02-28）

## 1. 背景与目标
- 目标：一次性完成 S1~S5 全量对齐，且满足严格门禁通过标准。
- 依据：
  - `docs/plans/2026-02-27-mobile-desktop-ui-interaction-design.md`
  - `docs/plans/2026-02-27-ui-interaction-governance-design.md`
  - `docs/plans/2026-02-27-ui-interaction-acceptance-matrix.md`
  - `docs/plans/2026-02-27-ui-interaction-release-gate.md`
- 全局约束：离线优先，同步异常不阻断本地卡片笔记读写。

## 2. 设计范围与边界
### 2.1 范围内
- S1 引导分流：先本地使用 / 创建或加入池。
- S2 卡片笔记 CRUD：创建、查看/检索、编辑、删除/恢复与保存反馈。
- S3 池相关 CRUD 与流程动作：创建池、加入池、审批、编辑池信息、成员与状态查看、退出池、解散池。
- S4 设置页导航可达性：在设置页可随时通过 Tab 切换到卡片笔记管理页和池管理页。
- S5 全局同步异常：异常可见、可处理、且本地编辑不被阻断。

### 2.2 范围外（YAGNI）
- 多池并行视图。
- 高级权限体系与复杂诊断面板。
- 移动端/桌面端功能分叉。

## 3. 总体架构
- 保持现有三域结构：卡片笔记域、池域、设置与全局反馈域。
- 统一交互模型：`入口控件 -> 业务动作 -> 状态更新 -> 可观察反馈`。
- 统一反馈载体：页面状态文本、对话框、路由跳转、全局 Banner。
- 所有异常都必须落到“可理解文案 + 下一步动作”。

## 4. 场景化交互设计
### 4.1 S1 引导分流
- 引导页仅保留两个主动作，且都必须有真实交互回调。
- 进入主工作区路径不超过 1 步。

### 4.2 S2 卡片笔记 CRUD
- 入口：卡片页（默认落点）。
- 操作：新建、检索、进入编辑、保存、删除/恢复。
- 编辑页行为：
  - 显示“本地已保存”反馈。
  - 有未保存改动时触发离开保护：保存并离开 / 放弃更改 / 取消。
- 同步异常仅作提示和重试入口，不阻断本地编辑与保存。

### 4.3 S3 池相关 CRUD 与流程动作
- 池页三态：未加入 / 已加入 / 异常。
- 关键动作：创建池、扫码加入、审批、退出池。
- 审批行为：成功移除请求项；失败保留请求项并附错误原因，支持重试。
- 退出池行为：失败时进入“部分清理失败”可恢复态，并提供重试清理动作。

### 4.4 S4 设置页导航可达性
- 当用户处于设置页时，可通过 Tab 导航栏随时一键切换到：
  - 卡片笔记管理页
  - 池管理页
- 该切换不依赖额外返回步骤，不引入中间阻断弹层。

### 4.5 S5 全局同步异常
- 异常可见：Banner/提示区稳定显示。
- 异常可处理：提供跳转处理动作（进入池页异常区或对应处理页）。
- 异常不阻断：本地卡片笔记 CRUD 保持可用。

## 5. 状态流与失败恢复
### 5.1 启动流
- `Booting -> LocalReady -> PoolProbing`。
- `LocalReady` 后立即可本地读写；池状态在后台探测。

### 5.2 卡片笔记保存流
- `Editing -> SavingLocal -> SaveSuccess`。
- 同步状态作为并行子状态处理，不影响本地保存结果。

### 5.3 加入池与审批流
- 加入池：`JoinIdle -> JoinRequesting -> JoinSuccess | JoinFailed(code)`。
- 审批：`Pending -> Approving/Rejecting -> Done | Failed`。

### 5.4 退出池流
- `ExitConfirm -> Exiting -> ExitDone | ExitPartialFailed`。
- `ExitPartialFailed` 必须提供可见的恢复动作。

## 6. 错误码映射与动作策略（加入池）
- 统一策略：每个错误码都包含“发生了什么 + 下一步 + 立即动作”。

| 错误码 | 用户文案方向 | 下一步动作 |
| --- | --- | --- |
| `POOL_NOT_FOUND` | 池不存在或来源失效 | 重新获取池信息 |
| `INVALID_POOL_HASH` | 池标识无效 | 重新扫码 |
| `INVALID_KEY_HASH` | 校验失败 | 重新发起加入 |
| `ADMIN_OFFLINE` | 管理员离线 | 稍后重试 |
| `REQUEST_TIMEOUT` | 请求超时 | 立即重试 / 继续本地使用 |
| `REJECTED_BY_ADMIN` | 申请被拒绝 | 重新申请 |
| `ALREADY_MEMBER` | 已是成员 | 前往池详情（切已加入态） |

## 7. 测试设计（按验收矩阵）
### 7.1 S1 测试
- 两入口点击后路由正确。
- 从引导进入主工作区步数不超过 1。

### 7.2 S2 测试（卡片笔记 CRUD）
- 新建、检索、编辑、保存、删除/恢复行为均有可观察断言。
- 离开保护三分支可断言。
- 失败路径可恢复且可重试。

### 7.3 S3 测试（池 CRUD + 流程）
- 创建池、加入池、审批、退出池关键路径覆盖。
- 至少 1 条成功路径 + 1 条错误码失败路径。

### 7.4 S4 测试（设置页 Tab 可达）
- 设置页可访问。
- 在设置页通过 Tab 可一键切到卡片笔记管理页和池管理页。

### 7.5 S5 测试（全局异常）
- 异常提示可见且可跳转处理。
- 同步异常下本地卡片笔记编辑仍可完成。

## 8. 治理与发布门禁
### 8.1 治理硬约束
- 禁止空交互实现：`onPressed: () {}`、`onTap: () {}`。
- 禁止无说明禁用交互：`onPressed: null`。
- 交互变更必须同步治理文档三件套。

### 8.2 必跑命令
- `flutter analyze`
- `flutter test`
- `flutter test test/ui_interaction_governance_docs_test.dart`
- `flutter test test/interaction_guard_test.dart`
- `dart run tool/fractal_doc_check.dart --base <commit>`

### 8.3 发布判定
- 研发轨未达标：不可合并。
- 体验轨未达标：不可发布。

## 9. 实施顺序建议（一次性对齐）
1. 按 S1~S5 补齐入口与状态反馈。
2. 同步补齐失败恢复动作与错误码映射。
3. 补齐对应 Widget/流程测试。
4. 完成治理文档一致性更新。
5. 跑完整门禁并修复红灯至全绿。
