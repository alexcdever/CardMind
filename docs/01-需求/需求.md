# CardMind 需求文档

## 1. 产品概述
- 本项目是一个基于CRDT技术的卡片笔记应用，支持多设备间实时数据同步
- 核心设计：每个协作网络作为独立的数据池，设备作为数据池的出入口
- 数据管理：所有数据类型（卡片、协作网络、设备）均支持增删改查操作

## 2. 数据资源定义

### 2.1 卡片
- **属性**：id、标题、内容、创建时间、更新时间
- **数据关联**：一个卡片对应一个LoroDoc对象，LoroDoc的唯一id即为卡片id
- **网络行为**：
  - 未设置常驻网络时，新建卡片默认不加入任何协作网络
  - 支持自由加入/退出任意协作网络

### 2.2 协作网络
- **属性**：id、昵称、密码、创建时间、更新时间、设备列表
- **数据关联**：一个协作网络对应一个LoroDoc对象，LoroDoc的唯一id即为协作网络id
- **生命周期**：所有设备退出后，协作网络自动消失
- **加入条件**：需要连接到可访问的信令服务器，并验证网络id和密码

### 2.3 设备
- **属性**：id、昵称、创建时间、更新时间
- **设备标识**：设备id采用设备指纹生成
- **默认昵称**：设备型号+设备id前6位（如：iPhone-abc123）
- **网络行为**：
  - 初始化时自动加入默认创建的协作网络
  - 支持自由加入/退出任意协作网络

## 3. 目标平台
- **桌面端**：Windows、macOS、Linux
- **移动端**：Android、iOS

## 4. 技术实现方案

### 4.1 协同网络架构
- **核心技术**：基于Loro（CRDT协议）和libp2p（P2P网络协议）
  - Loro：实现分布式系统中数据的无冲突同步
  - libp2p：实现设备间的组网、通信和服务发现，替代WebRTC和传统信令服务

### 4.2 ID生成策略
- 采用UUID v7作为主要ID生成算法，支持分布式环境下的唯一ID生成

### 4.3 服务发现机制
- **基于libp2p**：利用libp2p内置的服务发现能力实现设备间的发现和连接
- **mDNS集成**：通过libp2p的mDNS协议实现本地网络内的设备发现
- **去中心化设计**：无需传统的信令服务器，设备直接通过libp2p建立连接

### 4.4 数据持久化
- **存储方案**：使用SQLite数据库，参考卡片和协作网络属性建表
- **数据结构**：额外添加字段存储LoroDoc二进制数据
- **设计目标**：SQLite表主要用于保存最新数据，提供快速查询能力

### 4.5 前后端架构
- **前端**：Flutter负责UI渲染和网络权限申请
- **后端**：Rust负责核心业务逻辑，包括数据存储、同步、设备组网和通信等
- **通信机制**：前后端通过flutter_rust_bridge进行通信
- **依赖管理**：
  - Flutter端：不直接依赖loro-dart
  - Rust端：依赖loro、libp2p、sea-orm和rusqlite
- **libp2p使用**：Rust端通过libp2p实现设备间的组网、通信和服务发现，替代WebRTC和传统信令服务
- **数据处理流程**：
  - **写操作**：Flutter传入写数据请求 → Rust端写入Loro → 通过Loro的subscribe机制自动更新SQLite表数据
  - **读操作**：Flutter直接从SQLite表中读取数据
  - **设计目标**：实现后端数据的读写分离，提高系统性能和响应速度
- **设计原则**：Rust端根据开闭原则提供API给Flutter端调用

## 5. App默认行为
- 初始化后默认创建一个协作网络，并为当前设备生成唯一id和默认昵称
- 支持设置多个协作网络为常驻网络
- 常驻网络规则：设置后新建的卡片会自动加入所有常驻网络

## 6. 操作流程细节
- **设备退出网络**：
  - 退出前检查当前设备是否有卡片加入该协作网络
  - 若存在关联卡片，弹出提示确认
  - 确认退出后，自动解除所有关联卡片与该网络的绑定关系
