# 协作网络管理

## 1. 概述

协作网络管理模块负责CardMind应用的设备协作、网络认证、设备管理和数据同步功能，确保多个设备能够安全、高效地协同工作并保持数据一致。

## 2. 功能需求

### 2.1 网络基础管理

#### 2.1.1 网络ID机制
- 基于网络ID的认证机制
- 每个设备可创建任意数量的协作网络，每个网络拥有唯一网络ID
- 网络ID是协作网络的核心标识
- 设备可同时加入多个协作网络
- 每个协作网络默认包含三个属性：**唯一ID**、**昵称**和**设备列表**

#### 2.1.2 初始网络创建
- App初始化自动生成设备ID时，**默认创建一个名为"local"的协作网络**，其昵称为"local"
- 其他新创建的网络，默认昵称为**网络ID的前5位字符**

#### 2.1.3 网络昵称管理
- 支持对已创建的协作网络进行重命名操作（修改网络昵称）
- 默认创建的"local"网络可被重命名
- 网络昵称修改后，在所有加入该网络的设备上同步更新
- 网络昵称仅用于显示，不影响网络ID和数据流转

### 2.2 设备管理

#### 2.2.1 设备ID机制
- 每个设备生成并存储唯一的设备ID
- 用于在协作网络中区分不同设备

#### 2.2.2 设备昵称机制
- 设备除了设备ID外，还包含**设备昵称**属性
- 设备昵称默认值规则：**主机名+设备ID前五位**（例如：win-a4g2q，其中win为主机名，a4g2q为设备ID前五位）
- 支持为设备设置友好的设备昵称
- **昵称修改限制**：每个设备只能修改自己设备的昵称，通过设备ID判断昵称所属
- 设备昵称修改后，在所有协作网络中同步更新

#### 2.2.3 设备列表管理
- 设备ID和设备昵称保存在协作网络的设置中，记录在设备列表里
- 设备列表作为默认属性记录在每个协作网络的专属YDoc中
- 设备列表在网络内实时同步，设备加入或修改昵称时自动更新
- 专属YDoc中的设备列表确保网络内所有设备信息的一致性

### 2.3 Access Code机制

#### 2.3.1 Access Code定义
- 设备通过输入Access Code加入已存在的协作网络
- Access Code是包含信令服务器的连接方式和协作网络的id的加入凭证
- 同一网络ID下的所有设备共享相同的卡片数据

#### 2.3.2 Access Code组成
- 协作网络ID：标识目标协作网络
- 信令服务器连接方式：包含信令服务器的IP地址和端口信息
- 时间戳：用于连接有效性验证
- 设备标识：生成该Access Code的设备信息

#### 2.3.3 Access Code生成与使用
- 生成时机：创建新网络时实时生成、在设置页面中可手动实时生成
- 存储方式：不持久化存储，每次需要时重新生成
- 使用方式：通过复制粘贴方式分享

### 2.4 网络操作

#### 2.4.1 设备加入网络
- 通过Access Code加入已存在的协作网络
- 加入后自动同步网络内的设备列表和数据

#### 2.4.2 设备退出网络
- 支持设备退出协作网络的操作
- 设备退出网络前，**自动检查是否存在绑定了该网络的卡片**
- 若存在绑定卡片，**弹出确认框进行提示和二次确认**
- 二次确认后依旧要退出的，**自动解除所有绑定到该网络的卡片的绑定关系**

### 2.5 卡片数据绑定机制

#### 2.5.1 绑定规则
- 卡片数据可选择是否绑定到特定协作网络
- **绑定状态**：卡片数据仅在绑定的协作网络中流转
- **未绑定状态**：卡片数据不会在任何协作网络中流转

#### 2.5.2 绑定操作
- 支持在创建或编辑卡片时设置绑定关系
- 支持将已有的未绑定卡片绑定到特定网络

#### 2.5.3 默认绑定设置
- **默认行为**：新创建的卡片默认绑定到local网络
- **默认设置修改**：用户可修改App设置，将默认绑定的协作网络设置为其他网络
- **默认绑定移除**：用户可移除默认绑定设置，使新卡片不再默认绑定任何协作网络

### 2.6 数据同步机制

#### 2.6.1 核心同步技术
- 使用Yjs的CRDT（Conflict-free Replicated Data Type）算法
- 实现无冲突数据合并，确保最终一致性
- 支持离线操作，上线后自动同步

#### 2.6.2 专属YDoc设计
- 每个协作网络拥有专属的YDoc实例
- 专属YDoc仅用于保存该协作网络的设置信息
- 专属YDoc仅在所属协作网络内流转，不跨网络同步
- 协作网络设置包括：网络名称、设备权限、同步策略等
- 专属YDoc中包含**设备列表**作为默认属性，记录网络内所有设备的信息

#### 2.6.3 同步策略
- 优先使用本地数据，确保快速响应
- 后台自动同步，用户无感知
- 支持增量同步，减少网络传输

#### 2.6.4 离线支持
- 支持完全离线使用，所有功能在离线状态下正常工作
- 离线时数据自动存储在本地
- 上线后自动与其他设备同步数据

#### 2.6.5 网络连接限制
- 设备间直连同步需要在同一局域网环境下
- 不同网络环境下的设备无法直接同步数据，需要通过信令服务器

### 2.7 网络原则
- 遵循离线优先原则，无需依赖后端服务器
- 无需第三方授权，简化用户交互流程
- 适用于家庭局域网协同组网场景

## 3. 注意事项

### 3.1 网络安全
- Access Code包含敏感连接信息，不应通过不安全的渠道分享
- 所有数据不上传到第三方服务器，保护用户隐私
- 数据同步默认在本地加密存储

### 3.2 数据流转
- 卡片数据绑定到特定网络后，仅能在该网络内流转，需谨慎设置
- 未绑定的卡片数据不会在任何协作网络中流转，仅存储在本地设备
- 设备退出网络后，所有绑定到该网络的卡片会自动解除绑定关系

### 3.3 网络管理
- 设备创建多个协作网络时，需注意网络ID的唯一性和管理
- 设备加入多个网络时，需合理管理设备资源和同步策略
- 网络昵称仅用于显示，便于用户识别不同网络
- 网络重命名操作仅修改网络显示名称，不影响网络ID和数据流转

### 3.4 设备管理
- 设备除了设备ID外，还包含设备昵称属性
- 设备昵称默认值规则：主机名+设备ID前五位（例如：win-a4g2q）
- 设备昵称可自定义修改，便于用户识别不同设备
- 专属YDoc中的设备列表确保网络内所有设备信息的一致性

### 3.5 默认设置
- 默认创建的"local"网络是卡片数据的初始绑定目标，可根据需求重命名或修改默认绑定
- 修改默认绑定网络后，新创建的卡片将自动绑定到新设置的网络
- 移除默认绑定设置后，新卡片将不会自动绑定到任何网络，需手动选择

### 3.6 网络连接
- 设备间直连同步需要在同一局域网环境下
- 不同网络环境下的设备无法直接同步数据
- 支持多设备间数据合并，解决冲突