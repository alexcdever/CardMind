# UI 流程设计

**最后更新**: 2026-01-14 (添加初始化决策逻辑)
**原始设计**: `docs/archive/card_pool_ownership_refactoring.md#4`
**对应 ADR**: `docs/adr/0001-single-pool-ownership.md`

---

## 概述

本文档定义 CardMind 各功能的用户操作流程和页面跳转逻辑。所有流程设计围绕**快速、简洁、可靠**的原则，特别关注**笔记空间管理**和**P2P 同步**的核心流程。

**流程图说明**:
- `[ ]` = 页面/界面
- `( )` = 操作/事件
- `< >` = 判断/分支
- `→` = 流程方向

---

### 首次启动

```
┌─────────────────────────────────────────┐
│ (启动应用)                              │
└──────────────┬──────────────────────────┘
               │
               ▼
         <是否已加入笔记空间?>
               │
         是    │    否
      ┌────────┴────────┐
      ▼                 ▼
[欢迎页]          [设备发现页]
      │                 │
      ▼                 ▼
[显示创建向导]      [显示选择界面]
  • 设置密码        • 发现附近设备
      │                 │
      ▼             ┌───┴───┐
[开始使用]        [创建向导] [配对界面]
                    │          │
                    └───┬──────┘
                        ▼
                    [开始使用]
```

---

## 1.1 初始化决策逻辑

### 决策伪代码

```rust
pub async fn on_app_start() -> Result<InitAction> {
    // 1. 检查本地配置
    let config = DeviceConfig::load_or_create()?;
    
    if config.is_joined() {
        return Ok(InitAction::EnterMain); // 已加入，直接进入主页
    }
    
    // 2. 启动 mDNS 发现
    let discovery = start_mdns_discovery().await?;
    
    if discovery.peers.is_empty() {
        return Ok(InitAction::ShowCreateWizard); // 未发现，引导创建
    }
    
    // 3. 发现设备，显示选择
    return Ok(InitAction::ShowChoice { peers: discovery.peers });
}

pub enum InitAction {
    /// 直接进入主页
    EnterMain,
    
    /// 显示创建向导
    ShowCreateWizard,
    
    /// 显示选择（配对或创建）
    ShowChoice { peers: Vec<DiscoveredPeer> },
}
```

### 关键实现细节

#### mDNS 发现超时处理
- **超时时间**: 30 秒未发现设备，自动引导创建
- **网络权限**: 首次启动需请求局域网访问权限
- **错误恢复**: 配对失败可返回选择界面重试

#### UI 交互细节

```
┌─────────────────────────────────────┐
│  欢迎使用 CardMind                   │
├─────────────────────────────────────┤
│  发现已有的笔记空间                  │
│                                     │
│  📱 MacBook Pro                     │
│     "我的笔记"空间                  │
│     [ 配对 ]                       │
│                                     │
│  💻 iPhone 12                       │
│     "我的笔记"空间                  │
│     [ 配对 ]                       │
│                                     │
│  ────────────────────────────       │
│  或                                 │
│                                     │
│  [ 创建新笔记空间 ]                 │
└─────────────────────────────────────┘
```

#### 对应 API

- **检查状态**: `api::pool::check_initialization_status()`
- **创建空间**: `api::pool::initialize_first_time(password: String)`
- **加入空间**: `api::pool::join_existing_pool(pool_id: String, password: String)`
- **发现设备**: `api::discovery::start_mdns_discovery()`

#### 错误场景处理

| 场景 | 错误提示 | 处理方式 |
|------|----------|----------|
| mDNS 超时 | "未发现附近的设备" | 显示创建向导 |
| 密码错误 | "笔记空间密码不正确" | 允许重试 3 次 |
| 网络断开 | "无法连接到设备" | [重试] [取消] |
| 验证失败 | "密码验证失败" | 返回设备列表 |

---

### 正常启动

```
┌─────────────────────────────────────────┐
│ (启动应用)                              │
└──────────────┬──────────────────────────┘
               │
               ▼
       [检查本地配置]
           • 读取 DeviceConfig.pool_id
                │
               ▼
         <已加入笔记空间?>
               │
         是    │    否
      ┌────────┴────────┐
      ▼                 ▼
[首页 - 加载数据]  [初始化流程]
   • 显示骨架屏       • 启动 mDNS 发现
   • 加载 SQLite 缓存   • 显示选择界面
                        │
                        └─ (用户选择创建或配对)
```

---

## 2. 笔记空间管理流程

### 2.1 首次启动：创建笔记空间（第 1 台设备）

```
[初始化流程]
   │
   ▼
(用户选择创建新笔记空间)
   │
   ▼
[创建笔记空间向导]
   • 设置密码
   • 确认密码
   │
   ▼
(点击 [开始使用])
   │
   ▼
[自动创建并加入]
   • 生成 UUID v7
   • 自动创建笔记空间
   • 设备自动加入
   • 存储密码到 Keyring
   │
   ▼
[首页 - 就绪]
   • 显示欢迎引导
   • 提示创建第一张卡片
```

### 2.2 首次启动：加入已有笔记空间（第 N 台设备，N>1）

```
[初始化流程]
   │
   ▼
(用户选择加入已有笔记空间)
   │
   ▼
[设备发现页]
   • 发现附近设备
   • 显示发现的笔记空间
   │
   ▼
(用户选择设备 + 输入密码)
   │
   ▼
[验证并加入]
   • 验证密码
   • 添加设备到空间成员列表
   • 存储密码到 Keyring
   • 同步数据
   │
   ▼
[首页 - 就绪]
   • 显示同步的卡片
```

---

## 3. P2P 同步流程

### 3.1 启用同步（自动创建时已启用）

笔记空间在创建时自动启用 P2P 同步，无需单独开关。

```
[笔记空间创建成功]
   │
   ▼
[后台启动 P2P 服务]
   • mDNS 广播
   • libp2p 监听
   • 显示同步状态指示
```

### 3.2 设备发现与配对流程

```
[同步设置页] 或 [同步状态页]
  │
  ▼
(后台自动发现局域网设备)
  • mDNS 扫描
  • 发现设备 → 显示在列表
  │
  ▼
[发现的设备列表]
  • 📱 iPhone 13 (192.168.1.100)
      [已配对]
  • 💻 MacBook Pro (192.168.1.101)
      [已配对]
  • 🖥️ Unknown Device (192.168.1.102)
      [配对] ← 未配对设备
  │
  ▼
(点击未配对设备的 [配对])
  │
  ▼
[设备配对对话框]
  • 设备信息: Unknown Device
  • IP: 192.168.1.102
  • 输入笔记空间密码...
  │
  ▼
(用户输入密码)
  │
  ▼
(点击 [配对])
  │
  ▼
(建立 P2P 连接)
  • libp2p 握手
  • 传输加密密码（本地验证）
  │
  ▼
(发送密码验证请求到对方设备)
  │
  ▼
<对方设备验证密码>
  │
通过│ 失败
┌───┴───┐
│       ▼
│     [密码验证失败]
│       • "密码错误，请检查输入"
│       • [重试] [取消]
│       │
│       ├─→ (点击 [重试])
│       │     │
│       │     └→ (返回密码输入)
│       │
│       └─→ (点击 [取消])
│             │
│             └→ [同步设置页]
│
▼
[配对成功]
  • Toast: "设备配对成功"
  • 保存设备信息
  • 保存验证状态（加密）
  │
  ▼
(立即启动双向同步)
  │
  ├─→ (本地 → 远程)
  │     • 对比版本向量
  │     • 发送增量更新
  │
  └─→ (远程 → 本地)
        • 接收增量更新
        • Loro 自动合并
        • 更新 SQLite 缓存
        │
        ▼
      [同步完成]
        • Toast: "同步完成 (N 张卡片)"
        • 更新设备状态
        │
        ▼
      [同步设置页]
        • 设备列表刷新
        • 显示最后同步时间
```

**配对失败处理**:
| 失败原因 | 错误提示 | 处理方式 |
|----------|----------|----------|
| 密码错误 | "笔记空间密码不正确" | 允许重试 3 次 |
| 网络断开 | "无法连接到设备" | [重试] [取消] |
| 超时 | "设备无响应" | [重试] [取消] |
| 对方拒绝 | "对方设备拒绝配对" | 返回设备列表 |

### 3.3 自动同步流程

```
(设备已配对 + 同步已启用)
  │
  ▼
(后台监听本地数据变更)
  │
  ├─→ (卡片创建/编辑/删除)
  │     │
  │     ▼
  │   (Loro commit + 文件持久化)
  │     │
  │     ▼
  │   (触发同步检测)
  │     │
  │     ▼
  │   <局域网有已配对设备?>
  │     │
  │  否 │ 是
  │  ┌──┴──┐
  │  │     ▼
  │  │   (建立 P2P 连接)
  │  │     │
  │  │     ▼
  │  │   (发送增量更新)
  │  │     • Loro export_updates()
  │  │     • 只传输差异部分
  │  │     │
  │  │     ▼
  │  │   <传输成功?>
  │  │     │
  │  │  是 │ 否
  │  │  ┌──┴──┐
  │  │  │     ▼
  │  │  │   (记录失败，稍后重试)
  │  │  │     │
  │  │  │     └→ (5 秒后重试)
  │  │  │
  │  │  ▼
  │  │ (更新同步状态)
  │  │   • 最后同步时间
  │  │   • 同步设备列表
  │  │   │
  │  │   └→ (通知 UI 更新)
  │  │
  │  ▼
  │ (等待下次变更)
  │
  └─→ (接收远程设备更新)
        │
        ▼
      (验证设备身份)
        • 检查是否已配对
        • 验证数据池密码（缓存）
        │
        ▼
      <验证通过?>
        │
     是 │ 否
     ┌──┴──┐
     │     └→ (拒绝连接)
     │
     ▼
   (接收 Loro updates)
     │
     ▼
   (应用到本地 LoroDoc)
     • import_updates()
     • Loro 自动合并
     • CRDT 保证无冲突
     │
     ▼
   (触发订阅回调)
     │
     ▼
   (更新 SQLite 缓存)
     │
     ▼
   (通知 UI 刷新)
     │
     ▼
   (显示同步提示)
     • Toast: "已同步来自 iPhone 的更新"
```

**同步状态指示**:
- 实时同步中: AppBar 显示旋转图标
- 同步完成: 图标消失，显示"已同步"
- 同步失败: 显示橙色感叹号，点击查看详情

---

## 4. 卡片操作流程

### 4.1 快速创建卡片流程

**目标**: 30 秒内完成创建

```
[首页]
  │
  ▼
(点击 FAB [+])
  │
  ▼
[卡片编辑页 - 新建模式]
  • AppBar: [取消] "新建卡片" [完成]
  • 编辑器: 空白，光标自动聚焦
  • 底部栏: 添加标签
  │
  ▼
(用户输入内容)
  • 支持 Markdown
  • 实时自动保存草稿（本地）
  │
  ▼
(点击 [完成])
  │
  ▼
<内容为空?>
  │
是│ 否
┌─┴─┐
│   └→ (创建卡片)
│        │
│        ▼
│      (生成 UUID v7)
│        │
│        ▼
│      (创建 LoroDoc)
│        • set("content", 内容)
│        • set("created_at", 时间戳)
│        • commit()
│        │
│        ▼
│      (持久化到文件)
│        • data/loro/<uuid>/snapshot.loro
│        │
│        ▼
│      (触发订阅 → 更新 SQLite)
│        │
│        ▼
│      [成功提示]
│        • Toast: "卡片已创建"
│        │
│        ▼
│      [首页]
│        • 新卡片出现在列表顶部
│        • 高亮 2 秒后恢复
│        │
│        └→ (后台触发自动同步)
│
▼
[放弃确认对话框]
  • "是否放弃这张卡片？"
  • [取消] [放弃]
  │
  ├─→ (点击 [取消])
  │     │
  │     └→ (返回编辑页)
  │
  └─→ (点击 [放弃])
        │
        ▼
      (删除草稿)
        │
        ▼
      [首页]
```

**性能目标**:
- FAB 点击 → 编辑页打开: < 200ms
- 输入第一个字符响应: < 50ms
- 完成 → 卡片出现: < 500ms

### 4.2 编辑卡片流程

```
[首页] 或 [卡片详情页]
  │
  ▼
(点击卡片 或 点击 [编辑] 按钮)
  │
  ▼
[卡片编辑页 - 编辑模式]
  • AppBar: [取消] "编辑卡片" [完成]
  • 编辑器: 加载卡片内容
  • 底部栏: 标签
  │
  ▼
(用户修改内容)
  • 每隔 2 秒自动保存
  • 显示"保存中..." / "已保存"
  │
  ├─→ (自动保存)
  │     │
  │     ▼
  │   (更新 LoroDoc)
  │     • set("content", 新内容)
  │     • set("updated_at", 时间戳)
  │     • commit()
  │     │
  │     ▼
  │   (持久化)
  │     • update.loro (增量)
  │     │
  │     └→ (触发订阅 → 更新 SQLite)
  │
  └─→ (点击 [完成])
        │
        ▼
      (最后一次保存)
        │
        ▼
      [卡片详情页] 或 [首页]
        • 显示更新后的内容
        │
        └→ (后台触发自动同步)
```

**自动保存策略**:
- 触发条件: 内容变更后 2 秒无操作
- 保存反馈: 底部栏显示"保存中..." → "已保存"
- 失败处理: 显示"保存失败"，点击手动重试

### 4.3 删除卡片流程

```
[卡片详情页]
  │
  ▼
(点击 ⋮ 菜单 → 删除)
  │
  ▼
[删除确认对话框]
  • "确认删除这张卡片？"
  • "删除后可在 30 天内恢复"
  • [取消] [删除]
  │
  ├─→ (点击 [取消])
  │     │
  │     └→ [卡片详情页]
  │
  └─→ (点击 [删除])
        │
        ▼
      (软删除卡片)
        • LoroDoc set("is_deleted", true)
        • set("deleted_at", 时间戳)
        • commit()
        │
        ▼
      (更新 SQLite)
        • is_deleted = true
        • 从列表隐藏
        │
        ▼
      [成功提示]
        • Toast: "卡片已删除"
        • [撤销] (3 秒内可点击)
        │
        ├─→ (点击 [撤销])
        │     │
        │     ▼
        │   (恢复卡片)
        │     • set("is_deleted", false)
        │     • set("deleted_at", null)
        │     • commit()
        │     │
        │     └→ [卡片详情页]
        │
        └─→ (3 秒后或返回首页)
              │
              ▼
            [首页]
              • 卡片从列表消失
              │
              └→ (后台触发自动同步)
                   • 同步删除标记到其他设备
```

---

## 5. 搜索流程

```
[首页]
  │
  ▼
(点击 AppBar 搜索图标 🔍)
  │
  ▼
[搜索页]
  • 搜索框自动聚焦
  • 显示搜索历史
  • 筛选栏: 所有标签 | 时间
  │
  ├─→ (点击搜索历史)
  │     │
  │     └→ (填充到搜索框，执行搜索)
  │
  └─→ (用户输入关键词)
        │
        ▼
      <输入长度 >= 2?>
        │
     否 │ 是
     ┌──┴──┐
     │     ▼
     │   (实时搜索)
     │     • 去抖动 300ms
     │     • SQLite FTS5 全文搜索
     │     • 搜索范围: 标题 + 内容
     │     │
     │     ▼
     │   <有结果?>
     │     │
     │  是 │ 否
     │  ┌──┴──┐
     │  │     ▼
     │  │   [空状态]
     │  │     • "未找到相关卡片"
     │  │     • [清除筛选]
     │  │
     │  ▼
     │ [搜索结果列表]
     │   • 匹配词高亮（Primary-500 背景）
     │   • 显示摘要（含匹配词上下文）
     │   • 底部显示"找到 N 张卡片"
     │   │
     │   ├─→ (点击筛选条件)
   │   │     │
   │   │     ▼
   │   │   [筛选器]
   │   │     • 标签: 多选
   │   │     • 时间: 预设 + 自定义
   │   │     │
   │   │     └→ (应用筛选 → 刷新结果)
     │   │
     │   └─→ (点击某张卡片)
     │         │
     │         └→ [卡片详情页]
     │               • 保持搜索关键词高亮
     │               • 返回键 → 回到搜索结果
     │
     └─→ (输入长度 < 2)
           │
           └→ [搜索历史] 或 [空状态]
```

**搜索优化**:
- 去抖动: 输入停止 300ms 后执行搜索
- 缓存: 相同关键词缓存结果 1 分钟
- 排序: 优先标题匹配，其次内容匹配，最后按时间排序

---

## 6. 标签管理流程

```
[卡片编辑页]
  │
  ▼
(点击底部栏 "# 添加标签")
  │
  ▼
[标签选择器 - 底部抽屉]
  • 当前卡片已有标签（可移除）
  • 最近使用标签
  • 所有标签（按使用频率排序）
  • + 新建标签
  │
  ├─→ (点击已有标签)
  │     │
  │     └→ (添加到卡片)
  │
  ├─→ (点击卡片已有标签的 ✕)
  │     │
  │     └→ (从卡片移除)
  │
  └─→ (点击 + 新建标签)
        │
        ▼
      [新建标签对话框]
        • 标签名（必填，1-20 字符）
        • 颜色（可选，预设 8 种颜色）
        │
        ▼
      (点击 [创建])
        │
        ▼
      <验证通过?>
        │
     是 │ 否
     ┌──┴──┐
     │     └→ [错误提示] → (返回对话框)
     │
     ▼
   (创建标签)
     • 保存到标签表
     • 自动添加到当前卡片
     │
     ▼
   [标签选择器]
     • 新标签出现在列表
     • 已选中状态
```

---

## 7. 设置流程

```
[首页]
  │
  ▼
(点击 AppBar ⋮ 菜单 → 设置)
  │
  ▼
[设置页]
  │
  ├─→ (数据池管理)
  │     │
  │     └→ [数据池管理页] (见第 2 节)
  │
  ├─→ (同步设置)
  │     │
  │     └→ [同步状态页] (见第 3 节)
  │
  ├─→ (导出数据)
  │     │
  │     ▼
  │   [导出选项对话框]
  │     • 导出格式: JSON / Markdown
  │     • 导出范围:
  │       ○ 当前数据池
  │       ○ 所有数据池
  │       ○ 选中的卡片
  │     • [取消] [导出]
  │     │
  │     └─→ (点击 [导出])
  │           │
  │           ▼
  │         (生成导出文件)
  │           • 打包为 ZIP
  │           • 调用系统分享
  │           │
  │           └→ [系统分享面板]
  │
  ├─→ (主题模式)
  │     │
  │     └→ [主题选择]
  │           • 浅色
  │           • 深色
  │           • 跟随系统
  │
  ├─→ (字体大小)
  │     │
  │     └→ [字体选择]
  │           • 小 (13px)
  │           • 标准 (14px)
  │           • 大 (16px)
  │           • 特大 (18px)
  │
  └─→ (开关类设置)
        • 自动保存: 切换开关即保存
        • Markdown 工具栏: 切换开关即保存
```

---

## 8. 错误处理流程

### 8.1 网络错误

```
(P2P 同步过程中)
  │
  ▼
<网络连接断开>
  │
  ▼
(停止当前传输)
  │
  ▼
(更新同步状态)
  • 显示"同步失败"
  • 数据池芯片显示橙色感叹号
  │
  ▼
[Toast 提示]
  • "网络连接已断开"
  • "将在连接恢复后自动重试"
  │
  ▼
(后台定时重试)
  • 每 5 秒检测一次
  • 检测到网络恢复 → 自动同步
```

### 8.2 数据加载失败

```
(应用启动时)
  │
  ▼
<SQLite 加载失败>
  │
  ▼
[错误页面]
  • "无法加载数据"
  • 可能原因:
    - 数据库损坏
    - 权限问题
  • [重试] [恢复备份] [查看日志]
  │
  ├─→ (点击 [重试])
  │     │
  │     └→ (重新加载) → <成功?>
  │                       │
  │                    是 │ 否
  │                    ┌──┴──┐
  │                    │     └→ (返回错误页)
  │                    │
  │                    └→ [首页]
  │
  ├─→ (点击 [恢复备份])
  │     │
  │     └→ [备份恢复流程]
  │
  └─→ (点击 [查看日志])
        │
        └→ [日志查看器]
```

### 8.3 同步冲突（极少发生）

CRDT 自动解决冲突，但如果出现数据异常：

```
(Loro 合并更新时)
  │
  ▼
<检测到异常>
  │
  ▼
[冲突提示]
  • "检测到数据冲突"
  • "卡片: [标题]"
  • [查看详情] [自动解决] [联系支持]
  │
  ├─→ (点击 [自动解决])
  │     │
  │     └→ (使用 Loro 默认合并策略)
  │           │
  │           └→ (记录日志 + 继续)
  │
  └─→ (点击 [查看详情])
        │
        └→ [冲突详情页]
              • 显示两个版本
              • [使用本地版本] [使用远程版本]
```

**注意**: CRDT 特性决定了冲突极少发生，此流程仅作为兜底方案。

---

## 流程设计原则

### 1. **快速路径优先**

- 高频操作（创建卡片、切换数据池）减少步骤
- FAB → 编辑 → 完成，最快 3 步完成创建

### 2. **确认关键操作**

- 删除、退出编辑需要确认
- 但提供"撤销"机制，避免过度确认

### 3. **清晰的状态反馈**

- 同步状态实时显示
- 错误提示明确原因和解决方案

### 4. **离线优先**

- 所有操作离线可用
- 网络连接恢复后自动同步

### 5. **数据池隔离**

- 每个流程都明确当前数据池
- 跨数据池操作需要密码验证

---

**文档维护**:
- 此文档定义用户操作流程，开发时必须遵循
- 如需调整流程，需更新此文档并说明理由
- 实现细节参考代码：`lib/blocs/` 和 `lib/screens/`

**相关文档**:
- 页面布局 → [ui_layouts.md](./ui_layouts.md)
- 反馈设计 → [feedback_design.md](./feedback_design.md)
- 信息架构 → [information_arch.md](./information_arch.md)
