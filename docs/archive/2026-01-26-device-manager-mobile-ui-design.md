# 移动端设备管理页面 UI 设计规格

## 1. 概述

移动端设备管理页面（DeviceManager）用于管理数据池中的设备，支持查看设备列表、配对新设备、编辑当前设备名称。

**设计原则**：
- 移动端平台特定设计（非响应式）
- 安全的设备配对流程（6 位验证码）
- 清晰的设备状态展示
- 简洁的交互流程

**参考文件**：
- React UI: `react_ui_reference/src/app/components/device-manager.tsx`

## 2. 核心功能

### 2.1 当前设备显示
- 单独显示在顶部，带"本机"标识
- 特殊背景色区分（浅蓝色背景）
- 可点击编辑设备名称（弹出对话框）
- 始终显示"在线"状态

### 2.2 配对新设备
- 两个标签页切换：
  - **显示二维码**：显示本机二维码（240x240px），供其他设备扫描
  - **扫描二维码**：内嵌相机视图，扫描其他设备二维码
- 安全验证流程：
  - 被扫描方显示 6 位数字验证码
  - 扫描方输入验证码完成配对
- 后台处理配对请求，无需用户等待

### 2.3 设备列表
- 显示数据池中所有已配对设备
- 排序规则：在线优先 + 最后在线时间倒序
- 设备信息：名称、类型图标、在线状态、最后在线时间
- 空状态：显示图标和提示文字

### 2.4 未加入数据池状态
- 整个页面灰色不可用
- 显示提示："请先加入数据池"

## 3. 组件结构

### 3.1 DeviceManagerPage 组件（主页面）

```dart
class DeviceManagerPage extends StatelessWidget {
  /// 是否已加入数据池
  final bool hasJoinedPool;
  
  /// 当前设备信息
  final Device currentDevice;
  
  /// 已配对设备列表
  final List<Device> pairedDevices;
  
  /// 编辑设备名称回调
  final OnDeviceNameChange onDeviceNameChange;
  
  /// 配对新设备回调
  final OnPairDevice onPairDevice;

  const DeviceManagerPage({
    required this.hasJoinedPool,
    required this.currentDevice,
    required this.pairedDevices,
    required this.onDeviceNameChange,
    required this.onPairDevice,
  });
}
```

### 3.2 CurrentDeviceCard 组件（当前设备卡片）

```dart
class CurrentDeviceCard extends StatelessWidget {
  final Device device;
  final VoidCallback onEditName;

  const CurrentDeviceCard({
    required this.device,
    required this.onEditName,
  });
}
```

### 3.3 PairDeviceDialog 组件（配对设备对话框）

```dart
class PairDeviceDialog extends StatefulWidget {
  final String currentDeviceId;
  final OnPairDevice onPairDevice;

  const PairDeviceDialog({
    required this.currentDeviceId,
    required this.onPairDevice,
  });
}
```

### 3.4 DeviceListItem 组件（设备列表项）

```dart
class DeviceListItem extends StatelessWidget {
  final Device device;

  const DeviceListItem({
    required this.device,
  });
}
```

### 3.5 VerificationCodeDialog 组件（验证码对话框）

```dart
class VerificationCodeDialog extends StatelessWidget {
  final String verificationCode;
  final String deviceName;

  const VerificationCodeDialog({
    required this.verificationCode,
    required this.deviceName,
  });
}
```

### 3.6 VerificationCodeInput 组件（验证码输入）

```dart
class VerificationCodeInput extends StatefulWidget {
  final String deviceName;
  final OnVerificationCodeSubmit onSubmit;

  const VerificationCodeInput({
    required this.deviceName,
    required this.onSubmit,
  });
}
```

## 4. 数据模型

### 4.1 Device（设备信息）

```dart
class Device {
  final String id;              // 设备 ID
  final String name;            // 设备名称
  final DeviceType type;        // 设备类型
  final DeviceStatus status;    // 在线状态
  final DateTime lastSeen;      // 最后在线时间
}

enum DeviceType {
  phone,    // 手机
  laptop,   // 笔记本
  tablet,   // 平板
}

enum DeviceStatus {
  online,   // 在线
  offline,  // 离线
}
```

### 4.2 PairingRequest（配对请求）

```dart
class PairingRequest {
  final String requestId;           // 请求 ID
  final String deviceId;            // 对方设备 ID
  final String deviceName;          // 对方设备名称
  final DeviceType deviceType;      // 对方设备类型
  final String verificationCode;    // 6 位验证码
  final DateTime timestamp;         // 请求时间
}
```

### 4.3 回调类型定义

```dart
typedef OnDeviceNameChange = void Function(String newName);
typedef OnPairDevice = Future<bool> Function(String deviceId, String verificationCode);
typedef OnVerificationCodeSubmit = Future<bool> Function(String code);
```


## 5. 视觉设计

### 5.1 页面布局

- **背景色**：白色（浅色模式）/ 深色（深色模式）
- **内边距**：左右 16px，顶部 16px，底部 16px
- **组件间距**：16px
- **滚动区域**：整个页面可滚动

### 5.2 未加入数据池状态

- **覆盖层**：半透明灰色遮罩（rgba(0, 0, 0, 0.5)）
- **提示卡片**：
  - 居中显示
  - 白色背景，圆角 12px
  - 内边距 24px
  - 图标：灰色警告图标（48x48px）
  - 文字："请先加入数据池"，16px，灰色

### 5.3 当前设备卡片设计

**布局规格**：
- **背景色**：主题色 10% 透明度（#007AFF 10%）
- **边框**：1px，主题色 20% 透明度
- **圆角**：12px
- **内边距**：16px
- **高度**：自适应内容

**内容布局**：
- **设备图标**：24x24px，主题色
- **设备信息**：
  - 设备名称：16px，粗体，黑色
  - 副标题："本机"，12px，灰色
- **在线徽章**：
  - 背景色：绿色（#34C759）
  - 文字："在线"，12px，白色
  - 图标：WiFi 图标，12x12px
  - 圆角：4px，内边距 4px 8px
- **编辑按钮**：
  - 文字："编辑"，14px，主题色
  - 最小触摸区域：48x48px

### 5.4 配对设备按钮

- **位置**：设备列表标题右侧
- **样式**：主题色填充按钮
- **尺寸**：高度 36px，内边距 12px 16px
- **圆角**：8px
- **图标**：Plus 图标，16x16px，白色
- **文字**："配对设备"，14px，白色

### 5.5 配对设备对话框

**对话框规格**：
- **宽度**：屏幕宽度 - 32px（左右各 16px）
- **最大宽度**：400px
- **背景色**：白色，圆角 16px
- **内边距**：24px
- **标题**："配对新设备"，18px，粗体

**标签页设计**：
- **标签栏高度**：48px
- **标签项**：
  - 未选中：灰色文字，无背景
  - 选中：主题色文字，浅色背景
  - 图标：16x16px
  - 文字：14px
  - 间距：图标与文字间距 8px

**显示二维码标签页**：
- **二维码尺寸**：240x240px
- **二维码位置**：居中显示
- **提示文字**：
  - 位置：二维码下方 16px
  - 文字："请在另一台设备上扫描此二维码"
  - 字体：14px，灰色，居中对齐

**扫描二维码标签页**：
- **相机视图**：
  - 尺寸：240x240px
  - 圆角：12px
  - 位置：居中显示
- **扫描框**：
  - 尺寸：200x200px
  - 边框：2px，白色，虚线
  - 四角：圆角标记
- **提示文字**：
  - 位置：相机视图下方 16px
  - 文字："对准二维码进行扫描"
  - 字体：14px，灰色，居中对齐

### 5.6 验证码显示对话框（被扫描方）

**对话框规格**：
- **宽度**：屏幕宽度 - 32px
- **最大宽度**：360px
- **背景色**：白色，圆角 16px
- **内边距**：24px

**内容布局**：
- **标题**："配对请求"，18px，粗体，居中
- **设备信息**：
  - 位置：标题下方 16px
  - 文字："设备 '{设备名称}' 正在请求配对"
  - 字体：14px，灰色，居中
- **验证码显示**：
  - 位置：设备信息下方 24px
  - 背景色：浅灰色（#F5F5F5）
  - 圆角：12px
  - 内边距：20px
  - 验证码：32px，粗体，等宽字体，黑色，居中
  - 字符间距：8px
- **提示文字**：
  - 位置：验证码下方 16px
  - 文字："请将此验证码告知对方"
  - 字体：12px，灰色，居中
- **关闭按钮**：
  - 位置：底部
  - 文字："关闭"，16px，主题色
  - 高度：48px，全宽

### 5.7 验证码输入对话框（扫描方）

**对话框规格**：
- **宽度**：屏幕宽度 - 32px
- **最大宽度**：360px
- **背景色**：白色，圆角 16px
- **内边距**：24px

**内容布局**：
- **标题**："输入验证码"，18px，粗体，居中
- **设备信息**：
  - 位置：标题下方 16px
  - 文字："请输入设备 '{设备名称}' 显示的验证码"
  - 字体：14px，灰色，居中
- **验证码输入框**：
  - 位置：设备信息下方 24px
  - 样式：6 个独立输入框
  - 每个输入框：
    - 尺寸：48x56px
    - 边框：1px，灰色，圆角 8px
    - 字体：24px，粗体，等宽字体，居中
    - 间距：8px
  - 聚焦状态：边框变为主题色，2px
  - 已填充状态：背景色浅蓝色（#F0F8FF）
- **错误提示**：
  - 位置：输入框下方 8px
  - 文字："验证码错误，请重试"
  - 字体：12px，红色
  - 仅在验证失败时显示
- **按钮组**：
  - 位置：底部
  - 布局：水平排列，间距 12px
  - 取消按钮：灰色边框，灰色文字，48px 高
  - 确认按钮：主题色填充，白色文字，48px 高
  - 确认按钮禁用状态：输入未满 6 位时灰色不可点击

### 5.8 设备列表设计

**列表标题**：
- **文字**："已配对设备 ({数量})"，14px，灰色
- **位置**：配对按钮左侧
- **间距**：标题下方 12px

**空状态**：
- **图标**：WiFi Off 图标，64x64px，灰色，50% 透明度
- **主文字**："暂无配对设备"，14px，灰色
- **副文字**："点击上方按钮配对新设备"，12px，浅灰色
- **布局**：垂直居中，间距 8px
- **内边距**：上下 48px

**设备列表项**：
- **背景色**：浅灰色（#F5F5F5）
- **边框**：1px，灰色（#E0E0E0）
- **圆角**：12px
- **内边距**：16px
- **间距**：列表项之间 8px
- **高度**：自适应内容

**设备列表项内容**：
- **设备图标**：
  - 尺寸：24x24px
  - 颜色：灰色
  - 类型：phone/laptop/tablet 对应图标
- **设备信息**：
  - 设备名称：16px，粗体，黑色
  - 最后在线时间：12px，灰色
  - 格式：
    - 在线设备："在线"
    - 离线设备："最后在线：{时间}"（如"最后在线：2 小时前"）
- **在线状态徽章**：
  - 在线：绿色背景（#34C759），白色文字
  - 离线：灰色背景（#8E8E93），白色文字
  - 尺寸：内边距 4px 8px，圆角 4px
  - 字体：12px


## 6. 交互设计

### 6.1 编辑设备名称交互

**触发方式**：点击当前设备卡片的"编辑"按钮

**交互流程**：
1. 弹出编辑对话框
2. 显示当前设备名称（预填充在输入框）
3. 用户修改名称
4. 点击"保存"按钮或"取消"按钮

**编辑对话框设计**：
- **标题**："编辑设备名称"，18px，粗体
- **输入框**：
  - 预填充当前名称
  - 占位符："请输入设备名称"
  - 高度：48px，圆角 8px
  - 最大长度：32 个字符
  - 自动聚焦，选中全部文字
- **按钮组**：
  - 取消按钮：灰色边框，灰色文字
  - 保存按钮：主题色填充，白色文字
  - 保存按钮禁用条件：名称为空或只有空格

**视觉反馈**：
- 保存成功：对话框关闭，设备名称更新
- 保存失败：显示错误提示（Toast）
- 动画时长：200ms

### 6.2 配对新设备交互

**显示二维码流程**：
1. 点击"配对设备"按钮
2. 弹出配对对话框，默认显示"显示二维码"标签页
3. 生成并显示本机二维码（包含设备 ID）
4. 等待其他设备扫描

**扫描二维码流程**：
1. 切换到"扫描二维码"标签页
2. 请求相机权限（如未授权）
3. 显示相机预览和扫描框
4. 扫描到二维码后：
   - 解析设备 ID
   - 关闭配对对话框
   - 弹出验证码输入对话框
   - 显示对方设备名称（从二维码数据中获取）
5. 用户输入 6 位验证码
6. 点击"确认"提交验证码
7. 验证成功：
   - 关闭对话框
   - 显示成功提示（Toast："配对成功"）
   - 设备列表自动更新
8. 验证失败：
   - 显示错误提示
   - 允许重新输入

**被扫描方流程**：
1. 其他设备扫描本机二维码
2. 生成 6 位随机验证码
3. 弹出验证码显示对话框
4. 显示验证码和对方设备名称
5. 等待对方输入验证码
6. 验证成功：
   - 自动关闭对话框
   - 显示成功提示（Toast："配对成功"）
   - 设备列表自动更新
7. 验证失败或超时：
   - 关闭对话框
   - 显示失败提示（Toast："配对失败"）

**相机权限处理**：
- **未授权状态**：
  - 显示权限请求提示
  - 文字："需要相机权限才能扫描二维码"
  - 按钮："去设置"（跳转到系统设置）
- **已拒绝状态**：
  - 显示权限被拒绝提示
  - 文字："相机权限已被拒绝，请在设置中开启"
  - 按钮："去设置"

### 6.3 验证码输入交互

**输入行为**：
- 自动聚焦第一个输入框
- 输入一位数字后自动跳转到下一个输入框
- 删除时自动跳转到上一个输入框
- 支持粘贴 6 位数字（自动分配到各输入框）
- 输入完成后自动聚焦"确认"按钮

**验证反馈**：
- 验证中：确认按钮显示加载动画，禁用输入
- 验证成功：对话框关闭，显示成功 Toast
- 验证失败：
  - 显示错误提示文字
  - 输入框边框变红色
  - 清空所有输入框
  - 聚焦第一个输入框
  - 允许重新输入

**超时处理**：
- 验证码有效期：5 分钟
- 超时后：
  - 自动关闭对话框
  - 显示超时提示（Toast："验证码已过期，请重新扫描"）

### 6.4 设备列表交互

**列表排序**：
- 在线设备优先显示
- 同状态设备按最后在线时间倒序排列
- 列表自动更新（设备状态变化时）

**时间显示格式**：
- 1 分钟内："刚刚"
- 1 小时内："{分钟} 分钟前"
- 24 小时内："{小时} 小时前"
- 7 天内："{天} 天前"
- 超过 7 天："yyyy-MM-dd HH:mm"

**列表更新动画**：
- 新设备添加：淡入 + 从上滑入动画
- 设备状态变化：徽章颜色过渡动画
- 动画时长：300ms

## 7. 边界情况与错误处理

### 7.1 数据边界

| 场景 | 约束 | 处理方式 |
|------|------|----------|
| 名称为空 | 不允许 | 保存按钮禁用 |
| 名称只有空格 | 不允许 | 保存按钮禁用 |
| 名称长度 > 32 | 不允许 | 输入框限制最大长度 |
| 名称包含特殊字符 | 允许 | 正常保存 |
| 名称重复 | 允许 | 正常保存（不同设备可同名） |
| 设备数量 = 0 | 允许 | 显示空状态 |
| 设备数量 > 100 | 允许 | 正常显示，列表可滚动 |
| 设备 ID 为空 | 不允许 | 不显示该设备 |
| lastSeen 为 null | 不允许 | 显示"未知" |
| 设备类型未知 | 允许 | 显示默认图标（laptop） |
| 验证码长度 ≠ 6 | 不允许 | 确认按钮禁用 |
| 验证码包含非数字 | 不允许 | 输入框只接受数字 |
| 验证码已过期 | 不允许 | 显示超时提示，关闭对话框 |
| 验证码错误次数 > 3 | 允许 | 显示错误提示，但不锁定 |
| 二维码数据格式错误 | 不允许 | 显示"无效的二维码" |
| 扫描自己的二维码 | 不允许 | 显示"不能配对自己" |
| 扫描已配对设备 | 允许 | 显示"设备已配对" |
| 二维码生成失败 | 不允许 | 显示错误提示 |

### 7.2 网络错误处理

| 错误类型 | 处理方式 |
|----------|----------|
| 网络超时 | Toast："网络超时，请重试" |
| 对方设备离线 | Toast："对方设备离线，无法配对" |
| 服务器错误 | Toast："配对失败，请稍后重试" |
| 未加入数据池 | Toast："请先加入数据池" |
| 设备列表加载失败 | 显示重试按钮 |
| 数据解析错误 | 显示空状态 |
| 权限错误 | 显示权限提示 |
| 名称修改失败 | Toast："保存失败，请重试" |

### 7.3 相机权限错误

| 状态 | 显示内容 |
|------|----------|
| 未请求 | 自动请求权限 |
| 已授权 | 显示相机预览 |
| 已拒绝 | 显示权限提示 + "去设置"按钮 |
| 永久拒绝 | 显示权限提示 + "去设置"按钮 |
| 相机初始化失败 | Toast："相机启动失败" |
| 相机占用中 | Toast："相机被其他应用占用" |
| 设备无相机 | 显示"设备不支持相机" |

### 7.4 状态管理

```dart
enum PageState {
  loading,      // 加载中
  loaded,       // 已加载
  error,        // 错误
  notInPool,    // 未加入数据池
}

enum PairingState {
  idle,             // 空闲
  scanning,         // 扫描中
  waitingVerify,    // 等待验证
  verifying,        // 验证中
  success,          // 成功
  failed,           // 失败
}

enum VerificationState {
  input,        // 输入中
  verifying,    // 验证中
  success,      // 验证成功
  failed,       // 验证失败
  expired,      // 已过期
}
```

### 7.5 性能约束

- 页面加载时间 < 500ms
- 设备列表渲染时间 < 200ms
- 二维码生成时间 < 100ms
- 相机启动时间 < 1000ms
- 验证码验证响应 < 2000ms
- 所有动画帧率 ≥ 60fps
- 列表滚动流畅，无卡顿
- 对话框打开/关闭动画流畅
- 设备列表最多缓存 1000 个设备
- 相机预览分辨率：720p
- 二维码图片大小 < 50KB


## 8. 测试用例

### 8.1 单元测试（8 个）

**UT-001: 测试 Device 模型创建**
- **输入**: id, name, type, status, lastSeen
- **预期**: Device 对象正确初始化，所有字段值正确

**UT-002: 测试设备类型枚举**
- **输入**: DeviceType.phone, DeviceType.laptop, DeviceType.tablet
- **预期**: 枚举值可正确比较和使用

**UT-003: 测试设备状态枚举**
- **输入**: DeviceStatus.online, DeviceStatus.offline
- **预期**: 枚举值可正确比较和使用

**UT-004: 测试 PairingRequest 模型创建**
- **输入**: requestId, deviceId, deviceName, deviceType, verificationCode, timestamp
- **预期**: PairingRequest 对象正确初始化

**UT-005: 测试验证码生成**
- **输入**: 无
- **预期**: 生成 6 位数字验证码，范围 000000-999999

**UT-006: 测试设备列表排序逻辑**
- **输入**: 混乱顺序的设备列表（在线/离线，不同时间）
- **预期**: 在线设备优先，同状态按时间倒序

**UT-007: 测试时间格式化**
- **输入**: 不同时间差（1分钟、1小时、1天、7天、30天）
- **预期**: 正确格式化为"刚刚"、"X分钟前"、"X小时前"、"X天前"、"yyyy-MM-dd HH:mm"

**UT-008: 测试设备名称验证**
- **输入**: 空字符串、空格、正常名称、超长名称
- **预期**: 
  - 空字符串和空格返回 false
  - 正常名称返回 true
  - 超长名称（>32字符）返回 false

### 8.2 Widget 测试（45 个）

#### 渲染测试（12 个）

**WT-001: 测试页面基本渲染**
- **输入**: hasJoinedPool = true
- **预期**: 正确渲染当前设备卡片、配对按钮、设备列表

**WT-002: 测试未加入数据池状态**
- **输入**: hasJoinedPool = false
- **预期**: 显示灰色遮罩和提示文字

**WT-003: 测试当前设备卡片渲染**
- **输入**: currentDevice
- **预期**: 显示设备图标、名称、"本机"标识、在线徽章、编辑按钮

**WT-004: 测试设备类型图标**
- **输入**: phone, laptop, tablet
- **预期**: 显示对应的图标

**WT-005: 测试空设备列表**
- **输入**: pairedDevices = []
- **预期**: 显示空状态图标和提示文字

**WT-006: 测试设备列表渲染**
- **输入**: pairedDevices = [device1, device2, device3]
- **预期**: 显示 3 个设备列表项

**WT-007: 测试在线设备徽章**
- **输入**: device.status = online
- **预期**: 显示绿色"在线"徽章

**WT-008: 测试离线设备徽章**
- **输入**: device.status = offline
- **预期**: 显示灰色"离线"徽章和最后在线时间

**WT-009: 测试配对按钮渲染**
- **预期**: 显示"配对设备"按钮和 Plus 图标

**WT-010: 测试设备列表标题**
- **输入**: pairedDevices.length = 5
- **预期**: 显示"已配对设备 (5)"

**WT-011: 测试当前设备特殊背景**
- **预期**: 当前设备卡片背景色为主题色 10% 透明度

**WT-012: 测试设备列表排序显示**
- **输入**: 混乱顺序的设备列表
- **预期**: 在线设备显示在前，离线设备在后

#### 交互测试（20 个）

**WT-013: 测试点击编辑按钮**
- **操作**: 点击当前设备的"编辑"按钮
- **预期**: 弹出编辑对话框

**WT-014: 测试编辑设备名称**
- **操作**: 输入新名称，点击"保存"
- **预期**: onDeviceNameChange 被调用，参数为新名称

**WT-015: 测试取消编辑**
- **操作**: 点击"取消"按钮
- **预期**: 对话框关闭，名称不变

**WT-016: 测试空名称保存禁用**
- **操作**: 清空名称输入框
- **预期**: "保存"按钮禁用

**WT-017: 测试点击配对按钮**
- **操作**: 点击"配对设备"按钮
- **预期**: 弹出配对对话框

**WT-018: 测试配对对话框默认标签页**
- **操作**: 打开配对对话框
- **预期**: 默认显示"显示二维码"标签页

**WT-019: 测试切换到扫描标签页**
- **操作**: 点击"扫描二维码"标签
- **预期**: 切换到扫描标签页，显示相机视图

**WT-020: 测试二维码显示**
- **操作**: 打开"显示二维码"标签页
- **预期**: 显示 240x240px 二维码和提示文字

**WT-021: 测试验证码输入框自动跳转**
- **操作**: 在第一个输入框输入数字
- **预期**: 自动聚焦到第二个输入框

**WT-022: 测试验证码删除跳转**
- **操作**: 在第二个输入框按删除键
- **预期**: 自动聚焦到第一个输入框

**WT-023: 测试验证码粘贴**
- **操作**: 粘贴"123456"
- **预期**: 6 个输入框自动填充 1,2,3,4,5,6

**WT-024: 测试验证码输入完成**
- **操作**: 输入 6 位数字
- **预期**: "确认"按钮变为可用状态

**WT-025: 测试验证码确认**
- **操作**: 输入验证码，点击"确认"
- **预期**: onPairDevice 被调用，参数为设备 ID 和验证码

**WT-026: 测试验证失败显示**
- **操作**: 输入错误验证码
- **预期**: 显示错误提示，输入框边框变红，清空输入

**WT-027: 测试关闭配对对话框**
- **操作**: 点击对话框外部或返回按钮
- **预期**: 对话框关闭

**WT-028: 测试验证码显示对话框**
- **输入**: 被扫描方收到配对请求
- **预期**: 弹出对话框，显示验证码和对方设备名称

**WT-029: 测试关闭验证码显示对话框**
- **操作**: 点击"关闭"按钮
- **预期**: 对话框关闭

**WT-030: 测试标签页切换动画**
- **操作**: 切换标签页
- **预期**: 执行平滑过渡动画

**WT-031: 测试设备列表滚动**
- **输入**: 20 个设备
- **操作**: 滚动列表
- **预期**: 列表流畅滚动

**WT-032: 测试编辑对话框自动聚焦**
- **操作**: 打开编辑对话框
- **预期**: 输入框自动聚焦，文字全选

#### 边界测试（13 个）

**WT-033: 测试设备名称最大长度**
- **操作**: 输入 33 个字符
- **预期**: 只接受前 32 个字符

**WT-034: 测试设备名称只有空格**
- **操作**: 输入"   "
- **预期**: "保存"按钮禁用

**WT-035: 测试空设备列表显示**
- **输入**: pairedDevices = []
- **预期**: 显示空状态

**WT-036: 测试大量设备列表**
- **输入**: pairedDevices = 100 个设备
- **预期**: 正常渲染，列表可滚动

**WT-037: 测试验证码只接受数字**
- **操作**: 输入字母"abc"
- **预期**: 输入框不接受，保持空白

**WT-038: 测试验证码长度不足**
- **操作**: 输入 5 位数字
- **预期**: "确认"按钮禁用

**WT-039: 测试未知设备类型**
- **输入**: device.type = null
- **预期**: 显示默认图标（laptop）

**WT-040: 测试 lastSeen 为 null**
- **输入**: device.lastSeen = null
- **预期**: 显示"未知"

**WT-041: 测试设备 ID 为空**
- **输入**: device.id = ""
- **预期**: 不显示该设备

**WT-042: 测试二维码生成失败**
- **输入**: 无效的设备 ID
- **预期**: 显示错误提示

**WT-043: 测试相机权限被拒绝**
- **输入**: 相机权限 = denied
- **预期**: 显示权限提示和"去设置"按钮

**WT-044: 测试网络错误**
- **输入**: 配对请求失败
- **预期**: 显示错误 Toast

**WT-045: 测试验证码过期**
- **输入**: 验证码超过 5 分钟
- **预期**: 显示超时提示，关闭对话框


## 9. 实现建议与技术细节

### 9.1 二维码数据格式

**二维码内容结构**（JSON 格式）：

```json
{
  "version": "1.0",
  "type": "pairing",
  "deviceId": "uuid-v7",
  "deviceName": "我的手机",
  "deviceType": "phone",
  "timestamp": 1234567890,
  "poolId": "pool-uuid"
}
```

**二维码生成**：
- 使用 `qr_flutter` 包生成二维码
- 错误纠正级别：Medium (M)
- 版本：自动选择
- 颜色：黑色前景，白色背景

**二维码扫描**：
- 使用 `mobile_scanner` 包扫描二维码
- 扫描成功后立即停止扫描
- 解析 JSON 数据并验证格式
- 验证时间戳（不超过 10 分钟）

### 9.2 验证码生成与验证

**验证码生成算法**：

```dart
String generateVerificationCode() {
  final random = Random.secure();
  final code = random.nextInt(1000000).toString().padLeft(6, '0');
  return code;
}
```

**验证码存储**：
- 使用内存缓存存储验证码
- 关联配对请求 ID
- 设置 5 分钟过期时间
- 验证成功或失败后立即删除

**验证码验证流程**：
1. 扫描方输入验证码
2. 发送验证请求到被扫描方
3. 被扫描方比对验证码
4. 返回验证结果
5. 双方更新设备列表

### 9.3 状态管理建议

**使用 Riverpod 管理状态**：

```dart
// 页面状态 Provider
final deviceManagerStateProvider = StateNotifierProvider<DeviceManagerNotifier, DeviceManagerState>((ref) {
  return DeviceManagerNotifier();
});

// 设备列表 Provider
final pairedDevicesProvider = StreamProvider<List<Device>>((ref) {
  return deviceRepository.watchPairedDevices();
});

// 当前设备 Provider
final currentDeviceProvider = StreamProvider<Device>((ref) {
  return deviceRepository.watchCurrentDevice();
});
```

**状态更新策略**：
- 使用 Stream 监听设备列表变化
- 自动更新 UI，无需手动刷新
- 配对成功后自动添加到列表
- 设备状态变化时自动更新徽章

### 9.4 性能优化

**列表优化**：
- 使用 `ListView.builder` 懒加载
- 设备列表项使用 `const` 构造函数
- 避免不必要的重建

**相机优化**：
- 切换到扫描标签页时才初始化相机
- 离开页面时释放相机资源
- 使用较低分辨率（720p）减少内存占用

**二维码优化**：
- 缓存生成的二维码图片
- 设备 ID 不变时复用缓存
- 使用 `RepaintBoundary` 隔离重绘

**动画优化**：
- 使用 `AnimatedSwitcher` 优化标签页切换
- 使用 `AnimatedList` 优化列表更新
- 避免复杂的嵌套动画

### 9.5 可访问性

**语义化标签**：
- 当前设备："当前设备，{设备名称}，本机，在线"
- 配对按钮："配对新设备"
- 设备列表项："{设备名称}，{设备类型}，{在线状态}"
- 编辑按钮："编辑设备名称"

**触摸目标**：
- 所有可点击元素最小触摸区域：48x48px
- 按钮内边距充足，易于点击
- 输入框高度至少 48px

**颜色对比度**：
- 文字与背景对比度 ≥ 4.5:1
- 图标与背景对比度 ≥ 3:1
- 支持深色模式

### 9.6 平台适配

**iOS 适配**：
- 使用 `CupertinoPageRoute` 页面过渡
- 遵循 iOS Human Interface Guidelines
- 使用 iOS 风格的对话框和按钮
- 处理安全区域（刘海、底部指示器）

**Android 适配**：
- 使用 `MaterialPageRoute` 页面过渡
- 遵循 Material Design 3 规范
- 使用 Android 风格的对话框和按钮
- 处理系统导航栏

**权限处理**：
- iOS：在 Info.plist 添加相机权限描述
- Android：在 AndroidManifest.xml 添加相机权限
- 运行时请求权限
- 处理权限被拒绝的情况

### 9.7 错误日志

**日志记录**：
- 配对请求发送/接收
- 验证码生成/验证
- 二维码扫描成功/失败
- 相机初始化成功/失败
- 网络请求成功/失败

**日志级别**：
- Debug：详细的调试信息
- Info：关键操作信息
- Warning：警告信息（权限被拒绝等）
- Error：错误信息（网络失败、验证失败等）

## 10. 后续工作

### 10.1 实现阶段
1. 实现数据模型和状态管理
2. 实现 UI 组件（从小到大）
3. 实现二维码生成和扫描
4. 实现验证码逻辑
5. 编写单元测试和 Widget 测试
6. 集成到主应用

### 10.2 测试阶段
1. 单元测试覆盖率 > 80%
2. Widget 测试覆盖所有交互
3. 真机测试（iOS + Android）
4. 边界情况测试
5. 性能测试

### 10.3 优化阶段
1. 性能优化（列表、相机、动画）
2. 可访问性优化
3. 多语言支持
4. 错误处理完善

## 11. 设计决策记录

### 11.1 为什么选择 6 位验证码？

**决策**：使用 6 位数字验证码进行配对验证

**理由**：
- 安全性：6 位数字提供 100 万种组合，足够安全
- 易用性：6 位数字易于记忆和输入
- 常见模式：符合常见验证码长度（银行、短信验证等）
- 平衡：在安全性和用户体验之间取得平衡

### 11.2 为什么扫描方输入验证码？

**决策**：扫描方输入验证码，被扫描方显示验证码

**理由**：
- 主动方验证：扫描方是主动发起配对的一方，应承担验证责任
- 安全性：被扫描方可以看到验证码，确保配对请求来自可信设备
- 用户体验：扫描方已经在操作设备，输入验证码更自然
- 防止误操作：被扫描方只需显示验证码，不需要额外操作

### 11.3 为什么验证码有效期是 5 分钟？

**决策**：验证码有效期设置为 5 分钟

**理由**：
- 安全性：5 分钟足够短，降低验证码被窃取的风险
- 易用性：5 分钟足够长，用户有充足时间完成配对
- 常见模式：符合常见验证码有效期（短信验证码通常 5-10 分钟）
- 平衡：在安全性和用户体验之间取得平衡

### 11.4 为什么使用两个标签页而不是两个按钮？

**决策**：使用标签页切换"显示二维码"和"扫描二维码"

**理由**：
- 空间利用：标签页可以在同一对话框中展示两种功能
- 视觉清晰：标签页明确区分两种配对方式
- 交互一致：符合移动端常见的标签页交互模式
- 减少层级：避免多层对话框嵌套

### 11.5 为什么设备列表按在线优先排序？

**决策**：设备列表按在线优先 + 最后在线时间倒序排列

**理由**：
- 用户需求：用户更关心当前在线的设备
- 操作效率：在线设备可以立即进行操作
- 视觉清晰：在线设备集中显示，易于查找
- 常见模式：符合常见的设备列表排序方式

## 12. 参考资料

- React UI 参考: `react_ui_reference/src/app/components/device-manager.tsx`
- Flutter 相机插件: https://pub.dev/packages/mobile_scanner
- Flutter 二维码生成: https://pub.dev/packages/qr_flutter
- Material Design 对话框: https://m3.material.io/components/dialogs/overview
- iOS Human Interface Guidelines: https://developer.apple.com/design/human-interface-guidelines/

---

**最后更新**: 2026-01-26
**作者**: CardMind Team

