# Note Card UI 设计规格

## 1. 设计概述

本文档定义 CardMind 应用中 note-card 组件的完整设计规格，包括视觉呈现、交互行为、平台差异和性能优化策略。

### 设计目标

- 提供清晰、一致的卡片展示体验
- 适配桌面端和移动端的交互习惯
- 优化性能，支持大量卡片的流畅渲染
- 确保可访问性和国际化支持

### 核心原则

- **内容优先**：卡片设计突出标题和内容预览
- **平台适配**：根据设备特性提供最佳交互方式
- **性能至上**：使用虚拟滚动和懒加载优化渲染
- **一致性**：保持与应用整体设计语言的统一

## 2. 卡片展示规范和平台差异

### 2.1 桌面端规范

#### 视觉布局

```
┌─────────────────────────────────────┐
│ 标题文本（单行，超出显示省略号）      │
│ ─────────────────────────────────── │
│ 内容预览第1行                        │
│ 内容预览第2行                        │
│ 内容预览第3行                        │
│ 内容预览第4行（超出显示省略号）      │
│ ─────────────────────────────────── │
│ 更新时间                             │
└─────────────────────────────────────┘
```

#### 展示规则

- **标题**：单行显示，超出部分显示省略号（`...`）
- **内容预览**：最多显示 4 行，超出部分显示省略号
- **时间显示**：右下角显示相对或绝对时间
- **卡片尺寸**：固定宽度，高度自适应内容

#### 交互效果

- **悬停效果**：鼠标悬停时显示轻微阴影和边框高亮
- **右键菜单**：支持右键点击打开上下文菜单
- **点击行为**：单击打开编辑对话框（模态窗口）
- **键盘导航**：支持 Tab 键聚焦，Enter 键打开，方向键切换

### 2.2 移动端规范

#### 视觉布局

```
┌─────────────────────────────────────┐
│ 标题文本（单行，超出显示省略号）      │
│ ─────────────────────────────────── │
│ 内容预览第1行                        │
│ 内容预览第2行                        │
│ 内容预览第3行（超出显示省略号）      │
│ ─────────────────────────────────── │
│ 更新时间                             │
└─────────────────────────────────────┘
```

#### 展示规则

- **标题**：单行显示，超出部分显示省略号
- **内容预览**：最多显示 3 行（比桌面端少 1 行）
- **时间显示**：右下角显示相对或绝对时间
- **卡片尺寸**：全宽布局，适配屏幕宽度

#### 交互效果

- **点击行为**：单击打开全屏编辑器
- **长按菜单**：长按 500ms 触发上下文菜单
- **触觉反馈**：长按时提供震动反馈（如设备支持）
- **滑动手势**：支持左滑删除、右滑分享（可选）

### 2.3 平台差异对比表

| 特性 | 桌面端 | 移动端 |
|------|--------|--------|
| 内容预览行数 | 4 行 | 3 行 |
| 主要交互 | 单击 | 单击 |
| 上下文菜单触发 | 右键 | 长按（500ms） |
| 编辑器类型 | 模态对话框 | 全屏编辑器 |
| 悬停效果 | 支持 | 不支持 |
| 触觉反馈 | 不支持 | 支持 |
| 键盘导航 | 支持 | 不支持 |
| 滑动手势 | 不支持 | 支持（可选） |

## 3. 交互行为和上下文菜单

### 3.1 点击行为

#### 桌面端

- **单击卡片**：打开编辑对话框（模态窗口）
  - 对话框居中显示，背景半透明遮罩
  - 显示完整标题和内容
  - 提供编辑、保存、取消按钮
  - 支持 ESC 键关闭

- **双击卡片**：无特殊行为（与单击相同）

- **中键点击**：无特殊行为

#### 移动端

- **单击卡片**：打开全屏编辑器
  - 全屏显示，顶部显示导航栏
  - 显示完整标题和内容
  - 提供保存、取消按钮
  - 支持返回手势关闭

- **双击卡片**：无特殊行为（与单击相同）

### 3.2 上下文菜单

#### 桌面端菜单项

1. **编辑**（Edit）
   - 图标：✏️ 编辑图标
   - 快捷键：Enter
   - 行为：打开编辑对话框

2. **删除**（Delete）
   - 图标：🗑️ 删除图标
   - 快捷键：Delete
   - 行为：显示确认对话框，确认后删除卡片

3. **查看详情**（View Details）
   - 图标：ℹ️ 信息图标
   - 快捷键：Ctrl+I
   - 行为：打开详情面板，显示完整元数据

4. **复制内容**（Copy Content）
   - 图标：📋 复制图标
   - 快捷键：Ctrl+C
   - 行为：复制卡片内容到剪贴板

#### 移动端菜单项

1. **编辑**（Edit）
   - 图标：✏️ 编辑图标
   - 行为：打开全屏编辑器

2. **删除**（Delete）
   - 图标：🗑️ 删除图标
   - 行为：显示确认对话框，确认后删除卡片

3. **分享**（Share）
   - 图标：📤 分享图标
   - 行为：打开系统分享面板

4. **复制内容**（Copy Content）
   - 图标：📋 复制图标
   - 行为：复制卡片内容到剪贴板

### 3.3 菜单触发方式

#### 桌面端

- **右键点击**：在卡片任意位置右键点击
- **键盘触发**：聚焦卡片后按 Menu 键或 Shift+F10
- **菜单位置**：鼠标位置附近，自动调整避免超出屏幕

#### 移动端

- **长按触发**：长按卡片 500ms
- **触觉反馈**：触发时提供震动反馈（如设备支持）
- **菜单位置**：底部弹出式菜单（Bottom Sheet）

## 4. 时间显示规则和边界条件

### 4.1 相对时间显示（24小时内）

| 时间差 | 显示文本 | 示例 |
|--------|----------|------|
| 0-10 秒 | "刚刚" | 刚刚 |
| 11-59 秒 | "X秒前" | 30秒前 |
| 1-59 分钟 | "X分钟前" | 15分钟前 |
| 1-23 小时 | "X小时前" | 3小时前 |

#### 实现规则

```rust
fn format_relative_time(seconds_ago: i64) -> String {
    match seconds_ago {
        0..=10 => "刚刚".to_string(),
        11..=59 => format!("{}秒前", seconds_ago),
        60..=3599 => format!("{}分钟前", seconds_ago / 60),
        3600..=86399 => format!("{}小时前", seconds_ago / 3600),
        _ => format_absolute_time(seconds_ago),
    }
}
```

### 4.2 绝对时间显示（超过24小时）

| 时间范围 | 显示格式 | 示例 |
|----------|----------|------|
| 当年 | MM-DD HH:mm | 01-20 14:30 |
| 往年 | YYYY-MM-DD HH:mm | 2025-12-25 09:15 |

#### 实现规则

```rust
fn format_absolute_time(timestamp: i64) -> String {
    let now = Utc::now();
    let time = DateTime::<Utc>::from_timestamp(timestamp, 0).unwrap();

    if now.year() == time.year() {
        time.format("%m-%d %H:%M").to_string()
    } else {
        time.format("%Y-%m-%d %H:%M").to_string()
    }
}
```

### 4.3 边界条件处理

#### 空卡片占位文本

- **标题为空**：显示 "无标题"（灰色文本）
- **内容为空**：显示 "点击添加内容..."（灰色占位文本）
- **时间为空**：显示 "未知时间"（不应出现，数据异常）

#### 时区处理

- 所有时间戳使用 UTC 存储
- 显示时转换为用户本地时区
- 跨时区同步时保持时间一致性

#### 特殊情况

- **未来时间**：如果 `updatedAt` 在未来（时钟偏差），显示 "刚刚"
- **过早时间**：如果 `updatedAt` 早于 1970-01-01，显示 "未知时间"
- **无效时间**：如果时间戳无法解析，显示 "未知时间"

### 4.4 时间更新策略

- **相对时间**：每 60 秒更新一次显示
- **绝对时间**：不需要自动更新
- **性能优化**：使用定时器批量更新可见卡片的时间显示

## 5. 性能优化和测试用例

### 5.1 性能优化策略

#### 虚拟滚动

- 使用 `flutter_staggered_grid_view` 或 `ListView.builder`
- 仅渲染可见区域的卡片
- 支持动态高度计算

#### 懒加载

- 分页加载卡片数据（每页 20-50 张）
- 滚动到底部时自动加载下一页
- 显示加载指示器

#### 缓存策略

- 缓存已渲染卡片的布局信息
- 缓存时间格式化结果（60秒内复用）
- 使用 `RepaintBoundary` 隔离重绘区域

#### 图片优化

- 如果卡片包含图片，使用缩略图
- 懒加载图片，滚动时延迟加载
- 使用占位符避免布局抖动

### 5.2 测试用例定义

#### 5.2.1 单元测试（8个）

1. **时间格式化测试**
   - 测试相对时间显示（刚刚、X秒前、X分钟前、X小时前）
   - 测试绝对时间显示（当年、往年）
   - 测试边界条件（未来时间、过早时间、无效时间）

2. **文本截断测试**
   - 测试标题单行截断
   - 测试内容多行截断（桌面端4行、移动端3行）
   - 测试空文本占位符

3. **数据模型测试**
   - 测试 Card 模型字段映射
   - 测试空字段处理
   - 测试数据序列化/反序列化

#### 5.2.2 Widget 测试（35个）

**基础渲染测试（8个）**

1. 测试卡片基本渲染（标题、内容、时间）
2. 测试空标题显示 "无标题"
3. 测试空内容显示占位文本
4. 测试长标题截断显示省略号
5. 测试长内容截断显示省略号
6. 测试桌面端显示4行内容
7. 测试移动端显示3行内容
8. 测试时间显示格式正确

**交互行为测试（12个）**

9. 测试桌面端单击打开编辑对话框
10. 测试移动端单击打开全屏编辑器
11. 测试桌面端右键打开上下文菜单
12. 测试移动端长按打开上下文菜单
13. 测试桌面端悬停显示高亮效果
14. 测试移动端长按触发触觉反馈
15. 测试键盘 Tab 键聚焦卡片
16. 测试键盘 Enter 键打开编辑器
17. 测试键盘方向键切换卡片
18. 测试 ESC 键关闭编辑对话框
19. 测试移动端返回手势关闭编辑器
20. 测试滑动手势（如实现）

**上下文菜单测试（8个）**

21. 测试桌面端菜单显示4个选项（编辑、删除、查看详情、复制内容）
22. 测试移动端菜单显示4个选项（编辑、删除、分享、复制内容）
23. 测试菜单"编辑"选项打开编辑器
24. 测试菜单"删除"选项显示确认对话框
25. 测试确认删除后卡片消失
26. 测试取消删除后卡片保留
27. 测试"复制内容"选项复制到剪贴板
28. 测试"分享"选项打开系统分享面板（移动端）

**时间显示测试（7个）**

29. 测试"刚刚"显示（0-10秒）
30. 测试"X秒前"显示（11-59秒）
31. 测试"X分钟前"显示（1-59分钟）
32. 测试"X小时前"显示（1-23小时）
33. 测试当年绝对时间显示（MM-DD HH:mm）
34. 测试往年绝对时间显示（YYYY-MM-DD HH:mm）
35. 测试时间自动更新（60秒后更新显示）

### 5.3 性能基准测试

- **渲染性能**：1000张卡片列表滚动帧率 ≥ 60 FPS
- **内存占用**：1000张卡片内存占用 ≤ 100 MB
- **加载时间**：首屏20张卡片加载时间 ≤ 500ms
- **交互响应**：点击到打开编辑器延迟 ≤ 100ms

## 6. 实现文件结构和验收标准

### 6.1 文件结构

```
lib/
├── widgets/
│   ├── note_card.dart              # 卡片组件主文件
│   ├── note_card_desktop.dart      # 桌面端特定实现
│   ├── note_card_mobile.dart       # 移动端特定实现
│   └── note_card_context_menu.dart # 上下文菜单组件
├── utils/
│   ├── time_formatter.dart         # 时间格式化工具
│   └── text_truncator.dart         # 文本截断工具
├── models/
│   └── card.dart                   # Card 数据模型（Dart 侧）
└── screens/
    ├── card_edit_dialog.dart       # 桌面端编辑对话框
    └── card_edit_screen.dart       # 移动端全屏编辑器

test/
├── unit/
│   ├── time_formatter_test.dart    # 时间格式化单元测试
│   ├── text_truncator_test.dart    # 文本截断单元测试
│   └── card_model_test.dart        # 数据模型单元测试
└── widget/
    ├── note_card_test.dart         # 卡片组件 Widget 测试
    ├── note_card_interaction_test.dart  # 交互行为测试
    ├── note_card_context_menu_test.dart # 上下文菜单测试
    └── note_card_time_display_test.dart # 时间显示测试
```

### 6.2 验收标准

#### 功能完整性

- [ ] 桌面端和移动端卡片正确渲染
- [ ] 所有交互行为按规格实现
- [ ] 上下文菜单功能完整
- [ ] 时间显示规则正确
- [ ] 边界条件处理完善

#### 测试覆盖率

- [ ] 单元测试覆盖率 ≥ 90%
- [ ] Widget 测试覆盖率 ≥ 80%
- [ ] 所有 43 个测试用例通过
- [ ] 性能基准测试达标

#### 代码质量

- [ ] 代码符合 Flutter 最佳实践
- [ ] 通过 `flutter analyze` 静态分析
- [ ] 通过 `dart format` 格式检查
- [ ] 代码注释完整，文档清晰

#### 用户体验

- [ ] 桌面端和移动端交互流畅
- [ ] 无明显卡顿或延迟
- [ ] 视觉效果符合设计规范
- [ ] 支持无障碍访问（Accessibility）

## 7. 数据模型和设计决策

### 7.1 数据模型

#### Rust 侧模型（rust/src/models/card.rs）

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Card {
    pub id: String,
    pub title: String,
    pub content: String,
    pub tags: Vec<String>,
    pub created_at: i64,
    pub updated_at: i64,
    pub last_edit_device: String,
}
```

#### Dart 侧模型（lib/models/card.dart）

```dart
class Card {
  final String id;
  final String title;
  final String content;
  final List<String> tags;
  final int createdAt;
  final int updatedAt;
  final String lastEditDevice;

  Card({
    required this.id,
    required this.title,
    required this.content,
    required this.tags,
    required this.createdAt,
    required this.updatedAt,
    required this.lastEditDevice,
  });

  factory Card.fromJson(Map<String, dynamic> json) {
    return Card(
      id: json['id'] as String,
      title: json['title'] as String,
      content: json['content'] as String,
      tags: List<String>.from(json['tags'] as List),
      createdAt: json['created_at'] as int,
      updatedAt: json['updated_at'] as int,
      lastEditDevice: json['last_edit_device'] as String,
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'title': title,
      'content': content,
      'tags': tags,
      'created_at': createdAt,
      'updated_at': updatedAt,
      'last_edit_device': lastEditDevice,
    };
  }
}
```

### 7.2 显示字段映射

#### 卡片显示字段

| 字段 | 数据源 | 显示位置 | 格式化规则 |
|------|--------|----------|-----------|
| 标题 | `title` | 卡片顶部 | 单行截断 |
| 内容预览 | `content` | 卡片中部 | 多行截断（桌面4行/移动3行） |
| 更新时间 | `updated_at` | 卡片底部 | 相对/绝对时间格式 |

#### 不显示字段

- `tags`：标签不在卡片上显示，仅用于筛选和搜索
- `last_edit_device`：最后编辑设备不在卡片上显示，仅用于同步冲突解决
- `created_at`：创建时间不在卡片上显示，仅显示更新时间

### 7.3 设计决策

#### 为什么复用现有 Card 模型？

1. **避免重复**：不需要为 UI 层创建新的数据结构
2. **类型安全**：Rust 和 Dart 模型保持一致，减少序列化错误
3. **简化维护**：模型变更时只需修改一处

#### 为什么只显示 `updated_at`？

1. **用户关注点**：用户更关心卡片最后修改时间，而非创建时间
2. **空间限制**：卡片空间有限，只显示最重要的时间信息
3. **一致性**：与主流笔记应用（Notion、Evernote）保持一致

#### 为什么桌面端4行、移动端3行？

1. **屏幕尺寸**：桌面端屏幕更大，可以显示更多内容
2. **信息密度**：移动端需要更紧凑的布局，避免滚动过多
3. **用户测试**：经过用户测试，这个比例最符合使用习惯

#### 为什么使用相对时间？

1. **可读性**：相对时间（"3小时前"）比绝对时间（"01-25 14:30"）更直观
2. **上下文感知**：用户更关心"多久之前修改"而非"具体时间点"
3. **行业标准**：社交媒体和协作工具普遍使用相对时间

#### 为什么桌面端用对话框、移动端用全屏？

1. **平台习惯**：桌面端用户习惯模态对话框，移动端用户习惯全屏编辑
2. **屏幕利用**：移动端屏幕小，全屏编辑提供更大的编辑空间
3. **导航模式**：桌面端支持多窗口，移动端依赖导航栈

## 8. 国际化和可访问性

### 8.1 国际化支持

#### 文本资源

所有用户可见文本需要支持国际化：

```dart
// lib/l10n/app_zh.arb
{
  "noteCard_noTitle": "无标题",
  "noteCard_emptyContent": "点击添加内容...",
  "noteCard_unknownTime": "未知时间",
  "noteCard_justNow": "刚刚",
  "noteCard_secondsAgo": "{seconds}秒前",
  "noteCard_minutesAgo": "{minutes}分钟前",
  "noteCard_hoursAgo": "{hours}小时前",
  "noteCard_edit": "编辑",
  "noteCard_delete": "删除",
  "noteCard_viewDetails": "查看详情",
  "noteCard_copyContent": "复制内容",
  "noteCard_share": "分享",
  "noteCard_deleteConfirm": "确定要删除这张卡片吗？",
  "noteCard_deleteSuccess": "卡片已删除",
  "noteCard_copySuccess": "内容已复制到剪贴板"
}
```

#### 时间格式本地化

- 使用 `intl` 包处理日期时间格式
- 根据用户语言环境自动调整格式
- 支持 12/24 小时制切换

### 8.2 可访问性（Accessibility）

#### 语义标签

- 为卡片添加 `Semantics` 标签
- 标题和内容提供语义描述
- 时间信息提供可读的语义文本

#### 键盘导航

- 支持 Tab 键聚焦卡片
- 支持 Enter 键打开编辑器
- 支持方向键在卡片间切换
- 支持 ESC 键关闭对话框

#### 屏幕阅读器

- 卡片内容可被屏幕阅读器正确读取
- 按钮和菜单项提供清晰的语音提示
- 状态变化（如删除成功）提供语音反馈

#### 对比度和字体

- 文本与背景对比度 ≥ 4.5:1（WCAG AA 标准）
- 支持系统字体缩放
- 支持深色模式

## 9. 未来扩展

### 9.1 计划中的功能

- **标签显示**：在卡片底部显示标签（可选）
- **图片预览**：如果内容包含图片，显示缩略图
- **拖拽排序**：支持拖拽卡片重新排序
- **批量操作**：支持多选卡片进行批量删除/移动
- **卡片主题**：支持自定义卡片颜色和样式

### 9.2 性能优化方向

- **增量渲染**：仅重绘变化的卡片
- **Web Worker**：使用 Web Worker 处理大量数据
- **索引优化**：使用数据库索引加速查询
- **预加载**：预测用户行为，提前加载数据

### 9.3 平台扩展

- **Web 端**：适配 Web 平台的交互方式
- **平板端**：优化平板电脑的布局和交互
- **可穿戴设备**：探索智能手表等设备的卡片展示

## 10. 参考资料

### 设计参考

- [Material Design - Cards](https://m3.material.io/components/cards)
- [Apple Human Interface Guidelines - Cards](https://developer.apple.com/design/human-interface-guidelines/cards)
- [Notion - Card View](https://www.notion.so/)
- [Evernote - Note List](https://evernote.com/)

### 技术参考

- [Flutter - ListView.builder](https://api.flutter.dev/flutter/widgets/ListView/ListView.builder.html)
- [Flutter - GestureDetector](https://api.flutter.dev/flutter/widgets/GestureDetector-class.html)
- [Flutter - Semantics](https://api.flutter.dev/flutter/widgets/Semantics-class.html)
- [intl Package](https://pub.dev/packages/intl)

---

**文档版本**：1.0
**创建日期**：2026-01-25
**最后更新**：2026-01-25
**维护者**：CardMind 开发团队
