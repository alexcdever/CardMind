# CardMind 开发路线图

## 概述

本路线图规划了CardMind从零到完整产品的开发计划，采用TDD驱动的渐进式开发策略。

## 开发原则

- **TDD优先**: 先写测试，再写实现
- **价值优先**: 优先实现核心价值功能
- **快速迭代**: 小步快跑，快速验证
- **质量保证**: 每个阶段都要有完整的测试覆盖（>80%）

---

## Phase 0: 准备阶段 ✅

**目标**: 完成项目规划和文档编写

### 已完成
- [x] 需求分析和确认
- [x] 编写产品需求文档（PRD）
- [x] 编写技术架构设计文档
- [x] 编写数据库设计文档
- [x] 编写开发路线图

### 交付物
- [README.md](../README.md)
- [PRD.md](PRD.md)
- [ARCHITECTURE.md](ARCHITECTURE.md)
- [DATABASE.md](DATABASE.md)
- [ROADMAP.md](ROADMAP.md) (本文档)

---

## Phase 1: 项目初始化（2-3天）

**目标**: 搭建基础项目框架，验证技术栈可行性

### 1.1 环境配置
- [ ] 安装Flutter 3.x SDK
- [ ] 安装Rust工具链
- [ ] 安装flutter_rust_bridge_codegen
- [ ] 配置IDE（VS Code/Android Studio）
- [ ] 配置Git仓库和.gitignore

### 1.2 项目搭建
- [ ] 创建Flutter项目
- [ ] 配置Rust库项目结构
- [ ] 集成flutter_rust_bridge
- [ ] 配置代码生成脚本（generate_bridge.sh）
- [ ] 测试Dart-Rust互调（Hello World）

### 1.3 Loro集成验证
- [ ] 添加Loro依赖到Cargo.toml
- [ ] 编写Loro基础操作测试（TDD）
  - [ ] 测试：创建LoroDoc
  - [ ] 测试：插入数据到LoroMap
  - [ ] 测试：导出和导入快照
  - [ ] 测试：订阅机制
- [ ] 实现Loro基础封装
- [ ] 验证Loro文件持久化

### 1.4 SQLite集成
- [ ] 添加rusqlite依赖
- [ ] 创建cards表（TDD）
  - [ ] 测试：表创建
  - [ ] 测试：CRUD操作
- [ ] 配置SQLite优化参数
- [ ] 实现初始化脚本

### 1.5 基础架构
- [ ] 实现CardStore结构体
- [ ] 实现Loro到SQLite订阅机制（TDD）
  - [ ] 测试：订阅触发
  - [ ] 测试：数据同步正确性
- [ ] 配置日志系统（tracing）
- [ ] 实现错误处理框架（thiserror）

### 交付标准
- ✅ Flutter能成功运行
- ✅ Rust代码能被Flutter调用
- ✅ Loro能正常工作并持久化
- ✅ SQLite能正常创建和连接
- ✅ Loro订阅能自动同步到SQLite
- ✅ 测试覆盖率 > 80%

---

## Phase 2: 核心功能 - 卡片CRUD（1周）

**目标**: 实现卡片的创建、读取、更新、删除功能（TDD驱动）

### 2.1 Rust后端实现（TDD）

#### 测试先行（Red）
```rust
// tests/card_store_test.rs

#[test]
fn test_create_card() {
    let mut store = CardStore::new_in_memory().unwrap();
    let card = store.create_card("标题", "内容").unwrap();

    assert_eq!(card.title, "标题");
    assert_eq!(card.content, "内容");
    assert!(card.id.len() > 0);
}

#[test]
fn test_get_all_cards() {
    // 先写测试
}

#[test]
fn test_update_card() {
    // 先写测试
}

#[test]
fn test_delete_card() {
    // 先写测试
}

#[test]
fn test_loro_sqlite_sync() {
    // 测试Loro和SQLite同步
}
```

#### 实现（Green）
- [ ] 实现Card数据模型
- [ ] 实现create_card方法
- [ ] 实现get_all_cards方法
- [ ] 实现get_card方法
- [ ] 实现update_card方法
- [ ] 实现delete_card方法
- [ ] 验证Loro订阅正确同步到SQLite

#### 重构（Refactor）
- [ ] 代码优化和重构
- [ ] 提取公共逻辑
- [ ] 改进错误处理

### 2.2 API层实现
- [ ] 实现Flutter API接口（api/card.rs）
  - [ ] create_card_api
  - [ ] get_all_cards_api
  - [ ] get_card_api
  - [ ] update_card_api
  - [ ] delete_card_api
- [ ] 生成桥接代码
- [ ] 测试Flutter调用

### 2.3 Flutter前端实现

#### 数据层
- [ ] 实现Card数据模型（Dart）
- [ ] 实现CardService封装Rust API
- [ ] 测试Service层

#### 状态管理
- [ ] 实现CardProvider（Provider）
- [ ] 测试Provider状态更新

#### UI实现 - 卡片列表
- [ ] 创建主页面（HomeScreen）
- [ ] 实现卡片列表（ListView.builder）
- [ ] 实现空状态提示
- [ ] 实现卡片预览组件
- [ ] Widget测试

#### UI实现 - 卡片编辑
- [ ] 创建卡片编辑页面
- [ ] 实现标题输入框
- [ ] 实现内容输入框（Markdown）
- [ ] 实现Markdown工具栏
- [ ] 实现实时预览切换
- [ ] 实现自动保存指示器
- [ ] Widget测试

#### UI实现 - 卡片详情
- [ ] 创建卡片详情页面
- [ ] 实现Markdown渲染
- [ ] 实现编辑按钮
- [ ] 实现删除按钮（带确认）
- [ ] 显示创建/修改时间
- [ ] Widget测试

### 交付标准
- ✅ 能创建新卡片并保存
- ✅ 能查看卡片列表
- ✅ 能查看卡片详情
- ✅ 能编辑已有卡片
- ✅ 能删除卡片
- ✅ Markdown格式正确渲染
- ✅ 数据持久化正常（Loro文件）
- ✅ SQLite缓存正确同步
- ✅ 单元测试覆盖率 > 80%
- ✅ Widget测试覆盖主要UI组件

### 测试场景
- [ ] 创建包含各种Markdown格式的卡片
- [ ] 编辑卡片并保存
- [ ] 删除卡片
- [ ] 应用重启后数据仍然存在
- [ ] 创建100张卡片测试性能
- [ ] SQLite和Loro数据一致性

---

## Phase 3: UI/UX优化（2-3天）

**目标**: 完善用户界面和体验

### 3.1 主题系统
- [ ] 实现浅色主题
- [ ] 实现深色主题
- [ ] 实现主题切换
- [ ] 保存主题偏好（SharedPreferences）
- [ ] ThemeProvider测试

### 3.2 设置页面
- [ ] 创建设置页面
- [ ] 添加主题切换选项
- [ ] 添加关于页面
- [ ] 添加版本信息
- [ ] 数据管理入口（预留）

### 3.3 响应式设计
- [ ] 适配不同屏幕尺寸
- [ ] 支持横屏布局
- [ ] 平板优化（大屏）
- [ ] 桌面端优化

### 3.4 交互优化
- [ ] 添加加载状态指示
- [ ] 添加错误提示（SnackBar）
- [ ] 添加成功提示
- [ ] 优化触摸区域
- [ ] 添加空状态插图
- [ ] 添加页面切换动画
- [ ] 添加卡片操作手势（滑动删除等）

### 3.5 性能优化
- [ ] 列表虚拟化优化
- [ ] Markdown渲染缓存
- [ ] 图片懒加载（如果支持图片）

### 交付标准
- ✅ 深色模式完美支持
- ✅ 在各种屏幕尺寸下表现良好
- ✅ 交互流畅，反馈及时
- ✅ 符合Material Design规范
- ✅ 动画自然流畅

---

## Phase 4: MVP发布（1-2天）

**目标**: 完成MVP版本的测试和发布

### 4.1 全面测试
- [ ] 功能测试（所有功能验证）
- [ ] 性能测试
  - [ ] 1000张卡片加载时间 < 1秒
  - [ ] Loro操作 < 50ms
  - [ ] SQLite查询 < 10ms
- [ ] 兼容性测试（多平台）
- [ ] 用户体验测试

### 4.2 文档完善
- [ ] 编写用户使用手册
- [ ] 更新README.md
- [ ] 编写CHANGELOG.md
- [ ] API文档（rustdoc）

### 4.3 打包发布
- [ ] Android APK打包
- [ ] iOS TestFlight发布（可选）
- [ ] Windows MSIX打包
- [ ] macOS DMG打包
- [ ] Linux AppImage打包

### 4.4 发布准备
- [ ] 创建应用图标
- [ ] 准备应用商店截图
- [ ] 编写应用描述
- [ ] 设置版本号（v1.0.0）

### 交付标准
- ✅ 所有功能正常工作
- ✅ 无严重bug
- ✅ 性能达标
- ✅ 测试覆盖率 > 80%
- ✅ 可在目标平台正常安装运行

---

## Phase 5: P2P同步准备（1周）

**目标**: 研究和验证P2P同步技术

### 5.1 技术调研
- [ ] 深入研究libp2p
- [ ] 研究Loro的P2P同步能力
- [ ] 评估NAT穿透方案
- [ ] 设计同步协议

### 5.2 原型验证（TDD）
- [ ] 测试：libp2p基础连接
- [ ] 测试：设备发现（mDNS）
- [ ] 测试：Loro更新导出/导入
- [ ] 测试：两设备间同步
- [ ] 实现原型代码

### 5.3 设计文档
- [ ] 编写P2P同步设计文档
- [ ] 编写同步协议文档
- [ ] 更新架构文档

---

## Phase 6: P2P同步实现（2-3周）

**目标**: 实现可靠的P2P多设备同步

### 6.1 libp2p集成（TDD）
- [ ] 测试：创建libp2p节点
- [ ] 测试：mDNS设备发现
- [ ] 测试：建立P2P连接
- [ ] 测试：数据传输
- [ ] 实现SyncEngine

### 6.2 同步协议实现（TDD）
- [ ] 测试：Loro增量更新导出
- [ ] 测试：Loro增量更新导入
- [ ] 测试：版本向量管理
- [ ] 测试：冲突自动解决
- [ ] 实现同步逻辑

### 6.3 前端集成
- [ ] 实现同步状态显示
- [ ] 实现设备列表显示
- [ ] 实现手动同步触发
- [ ] 实现自动同步
- [ ] 实现同步设置界面

### 6.4 错误处理
- [ ] 网络断开恢复
- [ ] 同步失败重试
- [ ] 数据完整性校验

### 交付标准
- ✅ 能在多设备间可靠同步
- ✅ 支持离线编辑
- ✅ 冲突能自动解决
- ✅ 同步状态清晰可见
- ✅ 数据不丢失
- ✅ 测试覆盖率 > 80%

---

## Phase 7: 搜索功能（3-4天）

**目标**: 实现全文搜索功能

### 7.1 后端实现（TDD）
- [ ] 测试：创建FTS5表
- [ ] 测试：触发器自动同步
- [ ] 测试：全文搜索
- [ ] 测试：搜索结果排序
- [ ] 实现搜索API

### 7.2 前端实现
- [ ] 添加搜索栏
- [ ] 实现实时搜索
- [ ] 实现搜索结果高亮
- [ ] 实现搜索历史（可选）
- [ ] 搜索性能优化

### 交付标准
- ✅ 搜索响应快速（<100ms）
- ✅ 搜索结果准确
- ✅ 支持中英文搜索
- ✅ 搜索体验流畅

---

## Phase 8: 标签系统（可选，1周）

**目标**: 实现卡片标签功能

### 8.1 数据层（TDD）
- [ ] 在Loro中添加标签支持
- [ ] 在SQLite中添加标签表
- [ ] 实现标签CRUD
- [ ] 实现卡片标签关联

### 8.2 前端实现
- [ ] 标签管理界面
- [ ] 卡片编辑页添加标签选择
- [ ] 按标签筛选卡片
- [ ] 标签可视化（颜色标记）

---

## Phase 9: 数据导入导出（2-3天）

**目标**: 实现数据备份和迁移

### 9.1 导出功能（TDD）
- [ ] 测试：导出Loro文档为ZIP
- [ ] 测试：元数据正确性
- [ ] 实现导出API
- [ ] 实现Flutter UI

### 9.2 导入功能（TDD）
- [ ] 测试：从ZIP导入Loro文档
- [ ] 测试：SQLite正确重建
- [ ] 实现导入API
- [ ] 实现Flutter UI

### 9.3 自动备份
- [ ] 定期自动备份
- [ ] 备份管理（保留N个最新备份）

---

## Phase 10: 持续优化

**目标**: 性能优化和用户体验改进

### 10.1 性能优化
- [ ] Loro文档compact优化
- [ ] SQLite查询优化
- [ ] UI渲染优化
- [ ] 内存使用优化
- [ ] 启动时间优化

### 10.2 用户反馈
- [ ] 收集用户反馈
- [ ] 修复已知bug
- [ ] 改进用户体验

### 10.3 国际化（可选）
- [ ] 提取文本到资源文件
- [ ] 添加英文翻译
- [ ] 添加其他语言支持

---

## 版本规划

### v1.0.0 - MVP版本
**包含**: Phase 1-4
- ✅ 卡片CRUD
- ✅ Markdown支持
- ✅ Loro CRDT本地存储
- ✅ SQLite缓存层
- ✅ 基础UI/UX

**预计完成**: Phase 4完成后（约2-3周）

### v2.0.0 - P2P同步版本
**包含**: Phase 5-6
- ✅ libp2p P2P同步
- ✅ 设备发现
- ✅ 离线编辑支持
- ✅ 自动冲突解决

**预计完成**: Phase 6完成后（再3-4周）

### v2.1.0 - 搜索和标签版本
**包含**: Phase 7-8
- ✅ 全文搜索
- ✅ 标签系统（可选）

**预计完成**: Phase 8完成后（再1-2周）

### v2.2.0 - 完整版本
**包含**: Phase 9
- ✅ 数据导入导出
- ✅ 自动备份

**预计完成**: Phase 9完成后

---

## 开发时间估算

基于单人开发，每天投入4-6小时的情况：

| 阶段 | 预计时间 | 说明 |
|------|---------|------|
| Phase 0 | ✅ 已完成 | 文档编写 |
| Phase 1 | 2-3天 | 项目初始化 |
| Phase 2 | 5-7天 | 卡片CRUD（TDD） |
| Phase 3 | 2-3天 | UI/UX优化 |
| Phase 4 | 1-2天 | 测试发布 |
| **MVP总计** | **2-3周** | v1.0.0 |
| Phase 5 | 5-7天 | P2P调研验证 |
| Phase 6 | 10-15天 | P2P实现 |
| **v2.0总计** | **3-4周** | v2.0.0 |
| Phase 7 | 3-4天 | 搜索功能 |
| Phase 8 | 5-7天 | 标签系统（可选） |
| Phase 9 | 2-3天 | 导入导出 |
| **完整版总计** | **约2-3个月** | 所有功能 |

---

## TDD开发流程示例

### Red-Green-Refactor循环

```rust
// 1. Red - 写一个失败的测试
#[test]
fn test_create_card_with_uuid_v7() {
    let mut store = CardStore::new_in_memory().unwrap();
    let card = store.create_card("标题", "内容").unwrap();

    // 验证ID是UUID v7格式（时间排序）
    assert!(is_uuid_v7(&card.id));

    // 验证时间戳
    let id_timestamp = extract_timestamp_from_uuid_v7(&card.id);
    assert!((id_timestamp - card.created_at).abs() < 1000);
}

// 2. Green - 写最少的代码让测试通过
pub fn create_card(&mut self, title: &str, content: &str) -> Result<Card> {
    let id = Uuid::now_v7().to_string(); // 使用UUID v7
    let now = Utc::now().timestamp_millis();
    // ... 其他逻辑
}

// 3. Refactor - 重构代码，保持测试通过
// - 提取ID生成逻辑
// - 优化错误处理
// - 改进代码结构
```

---

## 风险管理

### 技术风险
- **Loro库成熟度**: 提前验证（Phase 1）
- **libp2p复杂度**: 充分调研（Phase 5）
- **P2P NAT穿透**: 提供备选方案
- **性能问题**: 及早进行性能测试

### 时间风险
- **功能蔓延**: 严格按照路线图执行
- **估算偏差**: 预留20%的缓冲时间
- **TDD学习曲线**: 前期可能较慢，后期加速

### 应对措施
- MVP优先，快速验证核心价值
- 每个阶段独立测试和发布
- TDD保证代码质量，减少返工
- 技术难点提前验证

---

## 成功指标

### MVP阶段（v1.0.0）
- [ ] 能稳定运行
- [ ] 核心功能可用
- [ ] 测试覆盖率 > 80%
- [ ] 至少5个真实用户试用
- [ ] 无严重bug

### P2P阶段（v2.0.0）
- [ ] 同步功能稳定
- [ ] 支持至少2设备同步
- [ ] 冲突自动解决正确率 100%
- [ ] 无数据丢失

### 成熟阶段（v2.2.0）
- [ ] 所有功能完整可用
- [ ] 性能指标达标
- [ ] 用户满意度 > 4.0/5.0
- [ ] 日活用户 > 50

---

## 下一步行动

**立即开始**: Phase 1 - 项目初始化

### 本周目标（Phase 1）
1. 搭建Flutter + Rust项目框架
2. 验证Loro CRDT集成
3. 实现Loro到SQLite订阅机制
4. 编写基础测试用例
5. 达成测试覆盖率 > 80%

### 关键里程碑
- **Week 2-3**: MVP核心功能完成
- **Week 4**: MVP测试和发布
- **Week 5-7**: P2P同步实现
- **Week 8+**: 优化和完善

---

## 总结

记住核心原则：

1. **TDD驱动**: 先写测试，再写实现
2. **质量优先**: 测试覆盖率 > 80%
3. **Loro为主**: 所有写操作通过Loro
4. **快速迭代**: 每个阶段可独立交付
5. **用户反馈**: 及时收集，快速响应

**让我们开始吧！🚀**
