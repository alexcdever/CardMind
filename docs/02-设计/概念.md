# CardMind 概念文档

## 1. 核心概念

### 1.1 CardMind
- **定义**：基于CRDT技术的卡片笔记应用，支持多设备间实时数据同步。
- **目标平台**：桌面端（Windows、macOS、Linux）和移动端（Android、iOS）。

### 1.2 协作网络
- **定义**：由多个设备组成的、通过libp2p和Loro技术实现实时数据同步的分布式系统。
- **核心设计**：每个协作网络作为独立的数据池，设备作为数据池的出入口。
- **生命周期**：所有设备退出后，协作网络自动消失。

### 1.3 卡片
- **定义**：CardMind应用的核心数据单元，用于记录用户的笔记内容。
- **数据关联**：一个卡片对应一个LoroDoc对象，LoroDoc的唯一id即为卡片id。

### 1.4 设备
- **定义**：参与协作网络的终端设备，具有唯一的设备指纹。
- **标识方式**：设备id采用设备指纹生成，确保全球唯一。
- **默认昵称**：设备型号+设备id前6位（如：iPhone-abc123）。

### 1.5 常驻网络
- **定义**：用户设置的优先网络，用于控制新卡片的自动绑定行为。
- **作用**：设置后新建的卡片会自动加入所有常驻网络。

## 2. 技术概念

### 2.1 CRDT
- **定义**：Conflict-free Replicated Data Type（无冲突复制数据类型），是一种能够在分布式系统中实现数据同步而无需中央协调的技术。

### 2.2 Loro
- **定义**：基于Rust实现的CRDT库，用于实现分布式系统中数据的无冲突同步。

### 2.3 LoroDoc
- **定义**：Loro库用于存储和同步数据的核心数据结构。
- **作用**：作为多设备间数据同步的媒介，确保数据的最终一致性。

### 2.4 libp2p
- **定义**：模块化的P2P网络协议栈，支持多种传输方式和协议。
- **核心功能**：实现设备间的组网、通信和服务发现，替代WebRTC和传统信令服务。

### 2.5 SQLite
- **定义**：轻量级的嵌入式关系型数据库。
- **作用**：用于本地数据持久化，保存最新数据以方便快速查询。

### 2.6 UUID v7
- **定义**：分布式ID生成算法，具备支持分布式的id生成能力。

## 3. 架构概念

### 3.1 前后端架构
- **前端**：Flutter负责UI渲染和网络权限申请。
- **后端**：Rust负责核心业务逻辑，包括数据存储、同步、设备组网和通信等。
- **通信机制**：前后端通过flutter_rust_bridge进行通信。

### 3.2 数据存储架构
- **存储方案**：使用SQLite数据库，参考卡片和协作网络属性建表。
- **数据结构**：额外添加字段存储LoroDoc二进制数据。

### 3.3 数据处理流程
- **写操作**：Flutter传入写数据请求 → Rust端写入Loro → 通过Loro的subscribe机制自动更新SQLite表数据。
- **读操作**：Flutter直接从SQLite表中读取数据。

## 4. 数据模型

### 4.1 卡片属性

| 属性名 | 类型 | 描述 |
|--------|------|------|
| id | UUID v7 | 卡片的唯一标识符 |
| 标题 | 字符串 | 卡片标题 |
| 内容 | 字符串 | 卡片内容 |
| 创建时间 | 时间戳 | 卡片创建时间 |
| 更新时间 | 时间戳 | 卡片最后修改时间 |

### 4.2 协作网络属性

| 属性名 | 类型 | 描述 |
|--------|------|------|
| id | UUID v7 | 协作网络的唯一标识符 |
| 昵称 | 字符串 | 用于用户识别的显示名称 |
| 密码 | 字符串 | 用于保护协作网络，加入时需要验证 |
| 创建时间 | 时间戳 | 网络创建时间 |
| 更新时间 | 时间戳 | 网络信息最后更新时间 |
| 设备列表 | 数组 | 记录网络内所有设备的信息 |

### 4.3 设备属性

| 属性名 | 类型 | 描述 |
|--------|------|------|
| id | 字符串 | 设备指纹，唯一标识一个设备 |
| 昵称 | 字符串 | 用户友好的设备名称 |
| 创建时间 | 时间戳 | 设备首次加入网络时间 |
| 更新时间 | 时间戳 | 设备信息最后更新时间 |

## 5. 应用行为

### 5.1 App默认行为
- 初始化后默认创建一个协作网络，并为当前设备生成唯一id和默认昵称。
- 支持设置多个协作网络为常驻网络。
- 常驻网络规则：设置后新建的卡片会自动加入所有常驻网络。

### 5.2 卡片网络行为
- 未设置常驻网络时，新建卡片默认不加入任何协作网络。
- 支持自由加入/退出任意协作网络。

### 5.3 设备网络行为
- 初始化时自动加入默认创建的协作网络。
- 支持自由加入/退出任意协作网络。

## 6. 操作流程

### 6.1 设备退出网络流程
- 退出前检查当前设备是否有卡片加入该协作网络
- 若存在关联卡片，弹出提示确认
- 确认退出后，自动解除所有关联卡片与该网络的绑定关系
