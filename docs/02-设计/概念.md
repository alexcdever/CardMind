# CardMind 概念文档

## 1. 核心概念

### 1.1 CardMind
- **定义**：CardMind是一款基于CRDT技术的现代化卡片笔记应用，支持多设备间实时数据同步和离线使用。
- **核心特性**：采用Loro CRDT数据同步、libp2p P2P通信和离线优先架构，实现多设备间的无缝数据协作。

### 1.2 协作网络
- **定义**：由多个设备组成的、通过libp2p和Loro技术实现实时数据同步的分布式系统。
- **特征**：去中心化设计、实时数据同步、自动冲突解决、离线支持、跨平台兼容、安全通信。
- **运行方式**：包含网络创建、设备加入、数据同步、设备离开、网络销毁五个阶段。
- **多网络支持**：每个设备可创建任意数量的协作网络，设备可同时加入多个协作网络。
- **消失条件**：一个协作网络的消失要所有设备都退出这个协作网络才会消失。

### 1.3 网络基础
- **网络属性**：
  - 每个协作网络包含属性：**唯一ID**、**昵称**、**密码**、**创建时间**、**更新时间**和**设备列表**
  - 网络ID：
    - 协作网络的唯一标识符，基于UUID v7生成
    - 用于标识和区分不同的协作网络，是协作网络的核心标识
    - 每个设备都可以生成唯一的网络ID，无主次设备之分
  - 网络昵称：
    - 用于用户识别的显示名称
    - 支持重命名操作，修改后在所有加入设备上同步更新
    - 仅用于显示，不影响网络ID和数据流转
  - 密码：
    - 用于保护协作网络，加入时需要验证
  - 设备列表：
    - 记录网络内所有设备的信息，包含每个设备的设备ID和设备昵称
    - 在网络内实时同步，设备加入或修改昵称时自动更新
- **初始网络**：App初始化自动生成设备ID时，默认创建一个协作网络

### 1.4 设备管理
- **设备ID**：
  - 设备id即设备指纹，唯一标识一个设备
  - 本地存储：使用本地持久化存储
- **设备昵称**：
  - 用户友好的设备名称，用于在协作网络中更直观地识别设备
  - 默认生成：默认使用**设备型号+设备id前6位**组合（例如：win-a4g2q1）
  - 个性化设置：支持用户自定义设备昵称
  - **修改限制**：每个设备只能修改自己设备的昵称，通过设备ID判断昵称所属
  - 冲突处理：当多设备昵称相同时，自动添加后缀确保唯一性
  - 存储位置：设备ID和设备昵称保存在协作网络的设置中，记录在设备列表里
  - 同步机制：设备昵称修改后，在所有协作网络中同步更新
- **设备列表**：
  - 记录网络内所有设备的信息，包含每个设备的设备ID和设备昵称
  - 作为属性记录在每个协作网络的专属LoroDoc中
  - 在网络内实时同步，设备加入或修改昵称时自动更新
  - 设备默认会加入初始化时创建的协作网络
  - 设备可以退出任意协作网络，也可以加入任意协作网络

### 1.5 服务发现机制
- **基于libp2p**：利用libp2p内置的服务发现能力实现设备间的发现和连接
- **核心功能**：设备发现、网络拓扑管理、连接建立
- **mDNS集成**：通过libp2p的mDNS协议实现本地网络内的设备发现
- **去中心化设计**：无需传统的信令服务器，设备直接通过libp2p建立连接

### 1.6 常驻网络
- **定义**：app可以选取任意个协作网络作为常驻网络
- **作用**：设置后新建的卡片会自动加入到常驻网络中

## 2. 技术概念

### 2.1 Loro CRDT 同步机制
- **定义**：基于Loro库实现的Conflict-free Replicated Data Type（无冲突复制数据类型）同步机制。
- **特性**：自动合并、强最终一致性、无中心化、高性能、可扩展性、版本历史、空间效率、持久化。
- **作用**：实现多设备间的实时数据同步和自动冲突解决。

### 2.2 libp2p P2P通信
- **定义**：模块化的P2P网络协议栈，支持多种传输方式和协议，实现设备间的组网、通信和服务发现。
- **特性**：模块化设计、多协议支持、NAT穿透、加密通信、服务发现、去中心化。
- **替代方案**：替代WebRTC和传统信令服务，提供更完整的P2P网络解决方案。

### 2.3 数据持久化设计
- **设计理念**：使用SQLite参考卡片和协作网络的属性建表，并额外有一个字段用来保存LoroDoc的二进制数据。
- **SQLite表用途**：主要用于保存最新数据以方便快速查询
- **数据流向**：
  - 写操作：用户修改 → 更新LoroDoc → 更新SQLite → 同步到其他设备
  - 读操作：优先从SQLite读取 → 必要时从LoroDoc同步
  - 冲突解决：基于Loro的CRDT算法自动解决

### 2.4 LoroDoc
- **定义**：Loro库用于存储和同步数据的核心数据结构。
- **作用**：作为多设备间数据同步的媒介，确保数据的最终一致性。
- **专属LoroDoc设计**：
  - 一个卡片对应一个LoroDoc对象，而每个LoroDoc对象都有一个唯一的id，这个id就是卡片的id
  - 一个协作网络对应一个LoroDoc对象，而每个LoroDoc对象都有一个唯一的id，这个id就是协作网络的id
  - 专属LoroDoc仅用于保存该协作网络的设置信息
  - 专属LoroDoc仅在所属协作网络内流转，不跨网络同步
  - 协作网络设置包括：网络名称等
- **设备列表**：
  - 专属LoroDoc中包含设备列表作为默认属性，记录网络内所有设备的信息
  - 设备列表包含每个设备的：设备ID和设备昵称
  - 设备列表在网络内实时同步，设备加入或修改昵称时自动更新

## 3. 架构概念

### 3.1 跨平台架构
- **层级结构**：客户端层 → 通信适配层 → libp2p核心层 → Loro CRDT层 → 数据存储层。
- **目标平台**：
  - 桌面端：Windows、macOS、Linux
  - 移动端：Android、iOS

### 3.2 前后端分离架构
- **前端**：Flutter负责UI渲染和向设备申请网络相关的权限
- **后端**：Rust负责核心业务逻辑，包括数据的存储、同步、设备组网和通信等
- **通信机制**：前后端通过flutter_rust_bridge进行通信
- **依赖管理**：
  - Flutter端：不直接依赖loro-dart
  - Rust端：依赖loro、libp2p、sea-orm和rusqlite
- **libp2p使用**：Rust端通过libp2p实现设备间的组网、通信和服务发现，替代WebRTC和传统信令服务
- **数据处理流程**：
  - **写操作**：Flutter传入写数据请求 → Rust端写入Loro → 通过Loro的subscribe机制自动更新SQLite表数据
  - **读操作**：Flutter直接从SQLite表中读取数据
  - **设计目标**：实现后端数据的读写分离，提高系统性能和响应速度
- **设计原则**：Rust端根据开闭原则提供API给Flutter端调用

### 3.3 后端服务共享架构
- **设计理念**：将后端服务拆分为独立模块，便于不同平台复用。

### 3.4 通信优先级策略
- **连接优先级**：同一设备内 → 同一局域网 → 跨网络/互联网。
- **自动降级机制**：依次尝试高优先级连接方式，失败后自动降级到低优先级方式。

## 4. 功能概念

### 4.1 卡片管理
- **定义**：对卡片进行创建、编辑、查看、删除、排序与显示的功能
- **卡片属性**：id、标题、内容、创建时间、更新时间
- **操作流程**：
  - **卡片列表**：
    - 按修改时间倒序排序，最新的卡片显示在最上方
    - 每张卡片显示：部分标题、部分内容、创建时间和修改时间
  - **卡片详情**：显示完整的卡片信息（完整标题、完整内容、创建时间和修改时间）
  - **添加卡片**：
    - 通过浮空按钮添加新卡片
    - 点击后弹出编辑窗口，可输入卡片标题和内容
    - 实时显示标题字数统计和内容字数统计
  - **删除卡片**：
    - 在卡片列表中左滑或长按出现删除按钮
    - 点击删除按钮后显示二次确认弹窗
    - 支持软删除，标记卡片为已删除状态
    - 删除后无法撤销
  - **修改卡片**：
    - 点击修改按钮后弹出编辑窗口，默认填充当前卡片的标题和内容
    - 实时显示标题字数统计和内容字数统计
    - 编辑时保留原创建时间，仅更新修改时间

### 4.2 卡片数据绑定
- **绑定规则**：
  - 卡片数据可选择是否绑定到特定协作网络
  - **绑定状态**：卡片数据仅在绑定的协作网络中流转
  - **未绑定状态**：卡片数据不会在任何协作网络中流转，仅存储在本地设备
- **绑定操作**：
  - 支持在创建或编辑卡片时设置绑定关系
  - 支持将已有的未绑定卡片绑定到特定网络
- **默认绑定设置**：
  - **默认行为**：卡片在app没设置常驻网络的时候默认不会加入任何协作网络
  - **常驻网络设置**：用户可设置任意个协作网络为常驻网络，设置后新建的卡片会自动加入所有常驻网络

### 4.3 网络操作
- **设备加入网络**：
  - 加入一个协作网络需要通过libp2p发现网络，并根据协作网络的id和密码进行验证
  - 加入后自动同步网络内的设备列表和数据
- **设备退出网络**：
  - 支持设备退出协作网络的操作
  - 设备退出网络前，自动检查是否存在绑定了该网络的卡片
  - 若存在绑定卡片，弹出确认框进行提示和二次确认
  - 二次确认后依旧要退出的，自动解除所有绑定到该网络的卡片的绑定关系

### 4.4 数据同步
- **定义**：在多个设备间同步卡片数据的功能
- **核心技术**：使用Loro的CRDT（Conflict-free Replicated Data Type）算法
- **特性**：
  - 实现无冲突数据合并，确保最终一致性
  - 支持离线操作，上线后自动同步
  - 无需后端服务器配合
- **同步策略**：
  - 优先使用本地数据，确保快速响应
  - 后台自动同步，用户无感知
  - 支持增量同步，减少网络传输

## 5. 界面概念

### 5.1 主页布局
- **组成**：底部导航栏和内容区域
- **默认显示**：内容区域默认显示卡片列表

### 5.2 网络相关界面
- **网络认证界面**：
  - 显示时机：应用首次启动时显示
  - 功能：通过协作网络ID和密码加入已存在的协作网络，提供跳过选项，允许用户暂时不加入任何网络
- **网络设置界面**：
  - 显示网络连接状态和当前网络ID
  - 显示在线设备列表，包括设备ID、设备昵称、设备类型
  - 提供"生成Access Code"按钮
  - 支持网络重命名操作
  - 支持退出网络操作

### 5.3 卡片相关界面
- **卡片列表界面**：
  - 排序规则：按修改时间排序，最新的卡片显示在最上方
  - 卡片显示：每张卡片显示部分标题、部分内容、创建时间和修改时间
- **卡片详情界面**：
  - 触发方式：点击卡片列表中的任一卡片后弹起详情窗口
  - 显示内容：完整标题、完整内容、创建时间和修改时间
- **卡片编辑界面**：
  - 添加卡片：主页内容区底部有浮空按钮用于添加新卡片，点击后弹出编辑窗口
  - 修改卡片：点击修改按钮后弹出编辑窗口，默认填充当前卡片的标题和内容
  - 辅助功能：实时显示标题字数统计和内容字数统计
- **卡片删除界面**：
  - 触发方式：在卡片列表中左滑或长按出现删除按钮
  - 确认机制：点击删除按钮后显示二次确认弹窗

### 5.4 交互设计原则
- 所有交互操作应提供明确的反馈
- 界面设计应简洁、直观，符合现代移动应用设计规范
- 确保在不同设备上都有良好的显示效果

## 6. 流程概念

### 6.1 网络生命周期
1. **网络创建**：生成网络ID、生成密码、初始化LoroDoc。
2. **设备加入**：通过libp2p发现网络、验证网络ID和密码、建立libp2p连接、同步LoroDoc数据、注册设备信息。
3. **数据同步**：更新本地SQLite、Loro自动同步、其他设备接收修改、自动解决冲突。
4. **设备离开**：
   - 设备主动离开或网络检测到设备离线
   - 设备主动离开时，自动检查是否存在绑定了该网络的卡片
   - 若存在绑定卡片，弹出确认框进行提示和二次确认
   - 二次确认后依旧要退出的，自动解除所有绑定到该网络的卡片的绑定关系
   - 更新设备状态
5. **网络销毁**：所有设备都退出该协作网络时，网络自动消失。

### 6.2 应用启动流程
- 初始化SQLite → 加载设备信息 → 加载网络配置 → 建立libp2p连接 → 同步数据 → 监听变更。

### 6.3 数据操作同步流程
- 本地操作 → 本地保存 → 同步标记 → 实时传播 → 远程应用 → 双向同步。

## 7. 注意事项概念

### 7.1 数据一致性
- **CRDT算法**：确保最终一致性，但需要仔细处理同步冲突。
- **离线操作**：可能导致合并冲突，依赖Loro的自动冲突解决机制。

### 7.2 网络连接限制
- **libp2p依赖**：需要网络支持TCP/UDP流量，某些企业网络环境可能限制p2p连接。
- **NAT穿透**：在某些复杂网络环境下可能失败，libp2p内置了NAT穿透机制，必要时可配置STUN/TURN服务器协助。

### 7.3 性能考虑
- **LoroDoc大小**：会影响同步性能，需要合理设计数据结构。
- **并发编辑**：大量并发编辑可能导致性能下降。
- **SQLite查询**：需要合理设计索引，优化查询性能。

### 7.4 安全考虑
- **密码安全**：
  - 协作网络密码用于保护网络安全，不应通过不安全的渠道分享
  - 需要安全存储和传输机制
- **libp2p加密**：libp2p连接默认加密，支持多种加密协议，确保设备间通信安全。
- **本地数据保护**：
  - 所有数据默认在本地加密存储，使用行业标准的加密算法
  - 加密范围：包括卡片数据、网络配置、设备信息等所有用户数据
  - 应用启动时提供安全验证机制，防止未授权访问
  - 支持设备级别的安全保护
  - 支持应用级别的安全锁定
- **数据存储策略**：
  - 所有数据默认存储在本地，不上传到第三方服务器
  - 设备间通信默认加密，保护数据传输安全
  - 不收集用户隐私数据，遵循数据最小化原则，仅收集必要的数据
- **安全更新**：定期更新加密算法和安全机制，适应新的安全威胁
- **安全最佳实践**：提供安全最佳实践建议给用户