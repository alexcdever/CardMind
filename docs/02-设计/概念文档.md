# CardMind 概念文档

## 1. 核心概念

### 1.1 CardMind
- **定义**：CardMind是一个现代化的笔记卡片管理应用，支持多设备间数据同步和离线使用。
- **核心特性**：基于CRDT数据同步、WebRTC点对点通信和离线优先架构，实现多设备间的无缝数据协作。

### 1.2 协作网络
- **定义**：由多个设备组成的、通过WebRTC和Yjs技术实现实时数据同步的分布式系统。
- **特征**：去中心化设计、实时数据同步、自动冲突解决、离线支持、跨平台兼容、安全通信。
- **运行方式**：包含网络创建、设备加入、数据同步、设备离开、网络销毁五个阶段。
- **多网络支持**：每个设备可创建任意数量的协作网络，设备可同时加入多个协作网络。
- **默认网络**：App初始化自动生成设备ID时，默认创建一个名为"local"的协作网络。
- **网络属性**：每个协作网络默认包含两个属性：唯一ID和昵称。
- **网络昵称**：用于用户识别的显示名称，默认规则：
  - local网络：昵称为"local"
  - 其他新创建网络：昵称为网络ID的前5位字符
  - 支持重命名操作，修改后在所有加入设备上同步更新

### 1.3 网络ID
- **定义**：协作网络的唯一标识符，基于UUID v4生成。
- **作用**：用于标识和区分不同的协作网络，是协作网络的核心标识。
- **生成机制**：每个设备都可以生成唯一的网络ID，无主次设备之分。

### 1.4 设备ID
- **定义**：每个设备生成并存储的唯一标识符，用于在协作网络中区分不同设备。
- **生成机制**：结合设备指纹和随机UUID生成持久化设备标识。
- **本地存储**：使用IndexedDB本地持久化存储。

### 1.5 设备昵称
- **定义**：用户友好的设备名称，用于在协作网络中更直观地识别设备。
- **默认生成**：默认使用**主机名+设备ID前五位**组合（例如：win-a4g2q）。
- **个性化设置**：支持用户自定义设备昵称。
- **冲突处理**：当多设备昵称相同时，自动添加后缀确保唯一性。
- **存储位置**：设备ID和设备昵称保存在协作网络的设置中，记录在设备列表里。
- **同步机制**：设备昵称修改后，在所有协作网络中同步更新。

### 1.6 Access Code
- **定义**：设备通过输入Access Code加入已存在的协作网络，是包含信令服务器的连接方式和协作网络的id的加入凭证。
- **组成**：协作网络ID、信令服务器连接方式（IP地址和端口信息）、时间戳、设备标识。
- **生成与使用**：创建新网络时实时生成、在设置页面中可手动实时生成；不持久化存储，每次需要时重新生成；通过复制粘贴方式分享。

## 2. 技术概念

### 2.1 Yjs CRDT 同步机制
- **定义**：基于Yjs库实现的Conflict-free Replicated Data Type（无冲突复制数据类型）同步机制。
- **特性**：自动合并、强最终一致性、无中心化、高性能、可扩展性、版本历史、空间效率、持久化。
- **作用**：实现多设备间的实时数据同步和自动冲突解决。

### 2.2 WebRTC 点对点通信
- **定义**：直接在浏览器之间建立连接的实时通信技术，无需经过服务器中转。
- **特性**：点对点连接、NAT穿透、加密通信。
- **适配器**：使用y-webrtc适配器，提供自动连接管理、房间概念、意识协议等功能。

### 2.3 双数据源工作方式
- **设计理念**：使用IndexedDB存储业务数据，提供结构化查询能力；使用Yjs作为同步层，负责多设备间的实时同步。
- **数据流向**：
  - 写操作：用户修改 → 更新IndexedDB → 更新Yjs文档 → 同步到其他设备
  - 读操作：优先从IndexedDB读取 → 必要时从Yjs同步
  - 冲突解决：基于Yjs的CRDT算法自动解决

### 2.4 IndexedDB
- **定义**：浏览器内置的事务型数据库，用于客户端本地数据持久化存储。
- **作用**：存储业务数据、设备ID、网络配置等信息。
- **管理工具**：使用Dexie.js管理IndexedDB，提供更简洁的API。

### 2.5 SyncService
- **定义**：管理设备间的数据同步逻辑的核心服务组件。
- **作用**：协调Yjs文档、WebRTC连接和本地存储之间的数据同步。

### 2.6 Yjs文档
- **定义**：Yjs库用于存储和同步数据的核心数据结构。
- **作用**：作为多设备间数据同步的媒介，确保数据的最终一致性。
- **专属YDoc设计**：
  - 每个协作网络拥有专属的YDoc实例
  - 专属YDoc仅用于保存该协作网络的设置信息
  - 专属YDoc仅在所属协作网络内流转，不跨网络同步
  - 协作网络设置包括：网络名称、设备权限、同步策略等
- **设备列表**：
  - 专属YDoc中包含设备列表作为默认属性，记录网络内所有设备的信息
  - 设备列表包含每个设备的：设备ID和设备昵称
  - 设备列表在网络内实时同步，设备加入或修改昵称时自动更新

## 3. 架构概念

### 3.1 跨平台架构
- **层级结构**：客户端层 → 通信适配层 → WebRTC核心层 → Yjs CRDT层 → 数据存储层。
- **平台优先级**：Electron (PC) 最高，React Native (移动端) 中等，Web 平台最低。
- **部署能力**：
  - Electron：客户端+服务端
  - React Native：仅客户端
  - Web平台：客户端+服务端

### 3.2 后端服务共享架构
- **设计理念**：将后端服务拆分为独立模块，便于不同平台复用。
- **部署方式**：
  - Electron：子进程形式
  - Web平台：容器/云部署
- **实现策略**：模块化设计、平台抽象层、配置驱动、依赖管理、测试策略。

### 3.3 通信优先级策略
- **连接优先级**：同一设备内 → 同一局域网 → 跨网络/互联网。
- **自动降级机制**：依次尝试高优先级连接方式，失败后自动降级到低优先级方式。

### 3.4 信令服务器
- **定义**：轻量级服务器，用于WebRTC连接建立过程中的信令交换。
- **核心功能**：WebSocket连接管理、房间管理和消息广播、设备发现和状态跟踪、WebRTC信令转发。
- **部署方案**：Docker容器化、Serverless、本地部署。

## 4. 功能概念

### 4.1 卡片管理
- **定义**：对卡片进行创建、编辑、查看、删除、排序与显示的功能。
- **卡片属性**：id、title（最多20字符）、content（最多2000字符）、createdAt（毫秒级）、updatedAt（毫秒级）、isDeleted（软删除标记）、lastModifiedBy、networkId（可选，用于绑定到特定协作网络）。
- **操作流程**：
  - **卡片列表**：
    - 按修改时间倒序排序，最新的卡片显示在最上方
    - 相同修改时间按标题字母顺序排序
    - 每张卡片显示：部分标题、部分内容、创建时间和修改时间
    - 卡片数量：无限制
    - 空列表提示：当卡片列表为空时显示友好提示
  - **卡片详情**：显示完整的卡片信息（完整标题、完整内容、创建时间和修改时间）。
  - **添加卡片**：
    - 通过浮空按钮添加新卡片
    - 点击后弹出编辑窗口，可输入卡片标题和内容
    - 实时显示标题字数统计和内容字数统计
  - **删除卡片**：
    - 在卡片列表中左滑或长按出现删除按钮
    - 点击删除按钮后显示二次确认弹窗
    - 支持软删除，标记卡片为已删除状态
    - 删除后无法撤销
  - **修改卡片**：
    - 点击修改按钮后弹出编辑窗口，默认填充当前卡片的标题和内容
    - 实时显示标题字数统计和内容字数统计
    - 编辑时保留原创建时间，仅更新修改时间
- **卡片数据绑定机制**：
  - 卡片数据可选择是否绑定到特定协作网络
  - **绑定状态**：卡片数据仅在绑定的协作网络中流转
  - **未绑定状态**：卡片数据不会在任何协作网络中流转，仅存储在本地设备
  - **默认行为**：新创建的卡片默认绑定到local网络
  - **默认设置修改**：用户可修改App设置，将默认绑定的协作网络设置为其他网络或移除默认绑定

### 4.2 数据同步
- **定义**：在多个设备间同步卡片数据的功能。
- **特性**：支持离线使用、无需后端服务器配合、使用Yjs的CRDT算法实现无冲突数据合并。
- **数据流向**：本地操作 → 本地保存 → 同步标记 → 实时传播 → 远程应用 → 双向同步。

### 4.3 本地数据加密存储
- **定义**：对本地存储的数据进行加密保护，防止未授权访问。
- **作用**：提供基本的安全保护，防止本地数据泄露。

### 4.4 网络原则
- **离线优先原则**：无需依赖后端服务器，优先使用本地数据。
- **简化用户交互**：无需第三方授权，简化用户交互流程。
- **局域网协同**：适用于家庭局域网协同组网场景。

## 5. 界面概念

### 5.1 主页布局
- **组成**：底部导航栏和内容区域。
- **默认显示**：内容区域默认显示卡片列表。

### 5.2 网络认证界面
- **显示时机**：应用首次启动时显示。
- **功能**：通过Access Code加入已存在的协作网络，提供跳过选项，允许用户暂时不加入任何网络。

### 5.3 网络设置界面
- **功能**：
  - 显示网络连接状态和当前网络ID
  - 显示在线设备列表，包括设备ID、设备昵称、设备类型
  - 提供"生成Access Code"按钮
  - 支持网络重命名操作
  - 支持退出网络操作

### 5.4 卡片列表（查）
- **排序规则**：按修改时间排序，最新的卡片显示在最上方
- **卡片显示**：每张卡片显示部分标题、部分内容、创建时间和修改时间

### 5.5 卡片详情（查）
- **触发方式**：点击卡片列表中的任一卡片后弹起详情窗口
- **显示内容**：完整标题、完整内容、创建时间和修改时间

### 5.6 添加卡片（增）
- **触发方式**：主页内容区底部有浮空按钮用于添加新卡片
- **交互流程**：点击后弹出编辑窗口，可输入卡片标题和内容
- **辅助功能**：实时显示标题字数统计和内容字数统计

### 5.7 删除卡片（删）
- **触发方式**：在卡片列表中左滑或长按出现删除按钮
- **确认机制**：点击删除按钮后显示二次确认弹窗

### 5.8 修改卡片（改）
- **触发方式**：点击修改按钮后弹出编辑窗口
- **默认填充**：默认填充当前卡片的标题和内容
- **辅助功能**：实时显示标题字数统计和内容字数统计

### 5.9 交互设计原则
- 所有交互操作应提供明确的反馈
- 界面设计应简洁、直观，符合现代移动应用设计规范
- 确保在不同设备上都有良好的显示效果

## 6. 流程概念

### 6.1 网络生命周期
1. **网络创建**：生成网络ID、生成Access Code、初始化Yjs文档。
2. **设备加入**：输入Access Code、验证有效性、建立WebRTC连接、同步Yjs文档数据、注册设备信息。
3. **数据同步**：更新本地IndexedDB、Yjs自动同步、其他设备接收修改、自动解决冲突。
4. **设备离开**：
   - 设备主动离开或网络检测到设备离线
   - 设备主动离开时，自动检查是否存在绑定了该网络的卡片
   - 若存在绑定卡片，弹出确认框进行提示和二次确认
   - 二次确认后依旧要退出的，自动解除所有绑定到该网络的卡片的绑定关系
   - 更新设备状态
5. **网络销毁**：所有设备离开网络或设备主动销毁网络、清除相关数据和连接。

### 6.2 网络认证流程
- 检查设备ID → 网络状态检查 → Access Code输入/生成 → 网络加入 → 设备注册。

### 6.3 应用启动流程
- 初始化IndexedDB → 加载设备信息 → 加载网络配置 → 建立WebRTC连接 → 同步数据 → 监听变更。

### 6.4 数据操作同步流程
- 本地操作 → 本地保存 → 同步标记 → 实时传播 → 远程应用 → 双向同步。

## 7. 注意事项概念

### 7.1 数据一致性
- **CRDT算法**：确保最终一致性，但双数据源设计需要仔细处理同步冲突。
- **离线操作**：可能导致合并冲突，依赖Yjs的自动冲突解决机制。

### 7.2 网络连接限制
- **WebRTC依赖**：需要网络支持UDP流量，某些企业网络环境可能限制WebRTC连接。
- **NAT穿透**：在某些复杂网络环境下可能失败，需要STUN/TURN服务器协助。

### 7.3 性能考虑
- **Yjs文档大小**：会影响同步性能，需要合理设计数据结构。
- **并发编辑**：大量并发编辑可能导致性能下降。
- **IndexedDB查询**：需要合理设计索引，优化查询性能。

### 7.4 安全考虑
- **Access Code安全**：
  - 包含敏感连接信息，不应通过不安全的渠道分享
  - Access Code生成后实时生成，不持久化存储
  - 需要安全生成和传输机制
- **WebRTC加密**：WebRTC连接默认加密，但仍需验证设备身份。
- **本地数据保护**：
  - 所有数据默认在本地加密存储，使用行业标准的加密算法
  - 加密范围：包括卡片数据、网络配置、设备信息等所有用户数据
  - 应用启动时提供安全验证机制，防止未授权访问
  - 支持设备级别的安全保护
  - 支持应用级别的安全锁定
- **数据存储策略**：
  - 所有数据默认存储在本地，不上传到第三方服务器
  - 设备间通信默认加密，保护数据传输安全
  - 不收集用户隐私数据，遵循数据最小化原则，仅收集必要的数据
- **安全更新**：定期更新加密算法和安全机制，适应新的安全威胁
- **安全最佳实践**：提供安全最佳实践建议给用户