# CardMind 技术栈文档

> 本文档提供 CardMind 项目的技术选型、依赖版本、环境配置和参考资源。

---

## 1. 技术选型总览

| 层级 | 技术 | 版本要求 | 用途 |
|------|------|---------|------|
| 前端框架 | Flutter | 3.16+ | 跨平台 UI 开发 |
| 后端语言 | Rust | 1.75+ | 核心业务逻辑 |
| CRDT 库 | Loro | latest | 分布式数据同步 |
| P2P 网络 | libp2p | 0.53+ | 设备组网与通信 |
| 数据库 | SQLite | 3.40+ | 本地数据持久化 |
| ORM 框架 | sea-orm | 0.12+ | 数据库访问层 |
| FFI 桥接 | flutter_rust_bridge | 2.0+ | Dart ↔ Rust 通信 |
| ID 生成 | uuid (Rust crate) | 1.6+ | UUID v7 生成 |

---

## 2. 前端技术栈

### 2.1 核心框架

**Flutter**
- **版本**：3.16.0 或更高
- **用途**：跨平台 UI 框架，支持 Windows、macOS、Linux、Android、iOS
- **职责**：
  - UI 渲染和用户交互
  - 网络权限申请
  - 调用 Rust 端 API

**安装指南**：
```bash
# 安装 Flutter SDK
# 参考：https://docs.flutter.dev/get-started/install

# 验证安装
flutter doctor

# 设置国内镜像（可选）
export PUB_HOSTED_URL=https://pub.flutter-io.cn
export FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn
```

### 2.2 关键依赖

**flutter_rust_bridge**
- **版本**：^2.0.0
- **用途**：Flutter 与 Rust 之间的高性能通信桥接
- **特性**：
  - 支持异步调用
  - 自动生成类型安全的绑定代码
  - 零拷贝数据传输

**添加依赖**：
```yaml
# pubspec.yaml
dependencies:
  flutter_rust_bridge: ^2.0.0
```

### 2.3 开发工具

- **IDE**：VS Code / Android Studio / IntelliJ IDEA
- **插件**：Flutter、Dart
- **调试工具**：Flutter DevTools

---

## 3. 后端技术栈

### 3.1 语言和运行时

**Rust**
- **版本**：1.75.0 或更高
- **Edition**：2021
- **用途**：实现核心业务逻辑，保证内存安全和高性能

**安装指南**：
```bash
# 安装 Rust（推荐使用 rustup）
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# 验证安装
rustc --version
cargo --version

# 设置国内镜像（可选）
# 编辑 ~/.cargo/config.toml
[source.crates-io]
replace-with = 'ustc'

[source.ustc]
registry = "https://mirrors.ustc.edu.cn/crates.io-index"
```

### 3.2 核心依赖库

#### Loro - CRDT 同步引擎

**Crate**：`loro` (或 `loro-internal`，根据最新版本)
- **版本**：使用 GitHub 最新版本
- **用途**：实现无冲突的分布式数据同步
- **核心特性**：
  - 支持 Text、Map、List 等数据类型
  - 提供 Subscribe 机制监听数据变化
  - 可序列化为二进制格式

**Cargo.toml 配置**：
```toml
[dependencies]
loro = { git = "https://github.com/loro-dev/loro", branch = "main" }
```

#### libp2p - P2P 网络协议栈

**Crate**：`libp2p`
- **版本**：^0.53.0
- **用途**：设备间的组网、通信和服务发现
- **启用特性**：
  - `tcp`：TCP 传输
  - `mdns`：本地网络设备发现
  - `noise`：加密通信
  - `yamux`：多路复用

**Cargo.toml 配置**：
```toml
[dependencies]
libp2p = { version = "0.53", features = ["tcp", "mdns", "noise", "yamux"] }
```

#### sea-orm - 数据持久化

**Crate**：`sea-orm`
- **版本**：^0.12.0
- **用途**：Rust ORM 框架，提供 SQLite 数据库访问
- **底层驱动**：通过 sqlx 支持 SQLite
- **特性**：
  - 类型安全的查询构建
  - 异步数据库操作
  - 迁移管理

**Cargo.toml 配置**：
```toml
[dependencies]
sea-orm = { version = "0.12", features = ["sqlx-sqlite", "runtime-tokio-native-tls"] }
```

#### flutter_rust_bridge - FFI 桥接

**Crate**：`flutter_rust_bridge`
- **版本**：^2.0.0
- **用途**：生成 Dart 和 Rust 之间的绑定代码

**Cargo.toml 配置**：
```toml
[dependencies]
flutter_rust_bridge = "2.0"

[build-dependencies]
flutter_rust_bridge_codegen = "2.0"
```

#### UUID v7 生成

**Crate**：`uuid`
- **版本**：^1.6.0
- **用途**：生成 UUID v7 格式的唯一标识符
- **启用特性**：`v7`

**Cargo.toml 配置**：
```toml
[dependencies]
uuid = { version = "1.6", features = ["v7", "serde"] }
```

### 3.3 其他依赖

| Crate | 版本 | 用途 |
|-------|------|------|
| tokio | ^1.35 | 异步运行时 |
| serde | ^1.0 | 序列化/反序列化 |
| anyhow | ^1.0 | 错误处理 |
| tracing | ^0.1 | 日志和追踪 |

### 3.4 开发工具

- **IDE**：VS Code / RustRover / CLion
- **插件**：rust-analyzer、CodeLLDB
- **代码格式化**：rustfmt
- **代码检查**：clippy

---

## 4. 技术选型理由

### 4.1 为什么选择 Flutter？

**优势**：
- ✅ 单一代码库支持 5 个平台（Windows、macOS、Linux、Android、iOS）
- ✅ 高性能渲染引擎（Skia）
- ✅ 热重载提高开发效率
- ✅ 成熟的生态系统和社区支持

**替代方案对比**：
- **React Native**：性能略逊，桌面端支持不成熟
- **Electron**：内存占用大，不适合移动端

### 4.2 为什么选择 Rust？

**优势**：
- ✅ 内存安全，无 GC 开销
- ✅ 高性能，接近 C/C++
- ✅ 并发安全（所有权系统）
- ✅ 适合实现复杂的同步逻辑

**替代方案对比**：
- **Go**：有 GC，内存控制不如 Rust
- **C++**：缺乏内存安全保证

### 4.3 为什么选择 Loro？

**优势**：
- ✅ Rust 原生实现，性能优秀
- ✅ 支持丰富的数据类型（Text、Map、List 等）
- ✅ 提供 Subscribe 机制，易于集成
- ✅ 活跃开发中，功能持续完善

**替代方案对比**：
- **Yjs**：JavaScript 实现，需要通过 WASM 集成
- **Automerge**：性能较 Loro 略逊

### 4.4 为什么选择 libp2p？

**优势**：
- ✅ 去中心化设计，无需信令服务器
- ✅ 内置多种传输协议和服务发现机制
- ✅ 支持 NAT 穿透
- ✅ 成熟稳定，被 IPFS、Polkadot 等项目使用

**替代方案对比**：
- **WebRTC**：需要信令服务器，集成复杂
- **自建 P2P**：开发成本高，稳定性难保证

### 4.5 为什么选择 UUID v7？

**优势**：
- ✅ 支持时间排序（内嵌时间戳）
- ✅ 分布式环境下保证唯一性
- ✅ 对数据库索引友好（单调递增）

**替代方案对比**：
- **UUID v4**：随机生成，无时间排序特性
- **Snowflake**：需要中心化的 ID 生成器

---

## 5. 开发环境配置

### 5.1 前置要求

| 工具 | 最低版本 | 用途 |
|------|---------|------|
| Git | 2.30+ | 版本控制 |
| Flutter SDK | 3.16+ | 前端开发 |
| Rust (rustc) | 1.75+ | 后端开发 |
| Cargo | 1.75+ | Rust 包管理 |

### 5.2 Flutter 环境配置

```bash
# 1. 安装 Flutter SDK
# 参考：https://docs.flutter.dev/get-started/install

# 2. 检查环境
flutter doctor

# 3. 安装平台特定的依赖
# Android: Android Studio + Android SDK
# iOS: Xcode + CocoaPods
# Desktop: 参考 Flutter 官方文档

# 4. 启用桌面平台支持
flutter config --enable-windows-desktop
flutter config --enable-macos-desktop
flutter config --enable-linux-desktop
```

### 5.3 Rust 环境配置

```bash
# 1. 安装 Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# 2. 添加必要的编译目标
# Android
rustup target add aarch64-linux-android armv7-linux-androideabi
# iOS
rustup target add aarch64-apple-ios x86_64-apple-ios

# 3. 安装 flutter_rust_bridge 代码生成工具
cargo install flutter_rust_bridge_codegen

# 4. 安装其他开发工具
cargo install cargo-watch  # 文件监听
cargo install cargo-edit   # 依赖管理
```

### 5.4 项目依赖安装

```bash
# 1. 克隆仓库
git clone <repository-url>
cd CardMind

# 2. 安装 Flutter 依赖
flutter pub get

# 3. 构建 Rust 代码
cd rust
cargo build

# 4. 生成 FFI 绑定代码
flutter_rust_bridge_codegen generate

# 5. 运行项目
cd ..
flutter run
```

### 5.5 常见问题

**问题：flutter_rust_bridge 生成失败**
```bash
# 解决方案：确保已安装 LLVM
# macOS: brew install llvm
# Ubuntu: sudo apt-get install libclang-dev
# Windows: 下载 LLVM 安装包
```

**问题：Rust 编译错误**
```bash
# 清理缓存重新编译
cargo clean
cargo build
```

---

## 6. 参考资源

### 6.1 官方文档

| 技术 | 文档链接 |
|------|---------|
| Flutter | https://docs.flutter.dev |
| Rust | https://doc.rust-lang.org/book/ |
| Loro | https://loro.dev/docs |
| libp2p | https://docs.libp2p.io |
| sea-orm | https://www.sea-ql.org/SeaORM/ |
| flutter_rust_bridge | https://cjycode.com/flutter_rust_bridge/ |

### 6.2 GitHub 仓库

- **Loro**：https://github.com/loro-dev/loro
- **libp2p (Rust)**：https://github.com/libp2p/rust-libp2p
- **flutter_rust_bridge**：https://github.com/fzyzcjy/flutter_rust_bridge
- **sea-orm**：https://github.com/SeaQL/sea-orm

### 6.3 学习资源

**Rust 学习**：
- The Rust Book：https://doc.rust-lang.org/book/
- Rust by Example：https://doc.rust-lang.org/rust-by-example/

**CRDT 理论**：
- CRDT 介绍：https://crdt.tech
- Loro 博客：https://loro.dev/blog

**libp2p 教程**：
- libp2p 概念：https://docs.libp2p.io/concepts/
- Rust libp2p 教程：https://github.com/libp2p/rust-libp2p/tree/master/examples

**Flutter + Rust**：
- flutter_rust_bridge 教程：https://cjycode.com/flutter_rust_bridge/

### 6.4 社区资源

- **Rust 中文社区**：https://rustcc.cn
- **Flutter 中文网**：https://flutter.cn
- **Discord**：Loro 官方 Discord、libp2p Discord

---

## 7. 版本管理策略

### 7.1 依赖更新原则

- **主版本更新**：需要团队评审和测试
- **次版本更新**：定期更新（每月检查）
- **补丁更新**：及时应用安全修复

### 7.2 版本锁定

```toml
# Cargo.toml - 使用明确的版本号
[dependencies]
libp2p = "0.53.2"  # 锁定具体版本

# 或使用语义化版本控制
sea-orm = "^0.12.0"  # 允许 0.12.x 更新
```

```yaml
# pubspec.yaml
dependencies:
  flutter_rust_bridge: ^2.0.0  # 允许 2.x.x 更新
```

### 7.3 依赖审计

```bash
# Rust 依赖安全检查
cargo audit

# 更新所有依赖
cargo update
flutter pub upgrade
```

---

## 附录：完整 Cargo.toml 示例

```toml
[package]
name = "cardmind-core"
version = "0.1.0"
edition = "2021"

[dependencies]
# CRDT 同步
loro = { git = "https://github.com/loro-dev/loro", branch = "main" }

# P2P 网络
libp2p = { version = "0.53", features = ["tcp", "mdns", "noise", "yamux"] }

# 数据库
sea-orm = { version = "0.12", features = ["sqlx-sqlite", "runtime-tokio-native-tls"] }

# FFI 桥接
flutter_rust_bridge = "2.0"

# UUID 生成
uuid = { version = "1.6", features = ["v7", "serde"] }

# 异步运行时
tokio = { version = "1.35", features = ["full"] }

# 序列化
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"

# 错误处理
anyhow = "1.0"
thiserror = "1.0"

# 日志
tracing = "0.1"
tracing-subscriber = "0.3"

[build-dependencies]
flutter_rust_bridge_codegen = "2.0"

[profile.release]
opt-level = 3
lto = true
codegen-units = 1
```

---

**文档版本**：v2.0
**最后更新**：2025-12-24
**维护者**：CardMind 开发团队
**参考**：[需求文档](../01-需求/需求.md) | [概念词典](概念.md)
