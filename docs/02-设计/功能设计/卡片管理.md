# 卡片管理功能设计

> 本文档描述 CardMind 应用的卡片管理功能，包括用户交互、业务流程和异常处理。数据模型请参考 [需求文档 §2.1](../../01-需求/需求.md#21-卡片card)。

---

## 1. 功能概述

卡片管理是 CardMind 的核心功能，提供卡片的创建、编辑、查看、删除和网络管理能力，支持多设备间的实时同步。

**核心价值**：
- 快速记录想法和笔记
- 灵活管理卡片所属的协作空间
- 多设备无缝同步

---

## 2. 用户场景

### 2.1 创建卡片
**场景描述**：用户有新的想法或笔记需要记录

**典型流程**：
1. 用户打开应用，看到卡片列表
2. 点击悬浮添加按钮（FAB）
3. 输入卡片标题和内容
4. 保存后，卡片出现在列表顶部

### 2.2 编辑卡片
**场景描述**：用户需要修改已有卡片的内容

**典型流程**：
1. 在卡片列表中找到目标卡片
2. 点击卡片进入详情页
3. 点击编辑按钮
4. 修改内容后保存
5. 更新时间自动更新，卡片在列表中排序靠前

### 2.3 查看卡片
**场景描述**：用户浏览已有卡片内容

**典型流程**：
1. 在卡片列表浏览（按更新时间倒序）
2. 点击卡片查看完整内容
3. 可以看到卡片所属的协作空间

### 2.4 删除卡片
**场景描述**：用户需要清理不再需要的卡片

**典型流程**：
1. 在卡片列表找到目标卡片
2. 滑动或长按显示操作菜单
3. 选择"删除"操作
4. 确认删除（软删除，标记为已删除）

### 2.5 管理卡片网络
**场景描述**：用户需要控制卡片在哪些协作空间中同步

**典型流程**：
1. 进入卡片详情页
2. 点击"网络管理"按钮
3. 查看当前加入的协作空间列表
4. 添加或移除协作空间
5. 保存后，卡片在相应协作空间中同步

---

## 3. 功能详细设计

### 3.1 卡片创建

#### 触发条件
- 用户点击主界面的悬浮添加按钮（FAB）
- 或通过快捷方式（如快捷键）触发

#### 操作步骤
1. **打开创建界面**
   - 显示标题输入框
   - 显示内容编辑区
   - 显示"保存"和"取消"按钮

2. **输入内容**
   - 标题：单行文本输入（可选）
   - 内容：多行文本编辑器（支持 Markdown）

3. **保存卡片**
   - 点击"保存"按钮
   - 生成 UUID v7 作为卡片 ID
   - 记录创建时间和更新时间
   - 根据常驻网络规则自动加入协作空间

#### 预期结果
- ✅ 卡片成功创建
- ✅ 卡片出现在列表顶部
- ✅ 如果设置了常驻网络，卡片自动加入
- ✅ 显示成功提示（可选）

#### 异常处理
- **内容为空**：允许保存空卡片，但建议提示用户
- **网络断开**：卡片保存在本地，等待网络恢复后同步
- **保存失败**：显示错误提示，保留用户输入内容

#### 业务规则
- **常驻网络**：如果用户设置了常驻网络，新建卡片自动加入所有常驻网络
- **无常驻网络**：新建卡片不加入任何协作空间（孤立状态）
- **软删除标记**：新建卡片的 `deleted` 字段默认为 `false`

---

### 3.2 卡片编辑

#### 触发条件
- 用户在卡片详情页点击"编辑"按钮
- 或在列表中通过操作菜单选择"编辑"

#### 操作步骤
1. **进入编辑模式**
   - 加载卡片当前内容
   - 显示编辑界面（与创建界面类似）

2. **修改内容**
   - 用户修改标题或内容
   - 实时保存草稿（可选）

3. **保存修改**
   - 点击"保存"按钮
   - 更新 `updated_at` 时间戳
   - 通过 CRDT 同步到其他设备

#### 预期结果
- ✅ 卡片内容更新成功
- ✅ 更新时间刷新
- ✅ 在列表中重新排序（按更新时间）
- ✅ 同步到所有关联的协作空间

#### 异常处理
- **并发编辑冲突**：CRDT 自动合并，无需用户干预
- **网络断开**：保存到本地，等待同步
- **编辑中途退出**：询问是否保存更改

#### 业务规则
- **更新时间**：每次保存都更新 `updated_at`
- **版本控制**：通过 LoroDoc 管理版本历史
- **同步范围**：仅同步到卡片已加入的协作空间

---

### 3.3 卡片查看

#### 列表视图

**显示内容**：
- 卡片标题（加粗显示）
- 内容预览（前 2 行）
- 更新时间（相对时间，如"5分钟前"）
- 所属网络标签（图标或徽章）

**排序规则**：
- 默认按 `updated_at` 倒序
- 可选按 `created_at` 倒序
- 可选按标题首字母排序

**交互操作**：
- 点击卡片 → 进入详情页
- 长按 → 显示操作菜单（编辑、删除、管理网络）
- 滑动 → 快速删除

#### 详情视图

**显示内容**：
- 完整标题
- 完整内容（支持 Markdown 渲染）
- 创建时间和更新时间
- 所属协作空间列表
- 操作按钮（编辑、删除、管理网络）

**交互操作**：
- 点击"编辑" → 进入编辑模式
- 点击"删除" → 显示确认对话框
- 点击"管理网络" → 打开网络管理界面

---

### 3.4 卡片删除

#### 触发条件
- 用户在列表中滑动删除
- 或在详情页点击"删除"按钮
- 或在操作菜单中选择"删除"

#### 操作步骤
1. **显示确认对话框**
   - 提示：「确定要删除这张卡片吗？」
   - 选项："取消" / "删除"

2. **执行删除**
   - 用户点击"删除"
   - 标记卡片为已删除（`deleted = true`）
   - 从列表中隐藏

3. **同步删除状态**
   - 通过 CRDT 同步到其他设备
   - 其他设备上的卡片也被隐藏

#### 预期结果
- ✅ 卡片从列表中消失
- ✅ 删除状态同步到所有设备
- ✅ 显示"已删除"提示（带撤销选项，可选）

#### 异常处理
- **网络断开**：本地删除，等待同步
- **误删除**：提供"撤销"功能（短时间内）

#### 业务规则
- **软删除**：不物理删除数据，仅标记 `deleted = true`
- **同步范围**：删除状态同步到卡片所在的所有协作空间
- **垃圾箱**（未来功能）：可选实现垃圾箱功能，允许恢复

---

### 3.5 卡片网络管理

#### 功能说明
允许用户控制单张卡片加入或退出协作空间。

#### 触发条件
- 用户在卡片详情页点击"管理网络"按钮

#### 操作步骤
1. **显示网络列表**
   - 列出所有可用的协作空间
   - 标记当前卡片已加入的网络（勾选状态）

2. **添加/移除网络**
   - 勾选：将卡片加入该协作空间
   - 取消勾选：将卡片从该协作空间移除

3. **保存更改**
   - 点击"保存"按钮
   - 同步卡片到新加入的协作空间
   - 从移除的协作空间中删除卡片

#### 预期结果
- ✅ 卡片在新加入的协作空间中可见
- ✅ 从移除的协作空间中消失
- ✅ 其他设备实时同步更改

#### 异常处理
- **网络断开**：保存到本地，等待同步
- **权限不足**：某些协作空间可能限制加入（未来功能）

#### 业务规则
- **即时同步**：加入网络后，卡片立即同步到该网络的所有设备
- **删除传播**：从网络移除后，该网络的其他设备上也会删除此卡片
- **孤立卡片**：允许卡片不加入任何网络（仅本地可见）

---

## 4. 界面设计

### 4.1 卡片列表页

```
┌─────────────────────────────────┐
│  CardMind          🔍  ⚙️        │
├─────────────────────────────────┤
│                                 │
│  ┌───────────────────────────┐ │
│  │ 📝 会议记录               │ │
│  │ 今天下午的会议要点...    │ │
│  │ 🌐 工作网络  ⏰ 2小时前   │ │
│  └───────────────────────────┘ │
│                                 │
│  ┌───────────────────────────┐ │
│  │ 💡 项目想法               │ │
│  │ 新功能的初步构思...      │ │
│  │ 🌐 个人网络  ⏰ 昨天      │ │
│  └───────────────────────────┘ │
│                                 │
│              ...                │
│                                 │
│                          ➕ FAB │
└─────────────────────────────────┘
```

### 4.2 卡片详情页

```
┌─────────────────────────────────┐
│  ← 返回              ✏️  🗑️       │
├─────────────────────────────────┤
│                                 │
│  会议记录                        │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                 │
│  今天下午的会议要点：           │
│  1. 确定项目里程碑              │
│  2. 分配任务给团队成员          │
│  3. 下周一进行需求评审          │
│                                 │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                 │
│  📅 创建于 2025-12-24 14:30     │
│  📅 更新于 2025-12-24 16:45     │
│                                 │
│  🌐 所属网络:                   │
│  • 工作网络                     │
│  • 项目协作                     │
│                                 │
│  [管理网络]                     │
│                                 │
└─────────────────────────────────┘
```

### 4.3 创建/编辑页

```
┌─────────────────────────────────┐
│  ✖️ 取消            保存 ✔️       │
├─────────────────────────────────┤
│                                 │
│  标题                           │
│  ┌─────────────────────────┐   │
│  │                         │   │
│  └─────────────────────────┘   │
│                                 │
│  内容                           │
│  ┌─────────────────────────┐   │
│  │                         │   │
│  │                         │   │
│  │                         │   │
│  │                         │   │
│  │                         │   │
│  └─────────────────────────┘   │
│                                 │
│  支持 Markdown 格式              │
│                                 │
└─────────────────────────────────┘
```

---

## 5. 业务规则

### 5.1 常驻网络规则

**定义**：用户可以将一个或多个协作空间设置为"常驻网络"

**规则**：
- 设置了常驻网络后，新建卡片**自动加入**所有常驻网络
- 未设置常驻网络时，新建卡片**不加入任何网络**（孤立状态）
- 用户可以在创建后手动调整卡片的网络归属

**用户场景**：
- 个人用户：设置"个人网络"为常驻，所有卡片自动同步
- 团队用户：设置"工作网络"为常驻，工作相关卡片自动共享

### 5.2 软删除规则

**目的**：支持数据恢复，符合 CRDT 最终一致性

**实现**：
- 删除时不物理删除，仅设置 `deleted = true`
- 查询时过滤掉已删除的卡片
- 保留恢复功能的可能性（垃圾箱）

### 5.3 同步规则

**范围**：
- 卡片仅同步到它加入的协作空间
- 孤立卡片（未加入任何网络）仅存在于本地设备

**时机**：
- 创建/编辑/删除后立即触发同步
- P2P 连接建立后自动同步增量更新
- 离线编辑在网络恢复后自动同步

**冲突解决**：
- 依赖 Loro 的 CRDT 机制自动合并
- 用户无感知，无需手动处理冲突

---

## 6. 错误处理

### 6.1 网络异常

**场景**：用户离线时操作卡片

**处理方式**：
- ✅ 允许所有操作（创建、编辑、删除）
- ✅ 数据保存在本地
- ✅ 显示"离线模式"提示
- ✅ 网络恢复后自动同步

**用户提示**：
```
⚠️ 当前处于离线模式
您的更改已保存在本地，将在网络恢复后自动同步
```

### 6.2 保存失败

**场景**：本地存储空间不足或数据库错误

**处理方式**：
- ❌ 阻止保存操作
- 📢 显示错误提示
- 💾 保留用户输入内容（不关闭编辑界面）

**用户提示**：
```
❌ 保存失败
存储空间不足，请清理后重试
```

### 6.3 并发编辑

**场景**：同一张卡片在多个设备上同时编辑

**处理方式**：
- ✅ CRDT 自动合并更改
- ✅ 无需用户干预
- 📢 可选显示"已同步其他设备的更改"提示

**特殊情况**：
- 如果冲突无法自动解决（极少见），提示用户手动检查内容

### 6.4 网络连接失败

**场景**：无法连接到协作空间中的其他设备

**处理方式**：
- ⏰ 后台持续重试连接
- 📢 显示"正在连接..."状态
- ✅ 允许本地操作继续进行

**用户提示**：
```
🔄 正在连接到协作网络...
您可以继续编辑，更改将在连接后同步
```

---

## 7. 性能要求

### 7.1 响应时间

| 操作 | 目标响应时间 | 说明 |
|------|-------------|------|
| 打开卡片列表 | < 500ms | 从本地 SQLite 读取 |
| 创建新卡片 | < 200ms | 本地写入 + 后台同步 |
| 保存编辑 | < 300ms | 本地更新 + 后台同步 |
| 删除卡片 | < 200ms | 软删除，仅更新标记 |
| 网络管理 | < 500ms | 更新关联关系 |

### 7.2 数据量支持

- **卡片数量**：支持 10,000+ 张卡片
- **单卡片大小**：建议 < 100KB（纯文本）
- **列表滚动**：使用虚拟滚动，流畅加载大量卡片

### 7.3 同步性能

- **增量同步**：仅同步变更部分，不全量传输
- **批量同步**：多个操作合并为一次同步
- **压缩传输**：LoroDoc 二进制数据压缩传输

---

## 8. 未来扩展

### 8.1 垃圾箱功能
- 软删除的卡片可以在垃圾箱中查看
- 支持恢复或永久删除
- 自动清理 30 天前的删除卡片

### 8.2 卡片标签
- 为卡片添加自定义标签
- 按标签筛选和分组

### 8.3 富文本编辑
- 支持图片、链接、代码块
- Markdown 增强功能

### 8.4 版本历史
- 查看卡片的编辑历史
- 回滚到历史版本

---

**文档版本**：v1.0
**最后更新**：2025-12-24
**维护者**：CardMind 产品团队
**参考**：[需求文档](../../01-需求/需求.md) | [概念词典](../概念.md)
