# 协作网络管理

## 1. 概述

协作网络管理功能负责CardMind应用的设备协作和数据同步，确保多个设备能够安全、高效地协同工作并保持数据一致。

## 2. 数据定义

### 2.1 协作网络属性

| 属性名 | 类型 | 描述 |
|--------|------|------|
| id | UUID v7 | 协作网络的唯一标识符 |
| 昵称 | 字符串 | 用于用户识别的显示名称 |
| 密码 | 字符串 | 用于保护协作网络，加入时需要验证 |
| 创建时间 | 时间戳 | 网络创建时间 |
| 更新时间 | 时间戳 | 网络信息最后更新时间 |
| 设备列表 | 数组 | 记录网络内所有设备的信息 |

### 2.2 设备属性

| 属性名 | 类型 | 描述 |
|--------|------|------|
| id | 字符串 | 设备指纹，唯一标识一个设备 |
| 昵称 | 字符串 | 用户友好的设备名称 |
| 创建时间 | 时间戳 | 设备首次加入网络时间 |
| 更新时间 | 时间戳 | 设备信息最后更新时间 |

### 2.3 数据关联
- 一个协作网络对应一个LoroDoc对象，LoroDoc的唯一id即为协作网络id

## 3. 功能设计

### 3.1 网络创建
- **触发时机**：应用首次初始化时
- **功能描述**：自动生成设备ID，并创建一个默认协作网络
- **默认行为**：
  - 为当前设备生成唯一id和默认昵称
  - 默认昵称格式：设备型号+设备id前6位

### 3.2 网络加入
- **功能描述**：通过网络ID和密码验证加入网络
- **加入条件**：需要连接到可访问的信令服务器，并验证网络id和密码

### 3.3 网络退出
- **触发时机**：用户在网络设置中主动退出
- **功能描述**：允许设备退出协作网络
- **退出流程**：
  1. 退出前检查当前设备是否有卡片加入该协作网络
  2. 若存在关联卡片，弹出提示确认
  3. 确认退出后，自动解除所有关联卡片与该网络的绑定关系

### 3.4 设备网络行为
- 初始化时自动加入默认创建的协作网络
- 支持自由加入/退出任意协作网络

### 3.5 常驻网络设置
- **功能描述**：允许用户设置常驻网络
- **默认行为**：未设置常驻网络时，新建卡片默认不加入任何协作网络
- **设置效果**：设置后新建的卡片会自动加入所有常驻网络

## 4. 网络生命周期
- **生命周期**：所有设备退出后，协作网络自动消失

## 5. 服务发现机制
- **基于libp2p**：利用libp2p内置的服务发现能力实现设备间的发现和连接
- **mDNS集成**：通过libp2p的mDNS协议实现本地网络内的设备发现
- **去中心化设计**：无需传统的信令服务器，设备直接通过libp2p建立连接

## 6. 技术实现
- **核心技术**：基于Loro（CRDT协议）和libp2p（P2P网络协议）
- **libp2p使用**：Rust端通过libp2p实现设备间的组网、通信和服务发现，替代WebRTC和传统信令服务
