# 协作空间管理功能设计

> 本文档描述 CardMind 应用的协作空间管理功能，包括用户交互、业务流程和异常处理。数据模型请参考 [需求文档 §2.2](../../01-需求/需求.md#22-协作网络collaborationspace)。

---

## 1. 功能概述

协作空间管理功能负责设备间的协作和数据同步，确保多个设备能够安全、高效地协同工作并保持数据一致。

**核心价值**：
- 多设备无缝协作
- 去中心化的 P2P 数据同步
- 灵活的网络加入/退出机制

---

## 2. 用户场景

### 2.1 首次使用（初始化）
**场景描述**：用户第一次打开应用

**自动流程**：
1. 应用检测到首次启动
2. 自动生成设备唯一 ID（基于设备指纹）
3. 创建默认设备昵称（如：iPhone-abc123）
4. 自动创建一个默认协作空间
5. 当前设备自动加入该空间

### 2.2 创建新的协作空间
**场景描述**：用户想要创建新的协作空间用于特定目的（如工作、家庭）

**典型流程**：
1. 进入设置 → 协作空间管理
2. 点击"创建新空间"按钮
3. 输入空间昵称和密码
4. 确认创建
5. 新空间出现在列表中，当前设备自动加入

### 2.3 加入已有协作空间
**场景描述**：用户想要加入其他设备创建的协作空间

**典型流程**：
1. 获取协作空间的 ID 和密码（通过其他渠道）
2. 进入设置 → 协作空间管理
3. 点击"加入空间"按钮
4. 输入空间 ID 和密码
5. 验证成功后加入空间
6. 开始同步该空间的卡片数据

### 2.4 退出协作空间
**场景描述**：用户不再需要某个协作空间

**典型流程**：
1. 进入设置 → 协作空间管理
2. 选择要退出的空间
3. 点击"退出"按钮
4. 系统检查是否有卡片关联该空间
5. 如有关联，显示确认提示
6. 确认后退出，解除所有卡片关联

### 2.5 设置常驻空间
**场景描述**：用户希望新建卡片自动加入常用空间

**典型流程**：
1. 进入设置 → 协作空间管理
2. 选择一个或多个空间
3. 标记为"常驻空间"
4. 保存设置
5. 之后新建的卡片自动加入所有常驻空间

---

## 3. 功能详细设计

### 3.1 协作空间创建

#### 触发条件
- 应用首次初始化（自动创建）
- 用户手动创建新空间

#### 操作步骤（手动创建）
1. **打开创建界面**
   - 显示昵称输入框
   - 显示密码输入框
   - 显示"创建"和"取消"按钮

2. **输入信息**
   - 昵称：用户友好的显示名称
   - 密码：用于保护空间的访问密码

3. **创建空间**
   - 点击"创建"按钮
   - 生成 UUID v7 作为空间 ID
   - 创建对应的 LoroDoc 对象
   - 将当前设备添加到设备列表

#### 预期结果
- ✅ 协作空间成功创建
- ✅ 当前设备自动加入
- ✅ 空间出现在管理列表中
- ✅ 显示空间 ID（用于分享）

#### 异常处理
- **昵称为空**：使用默认昵称"我的协作空间"
- **密码为空**：提示设置密码（必填）
- **创建失败**：显示错误提示，保留用户输入

#### 业务规则
- **唯一 ID**：每个空间有全局唯一的 UUID v7
- **初始设备**：创建者设备自动成为第一个成员
- **默认空间**：首次初始化时自动创建的空间可标记为"默认"

---

### 3.2 加入协作空间

#### 触发条件
- 用户手动输入空间 ID 和密码

#### 操作步骤
1. **打开加入界面**
   - 显示空间 ID 输入框
   - 显示密码输入框
   - 显示"加入"和"取消"按钮

2. **输入凭据**
   - 空间 ID：粘贴或输入
   - 密码：输入访问密码

3. **验证并加入**
   - 点击"加入"按钮
   - 通过 P2P 网络查找目标空间
   - 验证密码是否正确
   - 将当前设备添加到空间的设备列表
   - 开始同步空间数据

#### 预期结果
- ✅ 成功加入协作空间
- ✅ 空间出现在管理列表中
- ✅ 开始同步该空间的卡片数据
- ✅ 设备出现在其他成员的设备列表中

#### 异常处理
- **空间 ID 不存在**：提示"找不到该协作空间"
- **密码错误**：提示"密码错误，请重试"
- **网络连接失败**：提示"无法连接，请检查网络"
- **已加入该空间**：提示"您已在该空间中"

#### 业务规则
- **P2P 发现**：通过 libp2p 查找目标空间的在线设备
- **密码验证**：必须验证密码才能加入
- **自动同步**：加入后自动同步空间中的所有卡片

---

### 3.3 退出协作空间

#### 触发条件
- 用户在空间管理界面选择"退出"

#### 操作步骤
1. **检查卡片关联**
   - 查询当前设备的卡片中是否有关联该空间的
   - 统计关联卡片数量

2. **显示确认对话框**
   - 如果有关联卡片：
     ```
     ⚠️ 您有 X 张卡片关联到该协作空间
     退出后，这些卡片将从该空间移除
     是否继续？
     ```
   - 如果没有关联卡片：
     ```
     确定要退出该协作空间吗？
     ```

3. **执行退出**
   - 用户确认后：
     - 将设备从空间的设备列表中移除
     - 解除所有关联卡片与该空间的绑定
     - 停止同步该空间的数据
   - 同步删除状态到其他设备

#### 预期结果
- ✅ 当前设备从空间中移除
- ✅ 关联卡片从该空间移除
- ✅ 空间从管理列表中消失
- ✅ 其他设备的设备列表中不再显示该设备

#### 异常处理
- **网络断开**：本地退出，等待同步
- **最后一个设备**：空间自动销毁

#### 业务规则
- **关联解除**：退出时自动解除所有卡片关联
- **空间销毁**：所有设备退出后，空间自动消失
- **数据保留**：退出不影响本地卡片数据（仅解除关联）

---

### 3.4 设置常驻空间

#### 功能说明
常驻空间是用户指定的默认空间，新建卡片将自动加入这些空间。

#### 触发条件
- 用户在空间管理界面设置

#### 操作步骤
1. **打开空间列表**
   - 显示所有已加入的协作空间
   - 标记当前的常驻空间（勾选状态）

2. **选择常驻空间**
   - 勾选：设置为常驻空间
   - 取消勾选：取消常驻状态
   - 支持多选

3. **保存设置**
   - 点击"保存"按钮
   - 更新常驻空间配置

#### 预期结果
- ✅ 常驻空间设置生效
- ✅ 新建卡片自动加入常驻空间
- ✅ 已有卡片不受影响

#### 业务规则
- **多空间支持**：允许设置多个常驻空间
- **新卡片自动加入**：仅影响新建卡片，不影响已有卡片
- **默认行为**：未设置常驻空间时，新卡片不加入任何空间

---

## 4. 界面设计

### 4.1 协作空间列表

```
┌─────────────────────────────────┐
│  ← 设置     协作空间管理         │
├─────────────────────────────────┤
│                                 │
│  ┌───────────────────────────┐ │
│  │ 📁 个人笔记                │ │
│  │ 3 台设备  •  100 张卡片    │ │
│  │ ⭐ 常驻空间                │ │
│  └───────────────────────────┘ │
│                                 │
│  ┌───────────────────────────┐ │
│  │ 💼 工作协作                │ │
│  │ 5 台设备  •  45 张卡片     │ │
│  │                            │ │
│  └───────────────────────────┘ │
│                                 │
│  ┌───────────────────────────┐ │
│  │ 🏠 家庭共享                │ │
│  │ 2 台设备  •  20 张卡片     │ │
│  │ ⭐ 常驻空间                │ │
│  └───────────────────────────┘ │
│                                 │
│  [➕ 创建新空间] [🔗 加入空间]  │
│                                 │
└─────────────────────────────────┘
```

### 4.2 创建协作空间

```
┌─────────────────────────────────┐
│  ✖️ 取消      创建协作空间  ✔️   │
├─────────────────────────────────┤
│                                 │
│  空间昵称                        │
│  ┌─────────────────────────┐   │
│  │ 我的工作空间            │   │
│  └─────────────────────────┘   │
│                                 │
│  访问密码                        │
│  ┌─────────────────────────┐   │
│  │ ••••••••                │   │
│  └─────────────────────────┘   │
│                                 │
│  💡 密码用于保护空间安全         │
│     请妥善保管                   │
│                                 │
│  [创建并加入]                   │
│                                 │
└─────────────────────────────────┘
```

### 4.3 加入协作空间

```
┌─────────────────────────────────┐
│  ✖️ 取消      加入协作空间  🔗   │
├─────────────────────────────────┤
│                                 │
│  空间 ID                        │
│  ┌─────────────────────────┐   │
│  │ 01234567-89ab-...       │   │
│  └─────────────────────────┘   │
│  [📋 粘贴]                      │
│                                 │
│  访问密码                        │
│  ┌─────────────────────────┐   │
│  │ ••••••••                │   │
│  └─────────────────────────┘   │
│                                 │
│  💡 向空间创建者索取 ID 和密码   │
│                                 │
│  [验证并加入]                   │
│                                 │
└─────────────────────────────────┘
```

---

## 5. 业务规则

### 5.1 空间生命周期

**创建**：
- 由第一个设备创建
- 生成唯一 UUID v7 作为标识
- 创建对应的 LoroDoc 对象

**活跃期**：
- 至少有一个设备在线
- 可以添加/移除设备
- 可以同步卡片数据

**销毁**：
- 所有设备退出后自动销毁
- LoroDoc 数据在各设备本地保留（历史记录）

### 5.2 设备管理

**设备加入**：
- 通过空间 ID 和密码验证
- 成功后添加到设备列表
- 自动同步空间数据

**设备退出**：
- 主动退出或长时间离线
- 从设备列表中移除
- 停止同步该空间

**设备健康检查**：
- 通过 `device_health` 表监测在线状态
- 定期发送心跳信号
- 长时间无响应标记为离线

### 5.3 数据同步规则

**同步范围**：
- 仅同步加入了该空间的卡片
- 孤立卡片不同步

**同步时机**：
- 设备加入空间时：全量同步
- 卡片加入空间时：增量同步
- 卡片编辑时：实时同步
- P2P 连接建立后：自动同步

**冲突处理**：
- 依赖 Loro 的 CRDT 机制
- 自动合并冲突
- 无需用户干预

---

## 6. 错误处理

### 6.1 无法找到协作空间

**场景**：输入的空间 ID 不存在或所有设备都离线

**处理方式**：
- 📢 提示"找不到该协作空间"
- 🔄 提供"重试"选项
- 💡 建议检查 ID 是否正确

**用户提示**：
```
❌ 找不到该协作空间
请检查空间 ID 是否正确，或稍后重试
```

### 6.2 密码验证失败

**场景**：输入的密码不匹配

**处理方式**：
- 📢 提示"密码错误"
- 🔄 允许重新输入
- 🔒 连续失败 3 次后短暂锁定

**用户提示**：
```
❌ 密码错误
请重新输入正确的密码
```

### 6.3 网络连接失败

**场景**：无法建立 P2P 连接

**处理方式**：
- ⏰ 后台持续重试
- 📢 显示"正在连接..."状态
- 💡 提示检查网络设置

**用户提示**：
```
🔄 正在连接到协作空间...
请确保网络畅通，或稍后重试
```

### 6.4 退出空间时有卡片关联

**场景**：用户退出时有卡片关联该空间

**处理方式**：
- ⚠️ 显示警告对话框
- 📊 列出关联卡片数量
- 🤔 要求用户确认

**用户提示**：
```
⚠️ 您有 15 张卡片关联到该协作空间

退出后，这些卡片将从该空间移除，
其他设备将无法访问这些卡片。

是否继续退出？
[取消] [确认退出]
```

---

## 7. 性能要求

### 7.1 响应时间

| 操作 | 目标响应时间 | 说明 |
|------|-------------|------|
| 加载空间列表 | < 300ms | 从本地 SQLite 读取 |
| 创建新空间 | < 500ms | 本地创建 + 生成 ID |
| 加入空间 | < 3s | 包含 P2P 发现和验证 |
| 退出空间 | < 500ms | 本地操作 + 通知 |
| 设置常驻空间 | < 200ms | 更新配置 |

### 7.2 P2P 连接性能

- **设备发现**：通过 mDNS 在局域网内 < 2s
- **密码验证**：< 500ms
- **初始同步**：根据数据量，100 张卡片约 5-10s

### 7.3 并发支持

- **同时在线设备**：支持 10+ 设备同时在线
- **并发编辑**：CRDT 保证数据一致性
- **网络带宽**：优化传输，减少带宽占用

---

## 8. 安全性设计

### 8.1 密码保护

- **强制密码**：创建空间时必须设置密码
- **密码加密**：本地存储时加密
- **验证机制**：加入时必须验证密码

### 8.2 P2P 安全

- **加密传输**：libp2p noise 协议加密通信
- **身份验证**：基于设备指纹识别
- **访问控制**：仅允许已验证的设备同步数据

### 8.3 数据隐私

- **本地存储**：数据优先存储在本地
- **去中心化**：无中心服务器，数据不上传云端
- **隔离同步**：不同空间的数据互相隔离

---

## 9. 未来扩展

### 9.1 空间管理增强
- 空间管理员角色
- 设备权限控制（只读/读写）
- 邀请链接生成

### 9.2 高级同步功能
- 选择性同步（仅同步部分卡片）
- 同步历史查看
- 冲突解决可视化

### 9.3 性能优化
- 增量同步优化
- 断点续传
- 智能压缩

---

**文档版本**：v1.0
**最后更新**：2025-12-24
**维护者**：CardMind 产品团队
**参考**：[需求文档](../../01-需求/需求.md) | [概念词典](../概念.md)
