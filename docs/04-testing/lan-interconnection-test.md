# 🧪 CardMind 局域网多设备互联测试指南

## 📋 测试概述

本测试指南用于验证CardMind项目在局域网环境下的多设备点对点互联功能，确保WebRTC连接、数据同步和设备发现功能正常工作。

## 🏠 测试环境要求

### 网络环境
- **同一局域网**: 所有测试设备必须连接到同一个WiFi或有线网络
- **无VPN**: 关闭所有VPN连接
- **防火墙配置**: 允许WebRTC流量（UDP端口3478-3497，TCP端口80/443）
- **IP连通性**: 设备间可以互相ping通

### 设备要求
- **最少2台设备**: 用于测试点对点连接
- **推荐3-4台设备**: 测试多点对多点组网
- **现代浏览器**: Chrome 80+, Firefox 75+, Safari 13+
- **支持WebRTC**: 所有设备必须支持WebRTC API

## 🔧 测试准备

### 1. 启动多个实例

#### 方法A: 不同端口启动（推荐）
```bash
# 设备A - 主机（端口3000）
pnpm dev --port 3000

# 设备B - 客户端1（端口3001）  
pnpm dev --port 3001

# 设备C - 客户端2（端口3002）
pnpm dev --port 3002

# 设备D - 客户端3（端口3003）
pnpm dev --port 3003
```

#### 方法B: 修改vite配置
```typescript
// vite.config.ts
export default defineConfig({
  server: {
    host: '0.0.0.0',  // 允许局域网访问
    port: 3000,
    strictPort: false,  // 端口被占用时自动寻找可用端口
  }
});
```

### 2. 网络连通性检查
```bash
# 在每台设备上执行，确保能ping通其他设备
ping 192.168.1.100  # 设备A的IP
ping 192.168.1.101  # 设备B的IP
ping 192.168.1.102  # 设备C的IP
```

### 3. 获取设备IP地址
```bash
# Windows
ipconfig

# macOS/Linux  
ifconfig
# 或
ip addr show
```

## 🧪 测试步骤

### 测试1: 基础连接测试

#### 步骤1.1: 创建网络（主机）
1. 在设备A上打开应用：`http://localhost:3000`
2. 点击右上角"网络"图标
3. 选择"创建网络"
4. 系统生成访问码（格式：`base64编码的JSON，包含地址、时间戳、随机码`）
5. 复制访问码

#### 步骤1.2: 加入网络（客户端）
1. 在设备B上打开应用：`http://localhost:3001`
2. 点击右上角"网络"图标
3. 选择"加入网络"
4. 粘贴从设备A复制的访问码
5. 点击"加入网络"

#### 步骤1.3: 验证连接
1. **观察网络状态图标**: 
   - ✅ 绿色: 已连接
   - ⏳ 黄色: 连接中
   - ❌ 红色: 未连接

2. **查看设备列表**:
   - 应该看到所有在线设备
   - 设备名称和地址应该正确显示

3. **使用测试工具**:
   - 访问 `http://localhost:3000/test-network.html`
   - 点击"开始网络测试"
   - 观察连接状态变化

#### 预期结果
- WebRTC状态: ✅ 已连接
- BroadcastChannel: ✅ 活动
- 连接设备数: 1
- 数据同步: ✅ 同步中

### 测试2: 多点连接测试

#### 步骤2.1: 添加更多设备
重复测试1的步骤，将设备C和设备D加入网络：
```
设备A (主机) ←→ 设备B (客户端1)
    ↕              ↕
设备C (客户端2) ←→ 设备D (客户端3)
```

#### 步骤2.2: 验证全网状连接
1. **检查每台设备的连接数**: 应该显示3个连接设备
2. **验证设备发现**: 所有设备应该能看到彼此
3. **测试网络延迟**: 使用ping命令测试设备间延迟

#### 预期结果
- 每台设备显示3个连接设备
- 所有设备间可以互相发现
- 网络延迟 < 100ms（理想情况）

### 测试3: 数据同步测试

#### 步骤3.1: 创建测试卡片
1. 在设备A上创建一张新卡片
2. 填写标题和内容
3. 保存卡片

#### 步骤3.2: 验证自动同步
1. 在其他设备上观察卡片列表
2. 新卡片应该自动出现
3. 检查卡片内容是否完全一致

#### 步骤3.3: 编辑冲突测试
1. 同时在两台设备上编辑同一张卡片
2. 保存修改
3. 观察冲突解决机制

#### 步骤3.4: 删除同步测试
1. 在一台设备上删除卡片
2. 验证其他设备上卡片被删除
3. 检查回收站/历史记录

#### 预期结果
- 卡片创建: ✅ 自动同步到所有设备
- 卡片编辑: ✅ 内容一致，冲突正确处理
- 卡片删除: ✅ 同步删除操作
- 同步延迟: < 2秒

### 测试4: 网络状态监控测试

#### 步骤4.1: 使用内置监控组件
1. 在主界面右下角找到网络状态监控组件
2. 观察实时连接状态
3. 点击展开查看详细信息

#### 步骤4.2: 执行网络测试
1. 点击"网络测试"按钮
2. 观察测试结果
3. 检查测试历史记录

#### 步骤4.3: 断开重连测试
1. 关闭一台设备的浏览器
2. 观察其他设备的连接状态变化
3. 重新打开浏览器
4. 验证自动重连

#### 预期结果
- 状态显示: ✅ 实时更新
- 测试功能: ✅ 正常运行
- 断线重连: ✅ 自动恢复

### 测试5: 边界条件测试

#### 步骤5.1: 网络中断测试
1. 断开一台设备的网络连接
2. 观察其他设备的反应
3. 重新连接网络
4. 验证数据同步恢复

#### 步骤5.2: 浏览器刷新测试
1. 在一台设备上刷新浏览器
2. 验证重新加入网络
3. 检查数据完整性

#### 步骤5.3: 多标签页测试
1. 在同一台设备上打开多个标签页
2. 验证标签页间同步
3. 检查冲突处理

#### 预期结果
- 网络中断: ✅ 优雅处理，重连后恢复
- 浏览器刷新: ✅ 自动重连
- 多标签页: ✅ 正常工作

## 📊 测试验证清单

### ✅ 连接验证
- [ ] 所有设备成功加入网络
- [ ] WebRTC连接状态显示"已连接"
- [ ] BroadcastChannel状态显示"活动"
- [ ] 设备间可以互相发现

### ✅ 数据同步验证
- [ ] 卡片创建自动同步
- [ ] 卡片编辑实时更新
- [ ] 卡片删除同步执行
- [ ] 同步延迟在可接受范围内

### ✅ 状态监控验证
- [ ] 网络状态实时显示
- [ ] 连接设备数量正确
- [ ] 在线设备列表准确
- [ ] 测试功能正常运行

### ✅ 稳定性验证
- [ ] 断线重连功能正常
- [ ] 浏览器刷新后自动恢复
- [ ] 网络中断处理优雅
- [ ] 多标签页工作正常

## 🔍 故障排除

### 常见问题1: 设备无法发现
**症状**: 加入网络后看不到其他设备
**解决方案**:
1. 检查所有设备是否在同一局域网
2. 确认防火墙未阻止WebRTC端口
3. 尝试刷新页面重新加入
4. 检查浏览器控制台错误信息

### 常见问题2: 数据同步失败
**症状**: 卡片创建后未同步到其他设备
**解决方案**:
1. 验证WebRTC连接状态
2. 检查IndexedDB是否正常工作
3. 查看同步服务日志
4. 尝试手动触发同步

### 常见问题3: 连接不稳定
**症状**: 连接频繁断开
**解决方案**:
1. 检查网络信号强度
2. 降低设备间距离
3. 重启路由器
4. 使用有线连接替代WiFi

## 📈 性能指标

### 连接性能
- **连接建立时间**: < 5秒
- **设备发现时间**: < 3秒
- **重连恢复时间**: < 10秒

### 同步性能
- **数据同步延迟**: < 2秒
- **批量数据同步**: < 5秒（100张卡片）
- **冲突解决时间**: < 1秒

### 资源使用
- **内存占用**: < 100MB
- **CPU使用率**: < 10%
- **网络带宽**: < 1Mbps

## 🎯 测试完成标准

测试完成需要满足以下条件：
1. ✅ 所有基础连接测试通过
2. ✅ 数据同步功能正常工作
3. ✅ 网络状态监控准确
4. ✅ 边界条件处理正确
5. ✅ 性能指标达到要求

## 📋 测试报告

测试完成后，请记录以下信息：
- 测试日期和时间
- 参与测试的设备信息
- 网络环境描述
- 测试结果总结
- 发现的问题和建议

使用测试工具导出详细的测试报告：`test-network.html` → "导出测试报告"