# CardMind 需求文档

## 1. 概述

本文档描述了CardMind项目的功能需求和技术要求，面向产品经理、开发人员和测试人员。CardMind是一个现代化的笔记卡片管理应用，支持多设备间数据同步和离线使用。

## 2. 核心内容

### 2.1 卡片管理
- **创建、编辑、查看和删除卡片**
  - 卡片包含：标题、内容、创建时间和修改时间
  - 标题限制：最多20个字符，允许为空
  - 内容限制：最多2000个字符，不能为空
  - 创建时间精度：毫秒级
  - 修改时间精度：毫秒级

- **卡片排序与显示**
  - 排序规则：按修改时间倒序，相同时间按标题字母顺序排序
  - 卡片数量：无限制
  - 空列表提示：当卡片列表为空时显示"当前卡片列表为空，请添加卡片"

- **删除与撤销**
  - 删除确认：需要二次确认，删除后无法撤销
  - 暂不支持撤销删除功能
  - 暂不支持数据导出/导入功能

- **数据同步**
  - 数据合并：使用yjs的CRDT算法实现无冲突数据合并，无需用户干预

### 2.2 多设备间数据流转
- **同步机制**
  - 支持在多个设备间同步卡片数据
  - 支持离线使用，数据本地存储
  - 无需后端服务器配合

- **数据导入导出**
  - 暂不支持数据导出功能
  - 数据导入通过设备间直连同步实现，无需手动导入导出文件

### 2.3 基本安全保护
- 本地数据加密存储
- 防止未授权访问

### 2.4 用户身份认证与协作网络管理

#### 2.4.1 网络ID与设备ID
- **网络ID机制**
  - 基于网络ID的认证机制
  - 每个设备均可生成唯一网络ID，作为协作网络的唯一标识
  - 网络ID是协作网络的核心标识
  - 网络ID生成方式：随机字符串

- **设备ID机制**
  - 每个设备生成并存储唯一的设备ID，用于在协作网络中区分不同设备
  - 设备ID在设备首次使用时自动生成，本地存储，无需用户干预
  - 设备ID用于标识数据变更来源，支持冲突解决和协同编辑

- **设备昵称**
  - 支持为设备设置友好的设备昵称，提高设备识别的可读性
  - 设备昵称可在设置页面中自定义修改
  - 设备昵称默认使用设备类型和随机字符组合自动生成

#### 2.4.2 Access Code机制
- **Access Code定义**
  - 设备通过输入Access Code加入已存在的协作网络
  - Access Code是包含网络ID和连接信息的加入凭证
  - 同一网络ID下的所有设备共享相同的卡片数据

- **Access Code组成**
  - 网络ID：标识目标协作网络
  - WebRTC连接信息：包含所有设备IP地址列表和信令服务器端口，基于y-webrtc的点对点连接所需参数
  - 时间戳：用于连接有效性验证
  - 设备标识：生成该Access Code的设备信息

当设备具备多个IP地址时（如多网卡设备或虚拟机环境），系统会自动收集所有可用的本地IP地址（包括使用WebRTC技术获取的局域网IP）并包含在Access Code中。其他实例加入网络时，会尝试使用列表中的所有IP地址建立连接，直到成功连接到信令服务器。

- **Access Code生成与使用**
  - 生成时机：创建新网络时实时生成、在设置页面中可手动实时生成
  - 存储方式：不持久化存储，每次需要时重新生成
  - 使用方式：通过复制粘贴方式分享，在加入网络界面提供Access Code输入框
  - 连接方式：仅支持Access Code方式加入网络

- **Access Code格式与错误处理**
  - 格式：字符串形式，长度根据内容动态调整（通常20-100个字符）
  - 编码：使用URL安全的Base64编码，便于复制和传输
  - 错误处理：
    - 无效Access Code：提示"Access Code格式错误或不完整"
    - 网络不存在：提示"目标网络不存在或已解散"
    - 连接超时：提示"网络连接超时，请检查网络环境"

#### 2.4.3 网络原则
- 遵循离线优先原则，无需依赖后端服务器
- 无需第三方授权，简化用户交互流程
- 适用于家庭局域网协同组网场景

### 2.5 用户界面与交互需求

#### 2.5.1 主页布局
- 应用默认显示主页界面，分为底部导航栏和内容区域
- 内容区域默认显示卡片列表

#### 2.5.2 网络认证界面
- 应用首次启动时显示网络加入页面（通过Access Code加入）
- 提供跳过选项，允许用户暂时不加入任何网络
- 提供输入框用于输入Access Code
- 提供加入按钮，点击后解析Access Code并加入对应网络
- 提供Access Code格式说明和使用帮助

#### 2.5.3 网络设置界面
- **网络设置入口**
  - 在设置页面中提供专门的网络设置选项

- **网络信息显示**
  - 网络连接状态：显示"已连接到网络"或"未连接到网络"
  - 当前网络ID：显示正在协作的网络标识符

- **设备列表管理**
  - 在线设备列表：显示当前网络中的所有在线设备，包括设备ID、设备昵称、设备类型
  - 设备数量统计：显示当前网络中的设备总数（包括本设备）
  - 连接状态指示：通过颜色标识（绿色=在线，灰色=离线）
  - 实时更新：设备列表会根据网络连接状态实时更新
  - 设备识别：当前设备会有特殊标识（如"当前设备"标签）

- **网络状态监控**
  - 最后同步时间：显示最近一次数据同步的时间戳
  - 网络健康状态：显示网络连接质量（如延迟、连接稳定性）

- **Access Code功能**
  - 提供"生成Access Code"按钮（点击后实时生成并显示）
  - 生成的Access Code显示在弹窗中，支持一键复制
  - 提供Access Code使用说明提示
  - Access Code生成后仅显示一次，关闭弹窗后不再保存

#### 2.5.4 卡片列表（查）
- 按修改时间排序，最新的卡片显示在最上方
- 每张卡片显示：部分标题、部分内容、创建时间和修改时间

#### 2.5.5 卡片详情（查）
- 点击卡片列表中的任一卡片后弹起详情窗口
- 窗口大小为全屏的60%到80%（待定）
- 窗口显示：完整标题、完整内容、创建时间和修改时间
- 窗口外有遮罩层，点击遮罩层可关闭窗口
- 卡片内容超出窗口时，内容容器提供滑动条
- 卡片内容文字自动换行

#### 2.5.6 添加卡片（增）
- 主页内容区底部、底部导航栏上方有浮空按钮用于添加新卡片
- 点击后弹出编辑窗口，大小与详情窗口一致
- 窗口中可输入卡片标题和内容
- 实时显示标题字数统计（0/20）和内容字数统计（当前/2000）
- 当内容为空或超出字数限制时，确定按钮置灰不可点击
- 内容超出窗口时提供滑动条和自动换行
- 窗口底部有确定和取消按钮
- 点击取消时显示二次确认弹窗，提醒内容将被清空

#### 2.5.7 删除卡片（删）
- 在卡片列表中左滑或长按出现删除按钮（待定）
- 点击删除按钮后显示二次确认弹窗，防止误删

#### 2.5.8 修改卡片（改）
- 交互方式与删除功能相同
- 点击修改按钮后弹出编辑窗口，默认填充当前卡片的标题和内容
- 编辑窗口的交互与添加卡片相同

## 3. 注意事项

### 3.1 数据安全与隐私
- 所有数据默认在本地加密存储，不上传到第三方服务器
- Access Code包含敏感连接信息，不应通过不安全的渠道分享
- 离线使用时，数据仅存储在本地设备上

### 3.2 网络连接限制
- 设备间直连同步需要在同一局域网环境下
- 不同网络环境下的设备无法直接同步数据
- 网络连接质量会影响数据同步的实时性

### 3.3 功能限制
- 暂不支持撤销删除操作，删除前请仔细确认
- 暂不支持数据导出/导入功能
- 卡片内容有字数限制，请注意内容长度

### 3.4 兼容性考虑
- 不同平台的实现可能有细微差异
- 跨平台同步时需确保所有设备版本兼容
- 旧版本可能不支持新功能

## 4. 关联文档

- [技术栈文档](../03-technical/0301-tech-stack.md) - 了解项目使用的技术栈
- [技术概念文档](../03-technical/0302-tech-concepts.md) - 理解核心概念和原理
- [实现计划文档](../03-technical/0303-implementation-plan.md) - 查看功能实现计划
- [API文档](../03-technical/0302-unified-business-logic-design.md) - 了解接口设计
- [测试文档](../04-testing/0401-lan-interconnection-test.md) - 查看测试方案