# CardMind API文档

## 1. 概述

本文档介绍CardMind应用的核心API接口，包括认证服务、卡片服务、设备服务、加密服务和同步服务的接口定义和使用方法。

## 2. 认证服务 (AuthService)

### 2.1 接口定义

```typescript
/**
 * 认证服务接口
 */
export interface AuthService {
  /**
   * 生成新的网络ID
   * @returns 生成的网络ID
   */
  generateNetworkId(): Promise<string>;

  /**
   * 加入网络
   * @param networkId 要加入的网络ID
   * @returns 加入结果
   */
  joinNetwork(networkId: string): Promise<{ success: boolean; message?: string }>;

  /**
   * 验证网络ID格式
   * @param networkId 要验证的网络ID
   * @returns 验证结果
   */
  validateNetworkId(networkId: string): boolean;

  /**
   * 获取当前网络ID
   * @returns 当前网络ID，如果未加入网络则返回null
   */
  getCurrentNetworkId(): string | null;

  /**
   * 离开当前网络
   */
  leaveNetwork(): void;

  /**
   * 生成临时访问码
   * @param expiryMinutes 访问码有效期（分钟），默认5分钟
   * @returns 生成的访问码
   */
  generateAccessCode(expiryMinutes?: number): string;

  /**
   * 验证访问码
   * @param accessCode 要验证的访问码
   * @returns 验证结果，包含网络ID或错误信息
   */
  validateAccessCode(accessCode: string): { valid: boolean; networkId?: string; error?: string };
}
```

### 2.2 核心功能
- 网络ID生成与验证
- 网络加入与离开
- Access Code生成与验证
- 当前网络状态管理

## 3. 卡片服务 (CardService)

### 3.1 接口定义

```typescript
/**
 * 卡片服务接口
 */
export interface CardService {
  /**
   * 创建新卡片
   * @param cardData 卡片数据
   * @returns 创建的卡片
   */
  createCard(cardData: Omit<Card, 'id' | 'createdAt' | 'updatedAt' | 'isDeleted'>): Promise<Card>;

  /**
   * 获取所有卡片
   * @returns 卡片列表
   */
  getAllCards(): Promise<Card[]>;

  /**
   * 根据ID获取卡片
   * @param id 卡片ID
   * @returns 卡片对象或null
   */
  getCardById(id: string): Promise<Card | null>;

  /**
   * 更新卡片
   * @param id 卡片ID
   * @param cardData 更新的卡片数据
   * @returns 更新后的卡片
   */
  updateCard(id: string, cardData: Partial<Omit<Card, 'id' | 'createdAt'>>): Promise<Card>;

  /**
   * 删除卡片
   * @param id 卡片ID
   * @returns 删除结果
   */
  deleteCard(id: string): Promise<{ success: boolean; message?: string }>;

  /**
   * 获取已删除的卡片
   * @returns 已删除的卡片列表
   */
  getDeletedCards(): Promise<Card[]>;

  /**
   * 恢复已删除的卡片
   * @param id 卡片ID
   * @returns 恢复后的卡片
   */
  restoreCard(id: string): Promise<Card>;
}
```

### 3.2 卡片数据模型

```typescript
/**
 * 卡片实体
 */
export interface Card {
  /** 卡片唯一标识符 */
  id: string;
  /** 卡片标题 */
  title: string;
  /** 卡片内容 */
  content: string;
  /** 创建时间 */
  createdAt: number;
  /** 更新时间 */
  updatedAt: number;
  /** 是否已删除 */
  isDeleted: boolean;
  /** 最后修改设备ID */
  lastModifiedBy: string;
}
```

## 4. 设备服务 (DeviceService)

### 4.1 接口定义

```typescript
/**
 * 设备服务接口
 */
export interface DeviceService {
  /**
   * 初始化设备信息
   * @returns 设备信息
   */
  initializeDevice(): Promise<Device>;

  /**
   * 获取当前设备信息
   * @returns 当前设备信息
   */
  getCurrentDevice(): Promise<Device>;

  /**
   * 更新设备昵称
   * @param nickname 新的设备昵称
   * @returns 更新后的设备信息
   */
  updateDeviceNickname(nickname: string): Promise<Device>;

  /**
   * 获取网络中的设备列表
   * @returns 设备列表
   */
  getNetworkDevices(): Promise<Device[]>;

  /**
   * 监听设备状态变化
   * @param callback 状态变化回调
   * @returns 取消监听函数
   */
  onDeviceStatusChange(callback: (devices: Device[]) => void): () => void;
}
```

### 4.2 设备数据模型

```typescript
/**
 * 设备实体
 */
export interface Device {
  /** 设备唯一标识符 */
  id: string;
  /** 设备昵称 */
  nickname: string;
  /** 设备类型 */
  deviceType: 'mobile' | 'tablet' | 'desktop' | 'web';
  /** 设备平台 */
  platform: string;
  /** 设备版本 */
  version: string;
  /** 设备创建时间 */
  createdAt: number;
  /** 最后在线时间 */
  lastSeen: number;
  /** 是否在线 */
  isOnline: boolean;
}
```

## 5. 加密服务 (EncryptionService)

### 5.1 接口定义

```typescript
/**
 * 加密服务接口
 */
export interface EncryptionService {
  /**
   * 加密数据
   * @param data 要加密的数据
   * @returns 加密后的数据
   */
  encrypt(data: string): Promise<string>;

  /**
   * 解密数据
   * @param encryptedData 加密的数据
   * @returns 解密后的数据
   */
  decrypt(encryptedData: string): Promise<string>;

  /**
   * 生成加密密钥
   * @returns 加密密钥
   */
  generateKey(): Promise<string>;

  /**
   * 导出加密密钥
   * @returns 导出的密钥
   */
  exportKey(): Promise<string>;

  /**
   * 导入加密密钥
   * @param key 要导入的密钥
   */
  importKey(key: string): Promise<void>;

  /**
   * 检查是否已设置加密密钥
   * @returns 是否已设置密钥
   */
  hasKey(): Promise<boolean>;
}
```

## 6. 同步服务 (SyncService)

### 6.1 接口定义

```typescript
/**
 * 同步服务接口
 */
export interface SyncService {
  /**
   * 初始化同步服务
   * @param networkId 网络ID
   */
  initialize(networkId: string): Promise<void>;

  /**
   * 开始同步
   */
  startSync(): Promise<void>;

  /**
   * 停止同步
   */
  stopSync(): Promise<void>;

  /**
   * 获取同步状态
   * @returns 同步状态
   */
  getSyncStatus(): SyncStatus;

  /**
   * 监听同步状态变化
   * @param callback 状态变化回调
   * @returns 取消监听函数
   */
  onSyncStatusChange(callback: (status: SyncStatus) => void): () => void;

  /**
   * 监听同步错误
   * @param callback 错误回调
   * @returns 取消监听函数
   */
  onSyncError(callback: (error: Error) => void): () => void;

  /**
   * 触发手动同步
   */
  triggerSync(): Promise<void>;
}
```

### 6.2 同步状态类型

```typescript
/**
 * 同步状态
 */
export type SyncStatus = 'idle' | 'syncing' | 'synced' | 'error';
```

## 7. Store接口

### 7.1 AuthStore

```typescript
/**
 * 认证状态管理接口
 */
export interface AuthStore {
  /** 当前网络ID */
  networkId: string | null;
  /** 设备ID */
  deviceId: string;
  /** 设备昵称 */
  deviceNickname: string;
  /** 是否已认证 */
  isAuthenticated: boolean;
  /** 认证状态 */
  status: 'idle' | 'authenticating' | 'authenticated' | 'error';
  /** 错误信息 */
  error: string | null;
  
  // 操作方法
  generateNetworkId: () => Promise<string>;
  joinNetwork: (networkId: string) => Promise<void>;
  leaveNetwork: () => void;
  generateAccessCode: (expiryMinutes?: number) => string;
  validateAccessCode: (accessCode: string) => { valid: boolean; networkId?: string; error?: string };
  updateDeviceNickname: (nickname: string) => Promise<void>;
}
```

### 7.2 CardStore

```typescript
/**
 * 卡片状态管理接口
 */
export interface CardStore {
  /** 卡片列表 */
  cards: Card[];
  /** 已删除卡片列表 */
  deletedCards: Card[];
  /** 加载状态 */
  loading: boolean;
  /** 错误信息 */
  error: string | null;
  /** 当前选中的卡片 */
  selectedCard: Card | null;
  
  // 操作方法
  fetchAllCards: () => Promise<void>;
  fetchCardById: (id: string) => Promise<Card | null>;
  createCard: (cardData: Omit<Card, 'id' | 'createdAt' | 'updatedAt' | 'isDeleted'>) => Promise<Card>;
  updateCard: (id: string, cardData: Partial<Omit<Card, 'id' | 'createdAt'>>) => Promise<Card>;
  deleteCard: (id: string) => Promise<void>;
  restoreCard: (id: string) => Promise<void>;
  fetchDeletedCards: () => Promise<void>;
  selectCard: (card: Card | null) => void;
  clearError: () => void;
}
```

### 7.3 DeviceStore

```typescript
/**
 * 设备状态管理接口
 */
export interface DeviceStore {
  /** 当前设备信息 */
  currentDevice: Device | null;
  /** 网络设备列表 */
  networkDevices: Device[];
  /** 加载状态 */
  loading: boolean;
  /** 错误信息 */
  error: string | null;
  
  // 操作方法
  initializeDevice: () => Promise<void>;
  getCurrentDevice: () => Promise<Device | null>;
  updateDeviceNickname: (nickname: string) => Promise<void>;
  fetchNetworkDevices: () => Promise<void>;
  clearError: () => void;
}
```

### 7.4 SyncStore

```typescript
/**
 * 同步状态管理接口
 */
export interface SyncStore {
  /** 同步状态 */
  status: SyncStatus;
  /** 最后同步时间 */
  lastSyncTime: number | null;
  /** 同步错误信息 */
  error: string | null;
  /** 同步进度 */
  progress: number;
  
  // 操作方法
  startSync: () => Promise<void>;
  stopSync: () => Promise<void>;
  triggerSync: () => Promise<void>;
  clearError: () => void;
}
```

## 8. API使用示例

### 8.1 认证服务使用示例

```typescript
// 初始化认证服务
const authService = new AuthServiceImpl(databaseService);

// 创建新网络
const newNetworkId = await authService.generateNetworkId();
await authService.joinNetwork(newNetworkId);

// 生成Access Code
const accessCode = authService.generateAccessCode(10); // 10分钟有效期
console.log('Access Code:', accessCode);

// 验证Access Code
const validationResult = authService.validateAccessCode(accessCode);
if (validationResult.valid) {
  console.log('Valid Access Code for network:', validationResult.networkId);
} else {
  console.error('Invalid Access Code:', validationResult.error);
}
```

### 8.2 卡片服务使用示例

```typescript
// 初始化卡片服务
const cardService = new CardServiceImpl(databaseService, syncService);

// 创建新卡片
const newCard = await cardService.createCard({
  title: '新卡片',
  content: '卡片内容',
  lastModifiedBy: deviceId
});

// 获取所有卡片
const cards = await cardService.getAllCards();
console.log('All cards:', cards);

// 更新卡片
const updatedCard = await cardService.updateCard(newCard.id, {
  title: '更新后的卡片标题'
});

// 删除卡片
await cardService.deleteCard(updatedCard.id);
```

### 8.3 同步服务使用示例

```typescript
// 初始化同步服务
const syncService = new SyncServiceImpl(networkId, deviceId);

// 监听同步状态变化
syncService.onSyncStatusChange((status) => {
  console.log('Sync status changed:', status);
});

// 开始同步
await syncService.startSync();

// 手动触发同步
await syncService.triggerSync();

// 停止同步
await syncService.stopSync();
```

## 9. 错误处理

所有API方法都可能抛出以下类型的错误：

- `NetworkError`: 网络连接错误
- `ValidationError`: 数据验证错误
- `AuthenticationError`: 认证错误
- `PermissionError`: 权限错误
- `SyncError`: 同步错误
- `EncryptionError`: 加密错误

建议在使用API时进行适当的错误处理：

```typescript
try {
  await authService.joinNetwork(networkId);
  console.log('成功加入网络');
} catch (error) {
  if (error instanceof AuthenticationError) {
    console.error('认证失败:', error.message);
  } else if (error instanceof NetworkError) {
    console.error('网络错误:', error.message);
  } else {
    console.error('未知错误:', error.message);
  }
}
```