# mDNS 隐私保护架构规格

## 概述

本规格定义了 CardMind 中 mDNS 设备发现的隐私保护机制。系统默认不开启 mDNS 监听与广播，只有加入数据池后才会默认开启。mDNS 广播内容使用 libp2p 默认信息，不添加任何自定义字段，避免在局域网暴露设备或数据池细节。

**技术栈**:
- libp2p = "0.54" - P2P 网络库（包含 mDNS 特性）
- Noise 协议 - 加密认证
- Yamux - 连接多路复用

---

## 需求：默认关闭 mDNS

系统在未加入任何数据池时，不应启动 mDNS 监听与广播。

### 场景：应用启动但未加入数据池

- **前置条件**: 设备未加入任何数据池
- **操作**: 应用启动并准备网络
- **预期结果**: 不启动 mDNS 监听与广播
- **并且**: 局域网内不可发现该设备的 mDNS 广播

---

## 需求：加入数据池后默认开启 mDNS

设备加入至少一个数据池后，应默认开启 mDNS 监听与广播。

### 场景：加入数据池后启用发现

- **前置条件**: 设备已成功加入至少一个数据池
- **操作**: 启动同步服务
- **预期结果**: 启动 mDNS 监听与广播
- **并且**: 设备可在局域网被同类节点发现

---

## 需求：广播信息使用 libp2p 默认内容

系统不得在 mDNS 广播中添加任何自定义字段，广播内容应完全采用 libp2p 默认信息。

### 场景：mDNS 广播内容

- **前置条件**: 设备已开启 mDNS 发现
- **操作**: 进行 mDNS 广播
- **预期结果**: 广播内容为 libp2p 默认信息
- **并且**: 不包含任何自定义设备或数据池字段

**不应包含的自定义信息**:
- ❌ `device_id`
- ❌ `device_name`
- ❌ `pools[].pool_id`
- ❌ `pool_name`
- ❌ `member_list`
- ❌ `card_count`
- ❌ `password_hash`
- ❌ `user_defined_nickname`

---

## 需求：密码验证后获取详情

系统应要求新设备输入密码验证后，才能获取数据池的完整信息（名称、成员列表等）。

### 场景：新设备加入数据池

- **前置条件**: 新设备通过 mDNS 发现同一局域网的节点
- **操作**: 新设备尝试加入数据池
- **预期结果**: 系统应要求输入密码
- **并且**: 密码验证成功后，应能获取数据池名称、成员列表等详细信息

---

## 需求：加密传输

系统应使用 Noise 协议加密 P2P 通信，防止中间人攻击和窃听。

### 场景：设备间通信

- **前置条件**: 两个设备建立 P2P 连接
- **操作**: 传输数据池信息或卡片数据
- **预期结果**: 所有数据应使用 Noise 协议加密
- **并且**: 未加密的数据不应在网络上传输

---

## 需求：数据池 ID 不泄露内容

系统应使用 UUID v7 作为数据池 ID，确保 ID 本身不包含任何业务信息。

### 场景：传输数据池 ID

- **前置条件**: 设备拥有数据池 "工作笔记"
- **操作**: 在加入/同步协议中传输数据池 ID
- **预期结果**: 传输的 ID 应为 UUID v7 格式（如 "018c8a1b-2c3d-7e4f-8a9b-0c1d2e3f4a5b"）
- **并且**: ID 不应包含数据池名称、创建时间等信息

---

## 相关文档

**相关规格**:
- [../../domain/pool.md](../../domain/pool.md) - 数据池领域模型
- [../../domain/sync.md](../../domain/sync.md) - 同步模型
- [../sync/peer_discovery.md](../sync/peer_discovery.md) - mDNS 设备发现
- [./password.md](./password.md) - SHA-256 密码校验

**架构决策记录**:

---

## 测试覆盖

**测试文件**: `rust/tests/security_p2p_discovery_feature_test.rs`

**覆盖范围**:
- 默认未加入数据池时不启动 mDNS
- 加入数据池后默认开启 mDNS 监听与广播
- mDNS 广播不包含任何自定义字段
- 密码验证后才能获取数据池详情
- P2P 通信使用 Noise 加密
- 数据池 ID 为 UUID v7 且不泄露业务信息

**验收标准**:
- [x] 所有单元测试通过
- [x] 所有隐私测试通过
- [x] mDNS 广播不包含自定义信息
- [x] 密码验证后才能获取详情
- [x] 代码审查通过
- [x] 文档已更新
