# Loro 集成架构规格

## 概述

本规格定义了 Loro CRDT 库集成到 CardMind 中，包括文档管理、序列化、P2P 同步和版本控制。

**技术栈**:
- **loro** = "1.0" - CRDT 文档库
- **lru** = "0.12" - LRU 缓存实现
- **tokio** - 异步运行时
- **bincode** = "1.3" - 二进制序列化

**核心特性**:
- 基于 CRDT 的无冲突同步
- 高效的二进制序列化
- P2P 同步的增量更新
- 版本向量跟踪

---

## 需求：Loro 文档生命周期

系统应管理 Loro 文档生命周期，包括创建、加载、修改和持久化。

### 场景：创建新卡片 Loro 文档

- **前置条件**: 用户创建新卡片
- **操作**: 初始化 Loro 文档
- **预期结果**: 应创建包含卡片数据的 CRDT 文档
- **并且**: 文档应持久化到磁盘

### 场景：创建新池 Loro 文档

- **前置条件**: 用户创建新数据池
- **操作**: 初始化池 Loro 文档
- **预期结果**: 应创建包含池元数据的 CRDT 文档
- **并且**: 列表字段应使用 CRDT List 类型

### 场景：从磁盘加载 Loro 文档

- **前置条件**: Loro 文档已保存到磁盘
- **操作**: 加载文档
- **预期结果**: 应从二进制快照恢复完整文档状态
- **并且**: 文档应可立即使用

---

## 需求：增量同步

系统应使用 Loro 的版本向量支持增量同步。

### 场景：导出增量更新

- **前置条件**: 本地文档有新变更
- **操作**: 导出自指定版本以来的更新
- **预期结果**: 应返回仅包含新操作的二进制数据
- **并且**: 数据大小应小于完整快照

### 场景：两个设备之间同步

- **前置条件**: 两个设备在同一池中
- **操作**: 执行双向同步
- **预期结果**: 两个设备应交换增量更新
- **并且**: 同步后两个设备应有相同状态

---

## 需求：文档序列化

系统应使用 Loro 的高效二进制序列化进行存储和网络传输。

### 场景：快照 vs 增量更新

- **前置条件**: 需要同步文档
- **操作**: 选择最优同步方法
- **预期结果**: 应根据大小选择快照或增量更新
- **并且**: 应选择数据量更小的方法

**快照格式**:
- 完整文档状态
- 用于初始同步和磁盘持久化
- 更大但自包含

**增量更新格式**:
- 仅自某版本以来的操作
- 用于 P2P 同步
- 更小，需要基础版本

---

## 需求：内存管理

系统应通过缓存和垃圾回收高效管理 Loro 文档内存。

### 场景：内存文档缓存

- **前置条件**: 频繁访问某些文档
- **操作**: 使用 LRU 缓存
- **预期结果**: 热文档应保持在内存中
- **并且**: 冷文档应被自动驱逐

### 场景：旧操作的垃圾回收

- **前置条件**: 文档操作历史过大
- **操作**: 压缩文档
- **预期结果**: 应移除操作历史
- **并且**: 应保留当前状态

---

## 需求：错误处理

系统应优雅地处理 Loro 特定错误。

### 场景：处理导入错误

- **前置条件**: 接收到损坏的更新数据
- **操作**: 尝试导入
- **预期结果**: 应返回明确的错误
- **并且**: 不应破坏现有文档状态

### 场景：处理版本不匹配

- **前置条件**: 对等点版本向量不兼容
- **操作**: 尝试同步
- **预期结果**: 应返回版本不匹配错误
- **并且**: 应建议使用快照同步

**错误类型**:


---

## 补充说明

**技术栈**:
- **loro** = "1.0" - CRDT 文档库
- **lru** = "0.12" - LRU 缓存实现
- **tokio** - 异步运行时
- **bincode** = "1.3" - 二进制序列化

**设计模式**:
- **仓储模式**: 文档存储抽象
- **旁路缓存模式**: 热文档的 LRU 缓存
- **工厂模式**: 文档创建
- **策略模式**: 同步方法选择（快照 vs 增量）

**性能特征**:
- **快照大小**: 每张卡片约 1KB
- **增量更新**: 每个操作约 100 字节
- **导入速度**: 每次更新约 1ms
- **导出速度**: 每次更新约 0.5ms
- **缓存命中率**: > 80%（热文档）

**内存管理**:
- **文档缓存**: 最多 100 个文档
- **自动压缩**: 当历史 > 状态 × 3 时触发
- **LRU 驱逐**: 自动移除冷文档

---

## 相关文档

**架构规格**:
- [./dual_layer.md](./dual_layer.md) - 双层架构
- [./card_store.md](./card_store.md) - CardStore 实现
- [./pool_store.md](./pool_store.md) - PoolStore 实现
- [../sync/subscription.md](../sync/subscription.md) - 订阅机制
- [../sync/conflict_resolution.md](../sync/conflict_resolution.md) - 冲突解决

**架构决策记录**:
- ADR-0003: Loro CRDT - CRDT 库选择理由

---

## 测试覆盖

**测试文件**: `rust/tests/loro_integration_feature_test.rs`

**单元测试**:
- `test_create_card_document()` - 卡片文档创建
- `test_create_pool_document()` - 池文档创建
- `test_load_save_document()` - 文档持久化
- `test_export_import_updates()` - 增量更新
- `test_incremental_sync()` - 增量同步
- `test_snapshot_sync()` - 快照同步
- `test_document_cache()` - 缓存管理
- `test_cache_hit_miss()` - 缓存命中/未命中
- `test_garbage_collection()` - 文档压缩
- `test_should_compact()` - 压缩判断
- `test_choose_sync_method()` - 同步方法选择
- `test_error_handling()` - 错误处理
- `test_version_vector()` - 版本向量跟踪

**功能测试**:
- `test_end_to_end_sync()` - 端到端同步
- `test_multi_device_sync()` - 多设备同步
- `test_concurrent_edits()` - 并发编辑
- `test_network_failure_recovery()` - 网络故障恢复

**验收标准**:
- [x] 所有单元测试通过
- [x] 增量同步工作正常
- [x] 缓存提高性能
- [x] 文档压缩正常工作
- [x] 错误处理健壮
- [x] 代码审查通过
