# 对等点发现架构规格

## 概述

本规格定义了 CardMind P2P 同步的对等点发现机制，使用 libp2p mDNS 在本地网络中自动发现对等点，并在连接后完成池验证。

**技术栈**:
- **libp2p mdns** - 对等点发现
- **tokio** - 异步运行时

**核心特性**:
- **零配置**: 无需手动设置的自动对等点发现
- **仅限本地网络**: 发现限制在本地网络以保护隐私
- **连接后池验证**: 发现后连接，握手阶段验证是否同池
- **隐私保护**: mDNS 不携带池信息或用户信息

---

## 需求：mDNS 服务发现

系统应使用 libp2p mDNS 在本地网络上发现 CardMind 对等点。

### 场景：加入池后启动 mDNS 发现

- **前置条件**: 设备已加入池
- **操作**: 同步服务启动
- **预期结果**: 设备通过 libp2p mDNS 广播并监听对等点
- **并且**: 广播中不包含池信息或用户信息

### 场景：在本地网络上发现对等点

- **前置条件**: 同一池中的多个设备在本地网络上
- **操作**: 设备启动对等点发现
- **预期结果**: 设备应发现其他 CardMind 实例
- **并且**: 发现事件应触发连接尝试
- **并且**: 池验证在连接后的握手阶段完成

---

## 需求：隐私保护

系统应避免在 mDNS 广播中暴露池与用户信息。

### 场景：设备 ID 被混淆

- **前置条件**: 设备已加入池并启动 mDNS
- **操作**: 设备通过 mDNS 广播自己
- **预期结果**: 广播中不包含 pool_id、pool_name 或 secretkey

**隐私考虑**:
- **仅限本地网络**: mDNS 不可路由到本地网络之外
- **无池信息**: 广播不包含 pool_id/pool_name/secretkey
- **无个人信息**: 广播不包含用户昵称或成员信息

---

## 需求：连接建立

系统应建立到发现的对等点的 P2P 连接。

### 场景：连接到发现的对等点

- **前置条件**: 通过 mDNS 发现了对等点
- **操作**: 尝试连接到对等点
- **预期结果**: 应建立 TCP 连接
- **并且**: 连接应被认证
- **并且**: 对等点应添加到活动对等点列表

---

## 需求：对等点生命周期管理

系统应管理对等点连接的生命周期，包括检测离线对等点。

### 场景：检测对等点离线

- **前置条件**: 对等点已连接
- **操作**: 对等点离线
- **预期结果**: mDNS 服务应检测到移除
- **并且**: 对等点应从活动对等点列表中移除
- **并且**: 连接应被关闭

### 场景：对等点重新上线时重新连接

- **前置条件**: 对等点之前已连接但已离线
- **操作**: 对等点重新上线
- **预期结果**: 应通过 mDNS 重新发现对等点
- **并且**: 应自动建立新连接

---

## 补充说明

**技术栈**:
- **libp2p mdns** - 对等点发现
- **tokio** - 异步运行时
- **sha2** - pool_hash 计算（SHA-256(secretkey)）

**设计模式**:
- **观察者模式**: 基于回调的对等点发现
- **服务发现模式**: 用于零配置网络的 mDNS
- **隐私设计**: 内置混淆和哈希

**性能考虑**:
- **延迟发现**: 仅在需要时发现
- **连接池**: 复用到相同对等点的连接
- **超时处理**: 检测并移除过期连接

**网络配置**:
- **mDNS 端口**: 5353（标准 mDNS 端口）
- **服务端口**: 可配置（默认 8080）
- **发现间隔**: 持续监听
- **连接超时**: 10 秒

---

## 相关文档

**架构规格**:
- [./service.md](./service.md) - P2P 同步服务
- [./conflict_resolution.md](./conflict_resolution.md) - 冲突解决
- [../storage/device_config.md](../storage/device_config.md) - 设备配置

**领域规格**:
- [../../domain/pool.md](../../domain/pool.md) - 池模型

**架构决策记录**:
- ADR-0004: mDNS 发现 - mDNS 对等点发现决策

---

## 测试覆盖

**测试文件**: `rust/tests/mdns_discovery_feature_test.rs`

**单元测试**:
- `test_mdns_discovery_creation()` - mDNS 初始化
- `test_mdns_peer_discovery()` - mDNS 互发现
- `it_should_reject_peer_on_pool_hash_mismatch()` - 握手池校验
- `it_should_not_start_p2p_when_not_joined()` - 未加入池不启动

**功能测试**:
- `test_multi_device_discovery()` - 多设备发现场景
- `test_network_interruption_recovery()` - 网络中断后重新连接

**验收标准**:
- [x] 所有单元测试通过
- [x] 5 秒内发现对等点
- [x] 连接后池校验正确执行
- [x] 隐私保护已验证
- [x] 代码审查通过
