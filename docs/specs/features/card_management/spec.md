# 卡片管理功能规格

**版本**: 1.0.0

**状态**: 活跃

**依赖**: [../../domain/card/rules.md](../../domain/card/rules.md), [../../domain/pool/model.md](../../domain/pool/model.md)

**相关测试**: `test/features/card_management_test.dart`

---

## 概述


本规格定义了卡片管理功能，使用户能够在 CardMind 系统中创建、查看、编辑和删除笔记卡片。该功能提供从卡片创建到删除的完整用户旅程，支持自动草稿保存、标签管理和多设备协作。

**核心用户旅程**:
- 创建包含标题和内容的新笔记卡片
- 查看包含元数据的完整卡片详情
- 编辑现有卡片并自动保存草稿
- 管理标签（添加、移除、防止重复）
- 删除卡片并确认
- 与其他应用分享卡片内容

---

## 需求：卡片创建


用户应能够创建包含标题和可选内容的新笔记卡片。

### 场景：创建包含标题和内容的卡片

- **前置条件**: 用户已加入一个池
- **操作**: 用户创建标题为"Meeting Notes"、内容为"Discussed project timeline"的新卡片
- **预期结果**: 系统应使用 UUID v7 标识符创建卡片
- **并且**: 卡片应自动关联到当前池
- **并且**: 该池中的所有设备应可见该卡片
- **并且**: 应记录创建时间戳

### 场景：仅使用标题创建卡片

- **前置条件**: 用户已加入一个池
- **操作**: 用户创建标题为"Quick Note"、内容为空的新卡片
- **预期结果**: 系统应成功创建卡片
- **并且**: 内容字段应为空

### 场景：拒绝创建无标题的卡片

- **前置条件**: 用户尝试创建卡片
- **操作**: 用户提供空标题或仅包含空格的标题
- **预期结果**: 系统应拒绝创建
- **并且**: 系统应显示错误消息"标题为必填项"

### 场景：未加入池时拒绝创建卡片

- **前置条件**: 用户未加入任何池
- **操作**: 用户尝试创建新卡片
- **预期结果**: 系统应以错误"NO_POOL_JOINED"拒绝创建
- **并且**: 系统应提示用户加入或创建池

---

## 需求：卡片查看


用户应能够查看完整的卡片详情，包括内容、元数据、标签和同步信息。

### 场景：查看卡片详情

- **前置条件**: 存在包含标题、内容和标签的卡片
- **操作**: 用户打开卡片详情视图
- **预期结果**: 系统应显示卡片标题
- **并且**: 系统应显示卡片内容
- **并且**: 系统应显示创建时间戳
- **并且**: 系统应显示最后修改时间戳
- **并且**: 系统应显示所有关联的标签

### 场景：查看协作信息

- **前置条件**: 卡片最后由另一设备修改
- **操作**: 用户查看卡片详情
- **预期结果**: 系统应显示最后修改卡片的设备名称
- **并且**: 系统应显示修改时间戳

### 场景：查看同步状态

- **前置条件**: 卡片有同步状态信息
- **操作**: 用户查看卡片详情
- **预期结果**: 系统应显示当前同步状态（已同步、同步中或错误）
- **并且**: 系统应显示最后同步时间戳

---

## 需求：卡片编辑


用户应能够编辑现有卡片，并自动保存草稿以防止数据丢失。

### 场景：编辑卡片标题和内容

- **前置条件**: 存在标题为"Old Title"、内容为"Old Content"的卡片
- **操作**: 用户将标题编辑为"New Title"、内容编辑为"New Content"
- **并且**: 用户保存更改
- **预期结果**: 系统应使用新标题和内容更新卡片
- **并且**: 系统应更新最后修改时间戳
- **并且**: 系统应记录当前设备为修改者
- **并且**: 更改应同步到池中的所有设备

### 场景：编辑时自动保存草稿

- **前置条件**: 用户正在编辑卡片
- **操作**: 用户停止输入500毫秒
- **预期结果**: 系统应自动将当前状态保存为草稿
- **并且**: 系统应显示"草稿已保存"指示器

### 场景：重新打开编辑器时恢复草稿

- **前置条件**: 用户正在编辑卡片并在未保存的情况下关闭了编辑器
- **并且**: 草稿已自动保存
- **操作**: 用户重新打开同一卡片的编辑器
- **预期结果**: 系统应恢复草稿内容
- **并且**: 系统应显示"草稿已恢复"消息

### 场景：显式保存时丢弃草稿

- **前置条件**: 用户有已保存的草稿
- **操作**: 用户显式保存卡片
- **预期结果**: 系统应将更改持久化到卡片
- **并且**: 系统应删除草稿

### 场景：取消编辑并丢弃更改

- **前置条件**: 用户正在编辑包含未保存更改的卡片
- **操作**: 用户点击"取消"或"丢弃"
- **预期结果**: 系统应显示确认对话框"丢弃未保存的更改？"
- **并且**: 如果用户确认，系统应恢复到最后保存的状态
- **并且**: 系统应删除草稿

### 场景：防止保存空标题的卡片

- **前置条件**: 用户正在编辑卡片
- **操作**: 用户清空标题字段并尝试保存
- **预期结果**: 系统应拒绝保存操作
- **并且**: 系统应显示错误"标题不能为空"
- **并且**: 系统应保持编辑器打开

---

## 需求：标签管理


用户应能够添加和移除标签以组织卡片，并自动防止重复。

### 场景：向卡片添加标签

- **前置条件**: 存在没有标签的卡片
- **操作**: 用户添加标签"work"
- **预期结果**: 系统应将标签关联到卡片
- **并且**: 标签应在卡片视图中可见
- **并且**: 更改应同步到所有设备

### 场景：向卡片添加多个标签

- **前置条件**: 存在包含标签"work"的卡片
- **操作**: 用户添加标签"urgent"和"meeting"
- **预期结果**: 卡片应有三个标签："work"、"urgent"、"meeting"

### 场景：防止重复标签

- **前置条件**: 卡片有标签"work"
- **操作**: 用户尝试再次添加标签"work"
- **预期结果**: 系统应拒绝重复标签
- **并且**: 系统应显示消息"标签已存在"

### 场景：从卡片移除标签

- **前置条件**: 卡片有标签"work"和"urgent"
- **操作**: 用户移除标签"urgent"
- **预期结果**: 卡片应只有标签"work"
- **并且**: 更改应同步到所有设备

### 场景：标签大小写敏感性

- **前置条件**: 卡片有标签"Work"
- **操作**: 用户尝试添加标签"work"
- **预期结果**: 系统应将"Work"和"work"视为不同标签
- **并且**: 两个标签都应添加到卡片

---

## 需求：卡片删除


用户应能够删除卡片并确认，以防止意外删除。

### 场景：确认后删除卡片

- **前置条件**: 存在标题为"Delete Me"的卡片
- **操作**: 用户触发删除操作并确认删除
- **预期结果**: 系统应从池中删除卡片
- **并且**: 卡片应从所有设备移除
- **并且**: 系统应显示"卡片已删除"确认

### 场景：取消删除操作

- **前置条件**: 用户触发删除操作
- **操作**: 用户在确认对话框中点击"取消"
- **预期结果**: 系统应保持卡片不变
- **并且**: 卡片应保留在所有设备上

### 场景：删除后撤销

- **前置条件**: 用户已删除卡片
- **操作**: 用户在提示条显示时点击"撤销"
- **预期结果**: 系统应恢复已删除的卡片
- **并且**: 卡片应重新出现在所有设备上

---

## 需求：卡片分享


用户应能够与其他应用分享卡片内容。

### 场景：分享卡片内容

- **前置条件**: 存在包含标题和内容的卡片
- **操作**: 用户选择分享操作
- **预期结果**: 系统应打开系统分享对话框
- **并且**: 分享内容应包含卡片标题和内容

### 场景：以文本格式分享

- **前置条件**: 用户分享卡片
- **操作**: 用户选择文本格式
- **预期结果**: 分享内容应为纯文本格式
- **并且**: 内容应格式化为"标题: {title}\n\n{content}"

### 场景：以 Markdown 格式分享

- **前置条件**: 用户分享卡片
- **操作**: 用户选择 Markdown 格式
- **预期结果**: 分享内容应为 Markdown 格式
- **并且**: 标题应格式化为 Markdown 标题

---

## 测试覆盖


**单元测试**:
- `test_create_card_with_title_and_content()` - 创建包含标题和内容的卡片
- `test_create_card_with_title_only()` - 仅使用标题创建卡片
- `test_reject_card_without_title()` - 拒绝无标题的卡片
- `test_reject_card_when_no_pool()` - 未加入池时拒绝创建卡片
- `test_view_card_details()` - 查看卡片详情
- `test_view_collaboration_info()` - 查看协作信息
- `test_view_sync_status()` - 查看同步状态
- `test_edit_card_title_and_content()` - 编辑卡片标题和内容
- `test_autosave_draft_while_editing()` - 编辑时自动保存草稿
- `test_restore_draft_on_reopen()` - 重新打开时恢复草稿
- `test_discard_draft_on_explicit_save()` - 显式保存时丢弃草稿
- `test_cancel_edit_discard_changes()` - 取消编辑丢弃更改
- `test_prevent_save_empty_title()` - 防止保存空标题
- `test_add_tag_to_card()` - 向卡片添加标签
- `test_add_multiple_tags()` - 添加多个标签
- `test_prevent_duplicate_tags()` - 防止重复标签
- `test_remove_tag_from_card()` - 从卡片移除标签
- `test_tag_case_sensitivity()` - 标签大小写敏感性
- `test_delete_card_with_confirmation()` - 带确认删除卡片
- `test_cancel_delete_operation()` - 取消删除操作
- `test_undo_delete_action()` - 撤销删除操作
- `test_share_card_content()` - 分享卡片内容
- `test_share_as_text_format()` - 以文本格式分享
- `test_share_as_markdown_format()` - 以 Markdown 格式分享

**集成测试**:
- `test_card_creation_syncs_to_all_devices()` - 卡片创建同步到所有设备
- `test_card_edit_syncs_to_all_devices()` - 卡片编辑同步到所有设备
- `test_card_deletion_syncs_to_all_devices()` - 卡片删除同步到所有设备
- `test_tag_changes_sync_to_all_devices()` - 标签更改同步到所有设备

**验收标准**:
- [ ] 所有单元测试通过
- [ ] 所有集成测试通过
- [ ] 卡片创建在所有平台上正常工作
- [ ] 卡片编辑在所有平台上正常工作
- [ ] 标签管理在所有平台上正常工作
- [ ] 卡片删除在所有平台上正常工作
- [ ] 卡片分享在所有平台上正常工作
- [ ] 草稿自动保存可靠工作
- [ ] 代码审查通过
- [ ] 文档已更新

---

## 相关文档


- [Card Domain Rules](../../domain/card/rules.md) - 卡片域规则
- [Pool Model](../../domain/pool/model.md) - 池模型
- [Card Store](../../architecture/storage/card_store.md) - 卡片存储
- [Sync Service](../../architecture/sync/service.md) - 同步服务

---

**最后更新**: 2026-01-23
**作者**: CardMind Team
