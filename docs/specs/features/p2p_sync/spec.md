# P2P 同步功能规格

**版本**: 1.0.0

**状态**: 生效中

**依赖**: [sync_protocol.md](../../architecture/sync/service.md), [types.md](../../domain/types.md)

**相关测试**: `test/features/p2p_sync_test.dart`

---

## 概述


本规格从用户视角定义 P2P 同步功能。用户可以查看同步状态、管理已连接设备、手动触发同步、查看同步历史以及配置同步设置。

---

## 需求：查看实时同步状态


系统应向用户提供关于当前同步状态的实时视觉反馈。

### 场景：查看已同步状态

- **前置条件**：所有本地更改都已与对等设备同步
- **操作**：用户查看同步状态指示器
- **预期结果**：系统应显示带有成功指示的"已同步"状态
- **并且**：显示上次成功同步的时间戳

### 场景：查看同步中状态

- **前置条件**：同步正在进行中
- **操作**：用户查看同步状态指示器
- **预期结果**：系统应显示带有动画指示的"同步中"状态
- **并且**：显示正在同步的设备数量

### 场景：查看待同步更改状态

- **前置条件**：存在尚未同步的本地更改
- **操作**：用户查看同步状态指示器
- **预期结果**：系统应显示带有警告指示的"待同步"状态

### 场景：查看同步错误状态

- **前置条件**：同步遇到错误
- **操作**：用户查看同步状态指示器
- **预期结果**：系统应显示带有错误指示的"错误"状态
- **并且**：提供查看错误详情的选项

### 场景：查看断开连接状态

- **前置条件**：没有可用于同步的对等设备
- **操作**：用户查看同步状态指示器
- **预期结果**：系统应显示"断开连接"状态
- **并且**：指示没有可用设备

---

## 需求：查看详细同步信息


系统应允许用户访问全面的同步信息，包括设备列表、同步历史和统计信息。

### 场景：打开同步详情

- **前置条件**：用户正在查看同步状态指示器
- **操作**：用户点击同步状态指示器
- **预期结果**：系统应显示详细的同步信息视图
- **并且**：显示当前同步状态和描述

### 场景：查看已连接设备

- **前置条件**：同步详情视图已打开
- **操作**：用户查看设备列表部分
- **预期结果**：系统应显示所有发现的对等设备
- **并且**：指示每个设备的在线/离线状态
- **并且**：显示设备类型（手机、笔记本、平板）
- **并且**：显示离线设备的上次可见时间戳

### 场景：查看同步统计信息

- **前置条件**：同步详情视图已打开
- **操作**：用户查看统计信息部分
- **预期结果**：系统应显示已同步卡片的总数
- **并且**：显示同步的总数据大小
- **并且**：显示同步成功率
- **并且**：显示失败同步的次数及原因

### 场景：查看同步历史

- **前置条件**：同步详情视图已打开
- **操作**：用户查看同步历史部分
- **预期结果**：系统应显示带有时间戳的最近同步事件
- **并且**：指示每个事件的成功或失败
- **并且**：显示每次同步涉及的设备

### 场景：过滤同步历史

- **前置条件**：同步历史已显示
- **操作**：用户应用历史过滤器
- **预期结果**：系统应按设备、状态或时间范围过滤事件

---

## 需求：手动触发同步


系统应允许用户手动启动与可用对等设备的同步。

### 场景：触发手动同步

- **前置条件**：至少有一个对等设备可用
- **操作**：用户点击"立即同步"按钮
- **预期结果**：系统应立即尝试与可用设备同步
- **并且**：显示同步进度指示器
- **并且**：同步完成时更新状态

### 场景：无可用设备时触发手动同步

- **前置条件**：没有可用的对等设备
- **操作**：用户点击"立即同步"按钮
- **预期结果**：系统应显示错误消息，指示没有可用设备
- **并且**：建议发现设备的操作

### 场景：强制完全同步

- **前置条件**：用户想要执行完全重新同步
- **操作**：用户触发"完全同步"操作
- **预期结果**：系统应执行所有数据的完全重新同步
- **并且**：显示详细的进度信息

### 场景：刷新设备列表

- **前置条件**：用户想要发现新设备
- **操作**：用户点击"刷新设备"按钮
- **预期结果**：系统应重新扫描可用的对等设备
- **并且**：更新设备列表显示

---

## 需求：重试失败的同步


系统应允许用户在失败后重试同步。

### 场景：错误后重试同步

- **前置条件**：同步因错误而失败
- **操作**：用户点击错误详情中的"重试"按钮
- **预期结果**：系统应尝试重新启动同步
- **并且**：清除之前的错误状态
- **并且**：显示同步中状态

---

## 需求：配置同步设置


系统应允许用户配置同步首选项和行为。

### 场景：启用自动同步

- **前置条件**：自动同步当前已禁用
- **操作**：用户启用自动同步设置
- **预期结果**：系统应在检测到更改时自动同步
- **并且**：显示确认消息

### 场景：禁用自动同步

- **前置条件**：自动同步当前已启用
- **操作**：用户禁用自动同步设置
- **预期结果**：系统应停止自动同步
- **并且**：需要手动触发同步
- **并且**：显示确认消息

### 场景：设置同步频率

- **前置条件**：自动同步已启用
- **操作**：用户将同步频率设置为特定间隔
- **预期结果**：系统应按指定频率同步
- **并且**：在设置中显示配置的频率

---

## 需求：查看和解决同步冲突


系统应显示同步冲突并帮助用户解决它们。

### 场景：查看冲突列表

- **前置条件**：存在同步冲突
- **操作**：用户查看同步详情
- **预期结果**：系统应显示冲突部分
- **并且**：列出所有未解决的冲突
- **并且**：指示冲突数量

---

## 测试覆盖


**单元测试**:
- `test_view_synced_status()` - 查看已同步状态
- `test_view_syncing_status()` - 查看同步中状态
- `test_view_pending_status()` - 查看待同步状态
- `test_view_error_status()` - 查看错误状态
- `test_view_disconnected_status()` - 查看断开连接状态
- `test_open_sync_details()` - 打开同步详情
- `test_view_connected_devices()` - 查看已连接设备
- `test_view_sync_statistics()` - 查看同步统计信息
- `test_view_sync_history()` - 查看同步历史
- `test_filter_sync_history()` - 过滤同步历史
- `test_trigger_manual_sync()` - 触发手动同步
- `test_manual_sync_no_devices()` - 无设备时手动同步
- `test_force_full_sync()` - 强制完全同步
- `test_refresh_device_list()` - 刷新设备列表
- `test_retry_failed_sync()` - 重试失败同步
- `test_enable_auto_sync()` - 启用自动同步
- `test_disable_auto_sync()` - 禁用自动同步
- `test_set_sync_frequency()` - 设置同步频率
- `test_view_conflict_list()` - 查看冲突列表

**集成测试**:
- `test_sync_status_updates_in_realtime()` - 同步状态实时更新
- `test_device_list_updates_automatically()` - 设备列表自动更新
- `test_sync_history_records_all_events()` - 同步历史记录所有事件

**验收标准**:
- [ ] 所有单元测试通过
- [ ] 所有集成测试通过
- [ ] 同步状态显示在所有平台上正常工作
- [ ] 同步详情视图在所有平台上正常工作
- [ ] 手动同步在所有平台上正常工作
- [ ] 同步设置在所有平台上正常工作
- [ ] 冲突解决在所有平台上正常工作
- [ ] 代码审查通过
- [ ] 文档已更新

---

## 相关文档


- [Sync Service](../../architecture/sync/service.md) - 同步服务
- [Types](../../domain/types.md) - 类型定义

---

**最后更新**: 2026-01-23
**作者**: CardMind Team
