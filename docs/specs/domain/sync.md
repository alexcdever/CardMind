# 同步领域模型规格

## 概述

本规格定义了同步领域模型，包括版本追踪、冲突解决策略和分布式卡片协作的同步状态管理。


**核心特性**:
- 版本向量追踪
- CRDT 自动冲突解决
- 增量同步
- 双向同步
- 原子性保证

---

## 需求：版本追踪

系统应追踪每张卡片和每个池的同步版本，以支持增量更新。

### 场景：按卡片追踪版本

- **前置条件**: 数据池中存在一张卡片
- **操作**: 卡片被修改
- **预期结果**: 系统应生成新的版本标识符
- **并且**: 版本应与卡片的 CRDT 状态一起存储

### 场景：增量同步使用版本

- **前置条件**: 设备 A 已同步到版本 V1
- **操作**: 设备 A 请求同步
- **预期结果**: 系统应仅发送版本 V1 之后的变更
- **并且**: 系统不应发送已同步的数据

---

## 需求：基于 CRDT 的冲突解决

系统应使用 CRDT（无冲突复制数据类型）自动解决冲突，无需用户干预。

### 场景：并发编辑自动合并

- **前置条件**: 设备 A 和设备 B 都在离线状态下编辑同一张卡片
- **操作**: 两个设备同步它们的变更
- **预期结果**: 系统应使用 CRDT 规则合并两个编辑
- **并且**: 两个设备应收敛到相同的最终状态
- **并且**: 不应需要用户干预

### 场景：简单字段采用最后写入优先

- **前置条件**: 设备 A 在时间 T1 将标题设置为 "A"
- **并且**: 设备 B 在时间 T2 将标题设置为 "B"（T2 > T1）
- **操作**: 两个变更都被同步
- **预期结果**: 最终标题应为 "B"
- **并且**: 较晚的时间戳应获胜

---

## 需求：同步状态管理

系统应为每个对等设备维护同步状态，以追踪同步进度。

### 场景：按对等设备追踪同步状态

- **前置条件**: 设备 A 与设备 B 同步
- **操作**: 同步成功完成
- **预期结果**: 系统应记录设备 B 的最后同步版本
- **并且**: 系统应使用此版本进行下一次增量同步

### 场景：同步状态在重启后持久化

- **前置条件**: 设备 A 已与设备 B 同步
- **操作**: 设备 A 重启
- **预期结果**: 同步状态应从持久化存储中恢复
- **并且**: 下一次同步应从最后已知版本继续

---

## 需求：同步方向

系统应支持双向同步，允许推送和拉取变更。

### 场景：设备推送本地变更

- **前置条件**: 设备 A 有本地变更
- **操作**: 设备 A 发起与设备 B 的同步
- **预期结果**: 设备 A 应将其变更推送到设备 B
- **并且**: 设备 B 应将变更应用到其本地状态

### 场景：设备拉取远程变更

- **前置条件**: 设备 B 有设备 A 没有的变更
- **操作**: 设备 A 发起与设备 B 的同步
- **预期结果**: 设备 A 应从设备 B 拉取变更
- **并且**: 设备 A 应将变更应用到其本地状态

---

## 需求：同步原子性

每个同步操作应是原子的，要么完全成功，要么完全失败。

### 场景：同步完全成功

- **前置条件**: 设备 A 发起与设备 B 的同步
- **操作**: 所有变更成功传输
- **预期结果**: 同步状态应被更新
- **并且**: 两个设备应具有一致的数据

### 场景：同步失败并回滚

- **前置条件**: 设备 A 发起与设备 B 的同步
- **操作**: 同步期间发生错误
- **预期结果**: 同步应被中止
- **并且**: 不应应用部分变更
- **并且**: 同步状态应保持在先前版本

---

## 需求：无冲突标签合并

系统应使用集合并集合并来自多个设备的标签，无冲突。

### 场景：使用集合并集合并标签

- **前置条件**: 设备 A 为卡片添加标签 "work"
- **并且**: 设备 B 为同一张卡片添加标签 "urgent"
- **操作**: 两个设备同步
- **预期结果**: 卡片应具有两个标签：["work", "urgent"]
- **并且**: 不应丢失任何标签

---

## 补充说明

**数据结构**:

**设计模式**:
- **版本向量模式**: 追踪因果历史
- **CRDT 模式**: 无冲突自动合并
- **事务模式**: 原子性同步
- **状态机模式**: 同步状态管理

**冲突解决策略**:
- **简单字段**: 最后写入优先（LWW）
- **文本内容**: 操作转换（OT）
- **标签列表**: 集合并集
- **列表字段**: CRDT List

**性能特征**:
- **增量同步**: O(n) 其中 n 是变更数量
- **版本比较**: O(1)
- **合并操作**: O(n) 其中 n 是操作数量

---

## 相关文档

**领域规格**:
- [card.md](card.md) - 卡片领域模型
- [pool.md](pool.md) - 池领域模型
- [types.md](types.md) - 共享类型定义

**架构规格**:
- [../architecture/sync/service.md](../architecture/sync/service.md) - 同步服务
- [../architecture/sync/conflict_resolution.md](../architecture/sync/conflict_resolution.md) - 冲突解决
- [../architecture/sync/subscription.md](../architecture/sync/subscription.md) - 订阅机制
- [../architecture/storage/loro_integration.md](../architecture/storage/loro_integration.md) - Loro 集成

**架构决策记录**:
- ADR-0002: 双层架构 - 读写分离设计
- ADR-0003: Loro CRDT - CRDT 库选择

---

## 测试覆盖

**测试文件**: `rust/tests/sync_feature_test.rs`

**单元测试**:
- `test_version_tracking()` - 版本追踪
- `test_incremental_sync()` - 增量同步
- `test_concurrent_edit_merge()` - 并发编辑合并
- `test_sync_state_persistence()` - 同步状态持久化
- `test_last_write_wins()` - 最后写入优先
- `test_tag_merge()` - 标签合并
- `test_bidirectional_sync()` - 双向同步
- `test_atomic_sync()` - 原子性同步
- `test_sync_rollback()` - 同步回滚
- `test_convergence()` - 收敛性验证

**功能测试**:
- `test_multi_device_sync()` - 多设备同步
- `test_offline_sync()` - 离线同步
- `test_network_failure_recovery()` - 网络故障恢复
- `test_concurrent_sync_sessions()` - 并发同步会话

**验收标准**:
- [x] 所有单元测试通过
- [x] CRDT 冲突解决工作正常
- [x] 增量同步高效
- [x] 同步状态正确持久化
- [x] 原子性保证有效
- [x] 收敛性验证通过
- [x] 代码审查通过
