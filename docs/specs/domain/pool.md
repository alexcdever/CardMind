# 单池模型规格

**版本**: 1.0.0
**状态**: 活跃
**依赖**: [../types.md](../types.md), [../../architecture/storage/device_config.md](../../architecture/storage/device_config.md)
**相关测试**: `rust/tests/pool_model_test.rs`

---

## 概述

本规格定义了单池模型，其中每张卡片仅属于一个池，每个设备最多只能加入一个池。当设备创建新卡片时，卡片自动属于设备已加入的池。

---

## 需求：单池约束

系统应强制要求设备最多只能加入一个池用于个人笔记。

### 场景：设备成功加入第一个池

- **前置条件**：设备未加入任何池
- **操作**：设备使用有效密码加入池
- **预期结果**：该池应添加到设备的已加入池列表
- **并且**：应开始该池的同步

### 场景：设备拒绝加入第二个池

- **前置条件**：设备已加入一个池
- **操作**：设备尝试加入第二个池
- **预期结果**：系统应拒绝该请求
- **并且**：返回表明违反单池约束的错误

---

## 需求：在已加入池中创建卡片

当设备创建新卡片时，卡片应自动归属于设备已加入的池。

### 场景：创建卡片自动加入池

- **前置条件**：设备已加入一个池
- **操作**：用户创建新卡片
- **预期结果**：卡片应在已加入的池中创建
- **并且**：该池中的所有设备应可见该卡片

### 场景：未加入池时创建卡片失败

- **前置条件**：设备未加入任何池
- **操作**：用户尝试创建新卡片
- **预期结果**：系统应拒绝该请求
- **并且**：返回表明未加入池的错误

---

## 需求：设备离开池

当设备离开池时，系统应清除与该池关联的所有数据。

### 场景：设备离开池并清除数据

- **前置条件**：设备已加入包含卡片的池
- **操作**：设备离开该池
- **预期结果**：所有池数据应从设备清除
- **并且**：设备应不再与该池同步

---

## 测试覆盖

**测试文件**: `rust/tests/sp_spm_001_spec.rs`

**测试用例**: 完整测试实现请参见测试文件

---

## 相关文档

**架构决策记录**:
- [单池所有权模型](../../../../docs/adr/0001-单池所有权模型.md)

---

**最后更新**: 2026-01-21
**作者**: CardMind Team

---

## 补充：单池行为规则（来自原 superpowers/core-behaviors/）

### 规则 1：设备最多加入一个池
- **给定**：设备已加入 Pool A
- **当**：设备尝试加入 Pool B
- **那么**：系统应拒绝请求并提示"您已经加入了笔记空间'工作笔记'"

### 规则 2：卡片自动归属
- **给定**：设备已加入 Pool A，用户创建新卡片
- **当**：卡片创建成功
- **那么**：卡片自动属于 Pool A

### 规则 3：退出空间数据清理
- **给定**：用户退出当前空间
- **当**：退出操作完成
- **那么**：清理本地该空间的所有数据
- **并且**：设备回到"未加入空间"状态
