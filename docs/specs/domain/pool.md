# 单池模型规格

## 概述

本规格定义了单池模型，其中每张卡片仅属于一个池，每个设备最多只能加入一个池。当设备创建新卡片时，卡片自动属于设备已加入的池。

**核心原则**:
- **单池约束**: 每个设备最多加入一个池
- **自动归属**: 新卡片自动属于已加入的池
- **数据隔离**: 不同池的数据完全隔离
- **清理机制**: 离开池时清除所有相关数据

---

## 需求：单池约束

系统应强制要求设备最多只能加入一个池用于个人笔记。

### 场景：设备成功加入第一个池

- **前置条件**: 设备未加入任何池
- **操作**: 设备使用有效 secretkey 加入池
- **预期结果**: 该池应添加到设备的已加入池列表
- **并且**: 应开始该池的同步

### 场景：设备拒绝加入第二个池

- **前置条件**: 设备已加入一个池
- **操作**: 设备尝试加入第二个池
- **预期结果**: 系统应拒绝该请求
- **并且**: 返回表明违反单池约束的错误

---

## 需求：在已加入池中创建卡片

当设备创建新卡片时，卡片应自动归属于设备已加入的池。

### 场景：创建卡片自动加入池

- **前置条件**: 设备已加入一个池
- **操作**: 用户创建新卡片
- **预期结果**: 卡片应在已加入的池中创建
- **并且**: 该池中的所有设备应可见该卡片

### 场景：未加入池时创建卡片失败

- **前置条件**: 设备未加入任何池
- **操作**: 用户尝试创建新卡片
- **预期结果**: 系统应拒绝该请求
- **并且**: 返回表明未加入池的错误

---

## 需求：设备离开池

当设备离开池时，系统应清除与该池关联的所有数据。

### 场景：设备离开池并清除数据

- **前置条件**: 设备已加入包含卡片的池
- **操作**: 设备离开该池
- **预期结果**: 所有池数据应从设备清除
- **并且**: 设备应不再与该池同步

---

## 需求：单池行为规则

系统应强制执行单池模型的核心行为规则。

### 规则 1：设备最多加入一个池

- **给定**: 设备已加入 Pool A
- **当**: 设备尝试加入 Pool B
- **那么**: 系统应拒绝请求并提示"您已经加入了笔记空间'工作笔记'"

### 规则 2：卡片自动归属

- **给定**: 设备已加入 Pool A,用户创建新卡片
- **当**: 卡片创建成功
- **那么**: 卡片自动属于 Pool A

### 规则 3：退出空间数据清理

- **给定**: 用户退出当前空间
- **当**: 退出操作完成
- **那么**: 清理本地该空间的所有数据
- **并且**: 设备回到"未加入空间"状态

---

## 补充说明

**数据结构（概念）**:
- **Pool**
  - pool_id: 字符串，UUID v7
  - pool_name: 字符串，池名称
  - secretkey: 字符串，明文密钥
  - card_ids: 字符串列表，卡片 ID 列表
  - device_ids: 字符串列表，设备 ID 列表
  - created_at: 整数，Unix 毫秒时间戳
  - updated_at: 整数，Unix 毫秒时间戳
- **DeviceConfig**
  - device_id: 字符串，UUID v7
  - pool_id: 可选字符串，已加入的池 ID
  - joined_at: 可选整数，加入时间（Unix 毫秒时间戳）

**设计模式**:
- **约束强制模式**: 应用层强制单池约束
- **自动归属模式**: 新卡片自动属于已加入的池
- **清理模式**: 离开池时完全清理本地数据
- **确认模式**: 破坏性操作需要用户确认

**约束规则**:
- **单池约束**: 每个设备最多加入一个池
- **卡片归属**: 每张卡片必须属于某个池
- **数据隔离**: 不同池的数据完全隔离
- **清理完整性**: 离开池时清除所有相关数据

**错误处理**:
- **ALREADY_JOINED_POOL**: 尝试加入第二个池
- **NOT_JOINED_POOL**: 未加入池时创建卡片
- **POOL_NOT_FOUND**: 池不存在
- **DEVICE_REMOVED_FROM_POOL**: 设备被从池中移除
- **INVALID_PASSWORD**: 密钥校验失败

**性能特征**:
- **数据清理**: O(n) 其中 n 是卡片数量

---

## 相关文档

**领域规格**:
- [card.md](card.md) - 卡片领域模型
- [sync.md](sync.md) - 同步领域模型
- [types.md](types.md) - 共享类型定义

**架构规格**:
- [../architecture/storage/pool_store.md](../architecture/storage/pool_store.md) - PoolStore 实现
- [../architecture/storage/device_config.md](../architecture/storage/device_config.md) - DeviceConfig 实现
- [../architecture/sync/service.md](../architecture/sync/service.md) - P2P 同步服务


---

## 测试覆盖

**测试文件**: `rust/tests/pool_model_feature_test.rs`

**单元测试**:
- `test_join_first_pool()` - 成功加入第一个池
- `test_reject_second_pool()` - 拒绝加入第二个池
- `test_create_card_in_pool()` - 在池中创建卡片
- `test_create_card_without_pool()` - 未加入池时创建卡片失败
- `test_leave_pool()` - 离开池
- `test_data_cleanup_on_leave()` - 离开池时数据清理
- `test_auto_assign_card()` - 卡片自动归属
- `test_single_pool_constraint()` - 单池约束强制执行
- `test_pool_not_found()` - 池不存在错误处理
- `test_device_removed_from_pool()` - 设备被移除错误处理

**功能测试**:
- `test_pool_lifecycle()` - 完整池生命周期
- `test_multi_device_pool()` - 多设备池场景
- `test_concurrent_join_attempts()` - 并发加入尝试
- `test_leave_and_rejoin()` - 离开后重新加入

**验收标准**:
- [x] 所有单元测试通过
- [x] 单池约束强制执行
- [x] 卡片自动归属到池
- [x] 离开池时数据完全清理
- [x] 错误消息友好且准确
- [x] 代码审查通过
