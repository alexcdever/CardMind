# 卡片管理API文档

## 1. 数据模型定义

### 1.1 卡片数据结构

| 字段名 | 类型 | 描述 |
|--------|------|------|
| id | String (UUID v7) | 卡片唯一标识符 |
| title | String | 卡片标题 |
| content | String | 卡片内容 |
| created_at | i64 | 创建时间戳（毫秒） |
| updated_at | i64 | 更新时间戳（毫秒） |

### 1.2 卡片网络关联

| 字段名 | 类型 | 描述 |
|--------|------|------|
| card_id | String (UUID v7) | 卡片唯一标识符 |
| network_id | String (UUID v7) | 协作网络唯一标识符 |

## 2. API接口规范

### 2.1 卡片创建

**业务逻辑**：创建新卡片，根据常驻网络规则决定是否自动加入协作网络

**处理流程**：
1. Flutter端调用创建卡片API，传入标题和内容
2. Rust端生成UUID v7作为卡片ID
3. 创建LoroDoc对象，将卡片ID作为LoroDoc ID
4. 将卡片数据写入Loro
5. 通过Loro的subscribe机制自动更新SQLite表
6. 检查是否有常驻网络，如有则自动将新卡片加入所有常驻网络
7. 返回创建成功的卡片信息

**测试案例**：
- 单元测试：验证UUID生成、LoroDoc创建和SQLite写入
- 功能测试：验证卡片创建后是否正确加入常驻网络
- 集成测试：验证Flutter端调用API后能正确显示新卡片

### 2.2 卡片编辑

**业务逻辑**：修改现有卡片的标题和内容

**处理流程**：
1. Flutter端调用编辑卡片API，传入卡片ID、新标题和新内容
2. Rust端验证卡片ID是否存在
3. 更新LoroDoc中的卡片数据
4. 通过Loro的subscribe机制自动更新SQLite表
5. 返回更新成功的卡片信息

**测试案例**：
- 单元测试：验证卡片更新逻辑和SQLite同步
- 功能测试：验证编辑后卡片内容正确更新
- 集成测试：验证多设备间卡片编辑的实时同步

### 2.3 卡片删除

**业务逻辑**：删除指定卡片

**处理流程**：
1. Flutter端调用删除卡片API，传入卡片ID
2. Rust端验证卡片ID是否存在
3. 删除LoroDoc对象
4. 通过Loro的subscribe机制自动删除SQLite表中的卡片数据
5. 解除该卡片与所有协作网络的关联
6. 返回删除成功状态

**测试案例**：
- 单元测试：验证卡片删除逻辑和网络关联解除
- 功能测试：验证删除后卡片不再显示
- 集成测试：验证多设备间卡片删除的实时同步

### 2.4 卡片列表获取

**业务逻辑**：获取所有卡片列表，按更新时间倒序排序

**处理流程**：
1. Flutter端调用获取卡片列表API
2. Rust端从SQLite表中查询所有卡片数据
3. 按更新时间倒序排序
4. 返回卡片列表

**测试案例**：
- 单元测试：验证SQLite查询和排序逻辑
- 功能测试：验证卡片列表正确显示和排序
- 集成测试：验证多设备间新卡片的实时显示

### 2.5 卡片详情获取

**业务逻辑**：获取指定卡片的详细信息

**处理流程**：
1. Flutter端调用获取卡片详情API，传入卡片ID
2. Rust端从SQLite表中查询卡片数据
3. 返回卡片详细信息

**测试案例**：
- 单元测试：验证卡片详情查询逻辑
- 功能测试：验证卡片详情正确显示
- 集成测试：验证多设备间卡片详情的实时更新

### 2.6 卡片加入网络

**业务逻辑**：将指定卡片加入指定协作网络

**处理流程**：
1. Flutter端调用卡片加入网络API，传入卡片ID和网络ID
2. Rust端验证卡片ID和网络ID是否存在
3. 建立卡片与网络的关联关系
4. 更新Loro中的网络成员关系
5. 返回操作成功状态

**测试案例**：
- 单元测试：验证卡片网络关联逻辑
- 功能测试：验证卡片成功加入网络
- 集成测试：验证多设备间卡片网络关联的实时同步

### 2.7 卡片退出网络

**业务逻辑**：将指定卡片从指定协作网络中退出

**处理流程**：
1. Flutter端调用卡片退出网络API，传入卡片ID和网络ID
2. Rust端验证卡片ID和网络ID是否存在
3. 解除卡片与网络的关联关系
4. 更新Loro中的网络成员关系
5. 返回操作成功状态

**测试案例**：
- 单元测试：验证卡片网络关联解除逻辑
- 功能测试：验证卡片成功退出网络
- 集成测试：验证多设备间卡片网络关联解除的实时同步

## 3. 测试案例设计

### 3.1 单元测试
- **测试目标**：验证单个功能模块的正确性
- **测试方法**：使用Rust测试框架，模拟依赖，测试核心逻辑
- **测试覆盖率**：≥80%

### 3.2 功能测试
- **测试目标**：验证单个功能的完整性和正确性
- **测试方法**：使用集成测试框架，模拟用户操作流程
- **测试场景**：
  - 卡片创建、编辑、删除
  - 卡片加入/退出网络
  - 常驻网络规则验证

### 3.3 集成测试
- **测试目标**：验证前后端协同工作的正确性
- **测试方法**：使用Flutter集成测试框架，测试完整的用户流程
- **测试场景**：
  - Flutter端调用API创建卡片
  - 多设备间卡片同步
  - 网络状态变化时的卡片行为

## 4. API调用示例

### 4.1 创建卡片
```
// Flutter端调用
final card = await api.createCard(title: "测试卡片", content: "测试内容");
```

### 4.2 编辑卡片
```
// Flutter端调用
final updatedCard = await api.updateCard(id: "card-id", title: "更新标题", content: "更新内容");
```

### 4.3 删除卡片
```
// Flutter端调用
await api.deleteCard(id: "card-id");
```

### 4.4 获取卡片列表
```
// Flutter端调用
final cards = await api.getCards();
```

### 4.5 卡片加入网络
```
// Flutter端调用
await api.addCardToNetwork(cardId: "card-id", networkId: "network-id");
```

### 4.6 卡片退出网络
```
// Flutter端调用
await api.removeCardFromNetwork(cardId: "card-id", networkId: "network-id");
```