# 协作网络管理API文档

## 1. 数据模型定义

### 1.1 协作网络数据结构

| 字段名 | 类型 | 描述 |
|--------|------|------|
| id | String (UUID v7) | 协作网络唯一标识符 |
| name | String | 网络昵称 |
| password | String | 网络密码（加密存储） |
| created_at | i64 | 创建时间戳（毫秒） |
| updated_at | i64 | 更新时间戳（毫秒） |

### 1.2 设备数据结构

| 字段名 | 类型 | 描述 |
|--------|------|------|
| id | String | 设备指纹，唯一标识设备 |
| name | String | 设备昵称 |
| created_at | i64 | 设备首次加入网络时间戳 |
| updated_at | i64 | 设备信息更新时间戳 |

### 1.3 网络设备关联

| 字段名 | 类型 | 描述 |
|--------|------|------|
| network_id | String (UUID v7) | 协作网络唯一标识符 |
| device_id | String | 设备唯一标识符 |

### 1.4 常驻网络设置

| 字段名 | 类型 | 描述 |
|--------|------|------|
| device_id | String | 设备唯一标识符 |
| network_id | String (UUID v7) | 协作网络唯一标识符 |

## 2. API接口规范

### 2.1 网络创建

**业务逻辑**：创建新的协作网络，生成网络ID和密码

**处理流程**：
1. Flutter端调用创建网络API，传入网络名称和密码
2. Rust端生成UUID v7作为网络ID
3. 创建LoroDoc对象，将网络ID作为LoroDoc ID
4. 将网络数据写入Loro
5. 通过Loro的subscribe机制自动更新SQLite表
6. 将当前设备加入新创建的网络
7. 返回创建成功的网络信息

**测试案例**：
- 单元测试：验证UUID生成、LoroDoc创建和SQLite写入
- 功能测试：验证网络创建后设备自动加入
- 集成测试：验证Flutter端调用API后能正确显示新网络

### 2.2 网络加入

**业务逻辑**：通过网络ID和密码加入现有协作网络

**处理流程**：
1. Flutter端调用加入网络API，传入网络ID和密码
2. Rust端验证网络ID和密码是否匹配
3. 将设备信息加入网络设备列表
4. 更新LoroDoc中的网络成员关系
5. 通过Loro的subscribe机制自动更新SQLite表
6. 返回加入成功的网络信息

**测试案例**：
- 单元测试：验证网络ID和密码验证逻辑
- 功能测试：验证设备成功加入网络
- 集成测试：验证多设备间网络加入的实时同步

### 2.3 网络退出

**业务逻辑**：退出当前所在的协作网络，解除所有关联卡片

**处理流程**：
1. Flutter端调用退出网络API，传入网络ID
2. Rust端检查当前设备是否有卡片加入该网络
3. 若有，弹出提示确认
4. 确认后，解除该设备所有卡片与该网络的关联
5. 将设备从网络设备列表中移除
6. 更新LoroDoc中的网络成员关系
7. 通过Loro的subscribe机制自动更新SQLite表
8. 检查是否所有设备都已退出，若是则销毁网络
9. 返回退出成功状态

**测试案例**：
- 单元测试：验证设备退出逻辑和卡片关联解除
- 功能测试：验证退出网络后不再接收该网络的更新
- 集成测试：验证多设备间网络退出的实时同步

### 2.4 网络信息获取

**业务逻辑**：获取当前设备加入的所有协作网络信息

**处理流程**：
1. Flutter端调用获取网络列表API
2. Rust端从SQLite表中查询当前设备加入的所有网络
3. 返回网络列表，包含每个网络的详细信息和在线设备列表

**测试案例**：
- 单元测试：验证网络列表查询逻辑
- 功能测试：验证网络列表正确显示
- 集成测试：验证多设备间网络信息的实时更新

### 2.5 网络重命名

**业务逻辑**：修改协作网络的昵称

**处理流程**：
1. Flutter端调用重命名网络API，传入网络ID和新名称
2. Rust端验证网络ID是否存在
3. 更新LoroDoc中的网络名称
4. 通过Loro的subscribe机制自动更新SQLite表
5. 返回更新成功的网络信息

**测试案例**：
- 单元测试：验证网络重命名逻辑
- 功能测试：验证网络名称正确更新
- 集成测试：验证多设备间网络名称更新的实时同步

### 2.6 常驻网络设置

**业务逻辑**：设置或取消协作网络为常驻网络

**处理流程**：
1. Flutter端调用设置常驻网络API，传入网络ID和设置状态
2. Rust端验证网络ID是否存在
3. 更新设备的常驻网络设置
4. 通过Loro的subscribe机制自动更新SQLite表
5. 返回设置成功状态

**测试案例**：
- 单元测试：验证常驻网络设置逻辑
- 功能测试：验证新卡片自动加入常驻网络
- 集成测试：验证多设备间常驻网络设置的同步

### 2.7 设备列表获取

**业务逻辑**：获取指定协作网络内的所有设备列表

**处理流程**：
1. Flutter端调用获取设备列表API，传入网络ID
2. Rust端从SQLite表中查询该网络的所有设备
3. 返回设备列表

**测试案例**：
- 单元测试：验证设备列表查询逻辑
- 功能测试：验证设备列表正确显示
- 集成测试：验证多设备间设备列表的实时更新

## 3. 测试案例设计

### 3.1 单元测试
- **测试目标**：验证单个功能模块的正确性
- **测试方法**：使用Rust测试框架，模拟依赖，测试核心逻辑
- **测试覆盖率**：≥80%

### 3.2 功能测试
- **测试目标**：验证单个功能的完整性和正确性
- **测试方法**：使用集成测试框架，模拟用户操作流程
- **测试场景**：
  - 网络创建、加入、退出
  - 网络重命名和设备管理
  - 常驻网络规则验证

### 3.3 集成测试
- **测试目标**：验证前后端协同工作的正确性
- **测试方法**：使用Flutter集成测试框架，测试完整的用户流程
- **测试场景**：
  - Flutter端调用API加入网络
  - 多设备间网络状态同步
  - 设备退出网络时的卡片处理

## 4. API调用示例

### 4.1 创建网络
```
// Flutter端调用
final network = await api.createNetwork(name: "家庭网络", password: "123456");
```

### 4.2 加入网络
```
// Flutter端调用
final network = await api.joinNetwork(id: "network-id", password: "123456");
```

### 4.3 退出网络
```
// Flutter端调用
await api.leaveNetwork(id: "network-id");
```

### 4.4 获取网络列表
```
// Flutter端调用
final networks = await api.getNetworks();
```

### 4.5 网络重命名
```
// Flutter端调用
final updatedNetwork = await api.renameNetwork(id: "network-id", name: "工作网络");
```

### 4.6 设置常驻网络
```
// Flutter端调用
await api.setResidentNetwork(networkId: "network-id", isResident: true);
```

### 4.7 获取设备列表
```
// Flutter端调用
final devices = await api.getNetworkDevices(networkId: "network-id");
```