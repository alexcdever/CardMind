# CardMind 概念文档

## 1. 核心概念

### 1.1 CardMind
- **定义**：CardMind是一个现代化的笔记卡片管理应用，支持多设备间数据同步和离线使用。
- **核心特性**：基于CRDT数据同步、WebRTC点对点通信和离线优先架构，实现多设备间的无缝数据协作。

### 1.2 协作网络
- **定义**：由多个设备组成的、通过WebRTC和Yjs技术实现实时数据同步的分布式系统。
- **特征**：去中心化设计、实时数据同步、自动冲突解决、离线支持、跨平台兼容、安全通信。
- **运行方式**：包含网络创建、设备加入、数据同步、设备离开、网络销毁五个阶段。

### 1.3 网络ID
- **定义**：协作网络的唯一标识符，基于UUID v4生成。
- **作用**：用于标识和区分不同的协作网络，是协作网络的核心标识。
- **生成机制**：每个设备都可以生成唯一的网络ID，无主次设备之分。

### 1.4 设备ID
- **定义**：每个设备生成并存储的唯一标识符，用于在协作网络中区分不同设备。
- **生成机制**：结合设备指纹和随机UUID生成持久化设备标识。
- **本地存储**：使用IndexedDB本地持久化存储。

### 1.5 设备昵称
- **定义**：用户友好的设备名称，用于在协作网络中更直观地识别设备。
- **默认生成**：默认使用设备类型+随机字符组合。
- **个性化设置**：支持用户自定义设备昵称。
- **冲突处理**：当多设备昵称相同时，自动添加后缀确保唯一性。

### 1.6 Access Code
- **定义**：设备通过输入Access Code加入已存在的协作网络，是包含信令服务器的连接方式和协作网络的id的加入凭证。
- **组成**：协作网络ID、信令服务器连接方式（IP地址和端口信息）、时间戳、设备标识。
- **生成与使用**：创建新网络时实时生成、在设置页面中可手动实时生成；不持久化存储，每次需要时重新生成；通过复制粘贴方式分享。

## 2. 技术概念

### 2.1 Yjs CRDT 同步机制
- **定义**：基于Yjs库实现的Conflict-free Replicated Data Type（无冲突复制数据类型）同步机制。
- **特性**：自动合并、强最终一致性、无中心化、高性能、可扩展性、版本历史、空间效率、持久化。
- **作用**：实现多设备间的实时数据同步和自动冲突解决。

### 2.2 WebRTC 点对点通信
- **定义**：直接在浏览器之间建立连接的实时通信技术，无需经过服务器中转。
- **特性**：点对点连接、NAT穿透、加密通信。
- **适配器**：使用y-webrtc适配器，提供自动连接管理、房间概念、意识协议等功能。

### 2.3 双数据源工作方式
- **设计理念**：使用IndexedDB存储业务数据，提供结构化查询能力；使用Yjs作为同步层，负责多设备间的实时同步。
- **数据流向**：
  - 写操作：用户修改 → 更新IndexedDB → 更新Yjs文档 → 同步到其他设备
  - 读操作：优先从IndexedDB读取 → 必要时从Yjs同步
  - 冲突解决：基于Yjs的CRDT算法自动解决

### 2.4 IndexedDB
- **定义**：浏览器内置的事务型数据库，用于客户端本地数据持久化存储。
- **作用**：存储业务数据、设备ID、网络配置等信息。
- **管理工具**：使用Dexie.js管理IndexedDB，提供更简洁的API。

### 2.5 SyncService
- **定义**：管理设备间的数据同步逻辑的核心服务组件。
- **作用**：协调Yjs文档、WebRTC连接和本地存储之间的数据同步。

### 2.6 Yjs文档
- **定义**：Yjs库用于存储和同步数据的核心数据结构。
- **作用**：作为多设备间数据同步的媒介，确保数据的最终一致性。

## 3. 架构概念

### 3.1 跨平台架构
- **层级结构**：客户端层 → 通信适配层 → WebRTC核心层 → Yjs CRDT层 → 数据存储层。
- **平台优先级**：Electron (PC) 最高，React Native (移动端) 中等，Web 平台最低。
- **部署能力**：
  - Electron：客户端+服务端
  - React Native：仅客户端
  - Web平台：客户端+服务端

### 3.2 后端服务共享架构
- **设计理念**：将后端服务拆分为独立模块，便于不同平台复用。
- **部署方式**：
  - Electron：子进程形式
  - Web平台：容器/云部署
- **实现策略**：模块化设计、平台抽象层、配置驱动、依赖管理、测试策略。

### 3.3 通信优先级策略
- **连接优先级**：同一设备内 → 同一局域网 → 跨网络/互联网。
- **自动降级机制**：依次尝试高优先级连接方式，失败后自动降级到低优先级方式。

### 3.4 信令服务器
- **定义**：轻量级服务器，用于WebRTC连接建立过程中的信令交换。
- **核心功能**：WebSocket连接管理、房间管理和消息广播、设备发现和状态跟踪、WebRTC信令转发。
- **部署方案**：Docker容器化、Serverless、本地部署。

## 4. 功能概念

### 4.1 卡片管理
- **定义**：对卡片进行创建、编辑、查看和删除的功能。
- **卡片属性**：id、title（最多20字符）、content（最多2000字符）、createdAt、updatedAt、isDeleted、lastModifiedBy。
- **操作流程**：
  - 卡片列表：按修改时间排序，最新的卡片显示在最上方。
  - 卡片详情：显示完整的卡片信息。
  - 添加卡片：通过浮空按钮添加新卡片。
  - 删除卡片：左滑或长按出现删除按钮，需要二次确认。
  - 修改卡片：点击修改按钮弹出编辑窗口。

### 4.2 数据同步
- **定义**：在多个设备间同步卡片数据的功能。
- **特性**：支持离线使用、无需后端服务器配合、使用Yjs的CRDT算法实现无冲突数据合并。
- **数据流向**：本地操作 → 本地保存 → 同步标记 → 实时传播 → 远程应用 → 双向同步。

### 4.3 本地数据加密存储
- **定义**：对本地存储的数据进行加密保护，防止未授权访问。
- **作用**：提供基本的安全保护，防止本地数据泄露。

### 4.4 网络原则
- **离线优先原则**：无需依赖后端服务器，优先使用本地数据。
- **简化用户交互**：无需第三方授权，简化用户交互流程。
- **局域网协同**：适用于家庭局域网协同组网场景。

## 5. 界面概念

### 5.1 主页布局
- **组成**：底部导航栏和内容区域。
- **默认显示**：内容区域默认显示卡片列表。

### 5.2 网络认证界面
- **显示时机**：应用首次启动时显示。
- **功能**：通过Access Code加入已存在的协作网络，提供跳过选项。

### 5.3 网络设置界面
- **功能**：显示网络连接状态和当前网络ID、显示在线设备列表、提供"生成Access Code"按钮。
- **设备列表信息**：设备ID、设备昵称、设备类型。

## 6. 流程概念

### 6.1 网络生命周期
1. **网络创建**：生成网络ID、生成Access Code、初始化Yjs文档。
2. **设备加入**：输入Access Code、验证有效性、建立WebRTC连接、同步Yjs文档数据、注册设备信息。
3. **数据同步**：更新本地IndexedDB、Yjs自动同步、其他设备接收修改、自动解决冲突。
4. **设备离开**：设备主动离开或网络检测到设备离线、更新设备状态。
5. **网络销毁**：所有设备离开网络或设备主动销毁网络、清除相关数据和连接。

### 6.2 网络认证流程
- 检查设备ID → 网络状态检查 → Access Code输入/生成 → 网络加入 → 设备注册。

### 6.3 应用启动流程
- 初始化IndexedDB → 加载设备信息 → 加载网络配置 → 建立WebRTC连接 → 同步数据 → 监听变更。

### 6.4 数据操作同步流程
- 本地操作 → 本地保存 → 同步标记 → 实时传播 → 远程应用 → 双向同步。

## 7. 注意事项概念

### 7.1 数据一致性
- **CRDT算法**：确保最终一致性，但双数据源设计需要仔细处理同步冲突。
- **离线操作**：可能导致合并冲突，依赖Yjs的自动冲突解决机制。

### 7.2 网络连接限制
- **WebRTC依赖**：需要网络支持UDP流量，某些企业网络环境可能限制WebRTC连接。
- **NAT穿透**：在某些复杂网络环境下可能失败，需要STUN/TURN服务器协助。

### 7.3 性能考虑
- **Yjs文档大小**：会影响同步性能，需要合理设计数据结构。
- **并发编辑**：大量并发编辑可能导致性能下降。
- **IndexedDB查询**：需要合理设计索引，优化查询性能。

### 7.4 安全考虑
- **Access Code安全**：包含敏感连接信息，不应通过不安全的渠道分享。
- **WebRTC加密**：WebRTC连接默认加密，但仍需验证设备身份。
- **本地数据保护**：本地数据存储需要加密保护，防止未授权访问。