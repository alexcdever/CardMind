# ADR-0002：双层架构

**状态**：已接受
**日期**：2024-12-31
**决策者**：CardMind Team

---

## 背景

CardMind 的数据层需要同时满足两个核心需求：

**1. 分布式同步**
- 多设备 P2P 同步
- 离线编辑
- 自动冲突解决

**2. 查询性能**
- 快速查询
- 索引优化
- 全文搜索

这两个需求很难用单一技术方案同时满足。CRDT 擅长分布式同步和冲突解决，但查询性能较差；传统数据库查询快速，但不支持 CRDT 同步。

---

## 决策

我们决定采用**双层架构**，将写入和读取分离到不同的存储层：

```
┌─────────────────────────────────────────┐
│           应用层 (Flutter)              │
└─────────────────┬───────────────────────┘
                  │
         ┌────────┴─────────┐
         │                  │
         ▼                  ▼
┌─────────────────┐  ┌─────────────────┐
│  写入层         │  │  读取层         │
│  Loro CRDT      │──│  SQLite         │
└─────────────────┘  └─────────────────┘
         │                  ▲
         │                  │
         └──────订阅────────┘
```

### 核心原则

- **所有写入 → Loro CRDT**（真实数据源）
- **所有读取 → SQLite**（查询缓存）
- **订阅驱动**：Loro 提交 → 回调 → SQLite 更新

### 写入路径

所有写入操作都通过 Loro CRDT 层处理：

1. 用户创建或修改卡片
2. 数据写入 Loro 文档
3. Loro 文档提交
4. 触发订阅回调
5. 回调更新 SQLite 缓存

这确保了 Loro 始终是唯一的真实数据源，所有数据变更都经过 CRDT 处理，保证了分布式一致性。

### 读取路径

所有读取操作都通过 SQLite 缓存处理：

1. 应用发起查询请求
2. 直接查询 SQLite
3. 从缓存返回结果
4. 永不直接查询 Loro

这确保了查询性能，支持复杂的列表查询、排序、分页和全文搜索。

---

## 技术细节

### Loro CRDT 层（写入）

**职责**：
- 接收所有写入操作
- 确保数据一致性
- 支持分布式编辑
- 自动冲突解决
- 文件持久化
- 触发变更通知

### SQLite 层（读取）

**职责**：
- 响应所有查询请求
- 提供快速列表查询
- 支持全文搜索（FTS5）
- 启用索引和排序
- 通过订阅镜像 Loro 数据

---

## 考虑过的其他方案

**方案：仅使用 Loro**
拒绝原因：查询性能差，不支持全文搜索

**方案：仅使用 SQLite**
拒绝原因：不支持 CRDT 同步，无法自动解决冲突

**方案：使用 Redis 缓存**
拒绝原因：无持久化保证，不支持 CRDT

---

## 影响

### 优势

- **分离关注点**：写入专注于一致性，读取专注于性能
- **最佳性能**：每层都使用最适合的技术
- **可靠同步**：Loro CRDT 保证分布式一致性
- **快速查询**：SQLite 提供高性能查询和全文搜索

### 缺点

- **数据冗余**：数据同时存在于两层
- **同步延迟**：写入到读取之间有微小延迟（订阅回调）
- **复杂性**：需要维护两个存储层的一致性

### 权衡

我们认为性能和可靠性的提升远超过了额外的复杂性。订阅机制确保了两层数据的最终一致性，而微小的同步延迟在实际使用中几乎无法察觉。

---

**相关文档**：[系统设计](../architecture/system_design.md), [双层架构规格](../../openspec/specs/architecture/storage/dual_layer.md), [CardStore 规格](../../openspec/specs/architecture/storage/card_store.md), [SQLite 缓存规格](../../openspec/specs/architecture/storage/sqlite_cache.md)
