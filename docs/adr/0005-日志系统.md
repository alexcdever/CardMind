# ADR-0005：日志系统

**状态**：已接受
**日期**：2024-12-31
**决策者**：CardMind Team

---

## 背景

CardMind 是一个跨平台应用，需要在开发和生产环境中记录日志，用于：

- **开发调试**：快速定位问题
- **性能分析**：识别性能瓶颈
- **错误追踪**：记录异常和错误
- **用户支持**：帮助用户排查问题

由于应用分为 Rust 核心层和 Flutter UI 层，我们需要为两个平台选择合适的日志方案。

---

## 决策

我们为不同平台选择了最适合的日志库：

### Rust 层：tracing

**tracing** 是 Rust 生态中最强大的日志和追踪库：

- **结构化日志**：支持键值对，易于解析和查询
- **异步友好**：与 Rust 的 async/await 完美集成
- **性能优越**：零成本抽象，生产环境开销极小
- **丰富的生态**：支持多种输出格式和后端

### Flutter 层：logger

**logger** 是 Flutter 社区最流行的日志库：

- **美观输出**：彩色格式化，易于阅读
- **灵活配置**：支持自定义输出格式
- **跨平台**：在所有 Flutter 平台上一致工作
- **简单易用**：API 简洁，学习成本低

---

## 日志级别

我们定义了五个日志级别，从低到高：

### TRACE（追踪）

**用途**：非常详细的调试信息，通常只在开发时启用

**示例**：
- 函数进入/退出
- 循环迭代
- 详细的状态变化

**Rust**：
```rust
tracing::trace!("Entering function with param: {}", value);
```

**Flutter**：
```dart
logger.t("Entering function with param: $value");
```

### DEBUG（调试）

**用途**：开发时的调试信息，帮助理解程序流程

**示例**：
- 变量值
- 条件分支
- 中间结果

**Rust**：
```rust
tracing::debug!(card_id = %id, "Loading card from database");
```

**Flutter**：
```dart
logger.d("Loading card from database: $id");
```

### INFO（信息）

**用途**：重要的业务事件，生产环境默认级别

**示例**：
- 用户操作（创建卡片、加入池）
- 系统事件（同步开始、同步完成）
- 配置变更

**Rust**：
```rust
tracing::info!(pool_id = %id, "Device joined pool");
```

**Flutter**：
```dart
logger.i("Device joined pool: $id");
```

### WARN（警告）

**用途**：潜在问题，不影响功能但需要关注

**示例**：
- 性能问题（查询慢）
- 配置问题（使用默认值）
- 兼容性问题

**Rust**：
```rust
tracing::warn!(duration_ms = elapsed, "Slow query detected");
```

**Flutter**：
```dart
logger.w("Slow query detected: ${elapsed}ms");
```

### ERROR（错误）

**用途**：错误和异常，需要立即处理

**示例**：
- 数据库错误
- 网络错误
- 业务逻辑错误

**Rust**：
```rust
tracing::error!(error = %e, "Failed to save card");
```

**Flutter**：
```dart
logger.e("Failed to save card", error: e, stackTrace: st);
```

---

## 日志内容规范

### 必须包含的信息

1. **上下文**：操作相关的实体 ID（card_id、pool_id 等）
2. **操作**：正在执行的操作（loading、saving、syncing 等）
3. **结果**：操作结果（成功、失败、耗时等）

### 禁止记录的信息

1. **敏感数据**：密码、密钥、个人隐私信息
2. **完整内容**：卡片完整内容（可记录摘要或长度）
3. **大量数据**：避免记录大型数组或对象

### 示例

**好的日志**：
```rust
tracing::info!(
    card_id = %id,
    pool_id = %pool,
    content_length = content.len(),
    "Card created successfully"
);
```

**不好的日志**：
```rust
// ❌ 记录了完整内容
tracing::info!("Card created: {:?}", card);

// ❌ 没有上下文
tracing::info!("Operation completed");
```

---

## 环境配置

### 开发环境

```
Rust:    TRACE 级别，输出到控制台
Flutter: DEBUG 级别，彩色输出
```

### 生产环境

```
Rust:    INFO 级别，输出到文件
Flutter: INFO 级别，输出到文件
```

### 日志文件

```
位置: {app_data}/logs/
格式: cardmind-{date}.log
轮转: 每天一个文件，保留 7 天
大小: 单文件最大 10MB
```

---

## 考虑过的其他方案

**方案：Rust 使用 log + env_logger**
拒绝原因：log 是简单的门面库，缺少结构化日志和异步支持

**方案：Flutter 使用 print()**
拒绝原因：无法控制日志级别，无法格式化输出，不适合生产环境

**方案：统一使用一个日志库**
拒绝原因：Rust 和 Flutter 生态不同，强行统一会失去各自的优势

---

## 影响

### 优势

- **开发效率**：清晰的日志帮助快速定位问题
- **生产监控**：结构化日志易于分析和告警
- **性能优化**：通过日志识别性能瓶颈
- **用户支持**：日志文件帮助排查用户问题

### 实施要求

- 所有关键操作必须记录日志
- 日志级别必须正确使用
- 禁止记录敏感信息
- 定期审查日志内容和性能影响

---

**相关文档**：[日志规范](../development/logging_guidelines.md)
