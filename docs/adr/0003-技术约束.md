# ADR-0003：技术约束

**状态**：已接受
**日期**：2024-12-31
**决策者**：CardMind Team

---

## 概述

本文档记录 CardMind 的核心技术栈决策。这些技术选择构成了系统的基础约束，影响着架构设计和实现方式。

---

## 1. CRDT 引擎：Loro

### 为什么需要 CRDT

CardMind 需要支持：
- 离线多设备编辑
- 重新连接时自动合并
- 去中心化同步
- 数据永不丢失

传统的客户端-服务器架构无法满足这些需求。我们需要一个能够在分布式环境下自动解决冲突的数据结构。

### 为什么选择 Loro

**Loro** 是一个高性能的 CRDT 库，具有以下优势：

- **自动冲突解决**：多设备同时编辑时自动合并变更
- **离线优先**：完全支持离线编辑，重连后自动同步
- **高性能**：相比其他 CRDT 实现，Loro 的性能更优
- **Rust 实现**：与我们的技术栈完美契合

### 核心场景

**离线编辑**：设备离线时，用户创建或编辑卡片，所有变更存储在本地 Loro 文档中，不尝试同步。

**重连同步**：当设备重新连接时，Loro CRDT 自动合并所有设备的变更，确保数据不丢失。

---

## 2. 查询缓存：SQLite

### 为什么需要查询缓存

Loro CRDT 专注于一致性和同步，不擅长查询。我们需要：
- 快速列表查询
- 全文搜索
- 排序和分页
- 复杂的过滤条件

### 为什么选择 SQLite

**SQLite** 是嵌入式数据库的最佳选择：

- **FTS5 全文搜索**：内置强大的全文搜索引擎
- **高性能**：单次查询 < 10ms，加载 1000 张卡片 < 1 秒
- **跨平台**：所有平台都有成熟的 SQLite 支持
- **零配置**：无需独立服务器，直接嵌入应用

### 性能目标

- 加载 1000 张卡片：< 1 秒
- 单次 ID 查询：< 10ms
- 全文搜索：< 100ms

---

## 3. ID 格式：UUID v7

### 为什么需要特殊的 ID 格式

在分布式系统中，我们需要：
- **全局唯一**：多设备生成 ID 不会冲突
- **时间有序**：按创建时间排序
- **无需中央协调**：每个设备独立生成

### 为什么选择 UUID v7

**UUID v7** 是最新的 UUID 标准（RFC 9562），专为分布式系统设计：

- **时间戳前缀**：前 48 位是毫秒级时间戳，天然有序
- **随机后缀**：保证同一毫秒内的 ID 不冲突
- **标准格式**：兼容所有 UUID 工具和库

相比 UUID v4（纯随机）和 UUID v1（基于 MAC 地址），UUID v7 更适合我们的场景。

---

## 4. 跨平台桥接：flutter_rust_bridge

### 为什么需要桥接

CardMind 使用 Flutter（UI）+ Rust（核心逻辑）的架构。我们需要在两者之间传递数据和调用函数。

### 为什么选择 flutter_rust_bridge

**flutter_rust_bridge** 提供：

- **类型安全**：自动生成类型定义，编译时检查
- **高性能**：零拷贝传递，最小化序列化开销
- **开发体验**：自动代码生成，减少手写胶水代码
- **异步支持**：完整支持 Rust 的 async/await

---

## 5. 密码安全：bcrypt + Keyring

### 为什么需要密码保护

数据池需要密码保护，防止未授权访问。我们需要：
- **安全哈希**：密码不能明文存储
- **安全存储**：已保存的密码需要加密存储

### 为什么选择 bcrypt + Keyring

**bcrypt** 用于密码哈希：
- 自适应成本：可调整计算复杂度
- 抗暴力破解：计算缓慢，增加破解成本
- 行业标准：经过时间检验的安全算法

**平台 Keyring** 用于密码存储：
- macOS：Keychain
- Windows：Credential Manager
- Linux：Secret Service API

这确保了密码存储使用操作系统级别的安全机制。

---

## 6. 对等发现：mDNS

### 为什么需要对等发现

P2P 同步需要设备能够自动发现局域网内的其他设备，无需手动配置 IP 地址。

### 为什么选择 mDNS

**mDNS**（Multicast DNS）是局域网服务发现的标准协议：

- **零配置**：无需 DNS 服务器
- **自动发现**：设备自动广播和发现服务
- **跨平台**：所有主流操作系统都支持
- **低延迟**：本地网络，发现速度快

---

## 总结

这些技术选择共同构成了 CardMind 的技术基础：

- **Loro CRDT**：分布式同步的核心
- **SQLite**：高性能查询的保障
- **UUID v7**：分布式 ID 的标准
- **flutter_rust_bridge**：跨平台的桥梁
- **bcrypt + Keyring**：安全的基石
- **mDNS**：自动发现的关键

每个选择都经过仔细权衡，确保在性能、安全性、可维护性之间达到最佳平衡。

---

**相关文档**：[架构模式](../architecture/architecture_patterns.md), [Loro 集成规格](../../openspec/specs/architecture/storage/loro_integration.md), [同步服务规格](../../openspec/specs/architecture/sync/service.md), [密码管理规格](../../openspec/specs/architecture/security/password.md), [Keyring 规格](../../openspec/specs/architecture/security/keyring.md), [对等发现规格](../../openspec/specs/architecture/sync/peer_discovery.md)
