# CardMind 实施计划文档

## 1. 总体开发计划

### 1.1 项目基础信息
- **开发模式**：测试驱动，敏捷开发，迭代交付

### 1.2 开发流程
- **需求分析**：基于需求文档，明确功能范围
- **UI交互设计**：基于需求进行用户界面和交互设计
- **技术选型**：确定技术栈和架构设计
- **定义API和测试案例**：根据技术选型，制定详细的API接口规范和对应的单元测试案例
- **阶段性开发**：按功能模块分阶段实现，遵循测试驱动开发方法
- **测试验证**：每个阶段完成后进行测试
- **部署上线**：完成所有功能开发后的部署

## 2. 分阶段实施计划

### 2.1 第一阶段：基础框架搭建

#### 2.1.1 项目初始化
- 使用Vite创建React+TypeScript项目
- 配置pnpm包管理器
- 安装核心依赖：
  - antd (UI组件库)
  - tailwindcss (样式框架)
  - zustand (状态管理)
  - dexie (IndexedDB封装)
  - yjs, y-webrtc, y-indexeddb (数据同步)
  - uuid (生成唯一标识符)
- 配置开发环境和构建脚本

#### 2.1.2 基础配置
- TypeScript严格模式配置
- Tailwind断点配置
- ESLint和Prettier配置
- PWA基础配置

#### 2.1.3 目录结构搭建
创建项目目录结构：
```
├── public/             # 静态资源
├── src/                # 源代码
│   ├── components/     # React组件
│   │   ├── Auth/       # 网络认证相关组件
│   │   ├── Settings/   # 设置相关组件
│   │   ├── CardList/   # 卡片列表组件
│   │   ├── CardEditor/ # 卡片编辑组件
│   ├── stores/         # 状态管理
│   │   ├── authStore.ts    # 认证状态管理
│   │   ├── deviceStore.ts  # 设备管理状态
│   │   ├── cardStore.ts    # 卡片状态管理
│   │   └── syncStore.ts    # 同步状态管理
│   ├── services/       # 业务服务
│   │   ├── AuthService.ts  # 认证服务
│   │   ├── DeviceService.ts # 设备管理服务
│   │   ├── CardService.ts  # 卡片服务
│   │   ├── EncryptionService.ts # 加密服务
│   │   └── SyncService.ts  # 同步服务
│   ├── utils/          # 工具函数
│   │   ├── encryption.ts   # 加密工具
│   │   ├── validation.ts   # 验证工具
│   │   └── deviceUtils.ts  # 设备工具函数
│   └── types/          # 类型定义
│       ├── auth.types.ts   # 认证相关类型
│       ├── device.types.ts # 设备相关类型
│       └── card.types.ts   # 卡片相关类型
```

### 2.2 第二阶段：核心功能实现

#### 2.2.1 网络认证与设备管理实现
- 创建AuthService类，实现网络ID生成和验证
- **实现Access Code生成算法**：包含网络ID、WebRTC连接信息、时间戳和设备标识
- **实现Access Code解析验证**：Base64解码、JSON结构验证、字段有效性检查
- 创建DeviceService类，实现设备ID生成、存储和昵称管理
- 实现IndexedDB数据模型，包含network和device表
- 开发网络认证界面组件（支持Access Code输入和生成）
- 实现设备昵称设置功能
- 开发Access Code显示和复制功能界面

#### 2.2.2 双数据源极简架构实现
- 创建MinimalCardStorage类
- 实现IndexedDB初始化和基本操作
- 集成Yjs，实现CRDT数据同步
- 实现双数据源双向同步机制
- 编写核心数据操作方法：
  - `createCard`: 创建新卡片
  - `updateCard`: 更新卡片内容
  - `deleteCard`: 软删除卡片
  - `getAllCards`: 获取所有非删除状态的卡片
  - `getDeletedCards`: 获取所有已删除卡片
  - `restoreCard`: 恢复已删除卡片
  - `syncFromYjsToIndexedDB`: 从Yjs同步数据到IndexedDB
  - `syncAllCardsFromYjs`: 同步所有卡片
  - `createYjsDocForExistingCard`: 为已有卡片创建Yjs文档

#### 2.2.3 卡片管理功能
- 实现极简CRUD操作
- 添加实时协作编辑支持
- 实现软删除机制
- 添加空列表提示
- 记录修改来源设备ID

#### 2.2.4 用户界面实现
- 网络认证界面（包含Access Code输入、网络ID生成和显示）
- **Access Code生成界面**：实时生成并显示Access Code，支持一键复制
- **Access Code输入界面**：提供Access Code输入框和格式验证
- 网络设置界面（显示网络ID、Access Code生成按钮和设备昵称设置）
- 在线设备列表组件（显示网络中所有设备状态）
- 卡片列表组件（支持实时排序）
- 卡片详情模态框（支持协作编辑）
- 卡片编辑模态框（实时同步）
- 删除确认对话框

### 2.3 第三阶段：网络状态管理

#### 2.3.1 实时状态指示
- 开发useSyncStatus钩子函数
- 实现网络连接状态检测
- 显示在线协作者状态
- 添加同步状态指示器
- 实现设备在线状态管理
- 显示设备昵称和最后活动时间
- **开发Access Code状态管理**：跟踪Access Code生成、复制和使用状态

#### 2.3.2 离线模式处理
- 网络断开时自动切换到离线模式
- 重新连接后自动同步变更
- 添加同步状态指示器（在线/离线/同步中）
- 设备重连时的身份验证恢复

### 2.4 第四阶段：安全与优化

#### 2.4.1 加密实现
- 创建EncryptionService类
- 实现密钥生成功能
- 实现数据加密和解密功能
- 集成加密功能到数据操作流程
- 对网络ID和设备ID存储进行安全处理

#### 2.4.2 认证安全优化
- 增强网络ID生成的随机性
- **Access Code有效期控制**：实现时间戳验证机制（用于确保连接信息新鲜度，非安全目的）
- 实现设备ID的隐私保护措施
- 添加网络连接状态检测
- 优化网络连接稳定性

#### 2.4.3 性能优化
- 实现虚拟滚动（大量卡片时）
- 添加防抖处理（搜索、输入）
- 优化图片和媒体资源加载
- 实现懒加载机制
- 优化设备ID生成和验证性能

### 2.5 第五阶段：测试与部署

#### 2.5.1 测试策略
- 单元测试：核心业务逻辑，包括认证服务和设备服务
- 集成测试：数据存储、同步和网络认证流程
- E2E测试：关键用户流程，包括网络认证、设备加入和协作编辑
- 性能测试：大量数据场景和多设备并发场景
- 安全测试：网络ID和设备ID生成的安全性

#### 2.5.2 部署配置
- PWA配置优化
- 构建脚本优化
- CDN部署配置
- 监控和错误追踪

## 3. 开发里程碑与质量门禁

### 3.1 开发里程碑

| 阶段 | 关键交付物 | 验收标准 |
|------|------------|----------|
| 阶段1 | 基础框架 | 项目可运行，基础UI完成 |
| 阶段2 | 核心功能 | 卡片CRUD完整实现 |
| 阶段3 | 数据同步 | 多设备同步可用 |
| 阶段4 | 安全优化 | 加密存储，性能优化 |
| 阶段5 | 测试部署 | 测试通过，PWA部署 |

### 3.2 质量门禁

#### 3.2.1 代码质量
- TypeScript零错误
- ESLint零警告
- 单元测试覆盖率>80%
- 关键路径E2E测试通过

#### 3.2.2 性能标准
- 首屏加载<3秒
- 卡片列表渲染<100ms
- 加密/解密操作<500ms
- 同步延迟<2秒

#### 3.2.3 用户体验
- 所有交互响应<100ms
- 离线模式可用性100%
- 错误恢复率>99%

## 4. 风险评估与应对策略

### 4.1 技术风险

#### 4.1.1 IndexedDB兼容性问题
- **风险**: 部分旧版浏览器不支持IndexedDB
- **概率**: 低 (现代浏览器支持率>95%)
- **影响**: 高 (无法存储数据)
- **应对策略**:
  - 添加IndexedDB可用性检测
  - 提供降级方案（localStorage）
  - 显示兼容性提示

#### 4.1.2 WebRTC连接失败
- **风险**: 网络环境限制WebRTC连接
- **概率**: 中 (企业网络、防火墙限制)
- **影响**: 中 (无法实现多设备同步)
- **应对策略**:
  - 实现连接状态检测
  - 提供手动同步选项
  - 添加网络诊断工具

#### 4.1.3 加密性能问题
- **风险**: 大量数据加密影响性能
- **概率**: 低 (现代硬件性能充足)
- **影响**: 中 (用户体验下降)
- **应对策略**:
  - 实现分批加密处理
  - 使用Web Worker避免阻塞主线程
  - 优化加密算法参数

### 4.2 数据安全

#### 4.2.1 数据丢失风险
- **风险**: 用户误操作或设备故障导致数据丢失
- **概率**: 中
- **影响**: 极高
- **应对策略**:
  - 实现自动备份机制
  - 添加数据导出功能（后续版本）
  - 提供数据恢复工具

#### 4.2.2 密码遗忘风险
- **风险**: 用户忘记密码导致数据无法解密
- **概率**: 高
- **影响**: 极高 (数据永久丢失)
- **应对策略**:
  - 提供密码提示功能
  - 实现密钥恢复机制（需要安全考虑）
  - 添加数据备份建议

### 4.3 用户体验

#### 4.3.1 首次使用复杂度
- **风险**: 首次使用需要设置密码，增加使用门槛
- **概率**: 高
- **影响**: 中 (用户流失)
- **应对策略**:
  - 提供可选的加密设置
  - 优化首次使用引导流程
  - 提供快速开始选项

#### 4.3.2 同步延迟感知
- **风险**: 用户感知到同步延迟，怀疑数据丢失
- **概率**: 中
- **影响**: 中 (用户信任度下降)
- **应对策略**:
  - 添加同步状态指示器
  - 实现实时同步状态反馈
  - 提供手动刷新功能

## 5. 后续扩展规划

### 5.1 功能扩展
- 标签系统（基于需求优先级）
- 全文搜索功能
- 数据导出/导入
- 主题切换
- 回收站功能

### 5.2 技术升级
- 服务端同步备份
- 多端应用（iOS/Android）
- AI辅助功能
- 协作编辑