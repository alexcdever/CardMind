# CardMind 实现计划文档

## 1. 概述

本文档整合了CardMind项目的完整实现计划，包括基础功能实现、跨平台支持和网络优化方案。整个实施过程分为5个主要阶段，总计8-10周完成。

### 1.1 项目基础信息
- **开发模式**：测试驱动，敏捷开发，迭代交付
- **目标平台**：Web、Electron桌面端、React Native移动端
- **核心特性**：离线优先、实时协作、跨设备同步、安全加密

### 1.2 开发流程
- **需求分析**：基于需求文档，明确功能范围
- **UI交互设计**：基于需求进行用户界面和交互设计
- **技术选型**：确定技术栈和架构设计
- **定义API和测试案例**：根据技术选型，制定详细的API接口规范和对应的单元测试案例
- **阶段性开发**：按功能模块分阶段实现，遵循测试驱动开发方法
- **测试验证**：每个阶段完成后进行测试
- **部署上线**：完成所有功能开发后的部署

## 2. 核心内容

### 2.1 分阶段实施计划

#### 2.1.1 第一阶段：基础框架搭建（第1-2周）

##### 项目初始化
- 使用Vite创建React+TypeScript项目
- 配置pnpm包管理器
- 安装核心依赖：
  - antd (UI组件库)
  - tailwindcss (样式框架)
  - zustand (状态管理)
  - dexie (IndexedDB封装)
  - yjs, y-webrtc, y-indexeddb (数据同步)
  - uuid (生成唯一标识符)
- 配置开发环境和构建脚本

##### 基础配置
- TypeScript严格模式配置
- Tailwind断点配置
- ESLint和Prettier配置
- PWA基础配置

##### 目录结构搭建
创建项目目录结构：
```
├── public/             # 静态资源
├── src/                # 源代码
│   ├── components/     # React组件
│   │   ├── Auth/       # 网络认证相关组件
│   │   ├── Settings/   # 设置相关组件
│   │   ├── CardList/   # 卡片列表组件
│   │   ├── CardEditor/ # 卡片编辑组件
│   ├── stores/         # 状态管理
│   │   ├── authStore.ts    # 认证状态管理
│   │   ├── deviceStore.ts  # 设备管理状态
│   │   ├── cardStore.ts    # 卡片状态管理
│   │   └── syncStore.ts    # 同步状态管理
│   ├── services/       # 业务服务
│   │   ├── AuthService.ts  # 认证服务
│   │   ├── DeviceService.ts # 设备管理服务
│   │   ├── CardService.ts  # 卡片服务
│   │   ├── EncryptionService.ts # 加密服务
│   │   └── SyncService.ts  # 同步服务
│   ├── utils/          # 工具函数
│   │   ├── encryption.ts   # 加密工具
│   │   ├── validation.ts   # 验证工具
│   │   └── deviceUtils.ts  # 设备工具函数
│   └── types/          # 类型定义
│       ├── auth.types.ts   # 认证相关类型
│       ├── device.types.ts # 设备相关类型
│       └── card.types.ts   # 卡片相关类型
```

#### 2.1.2 第二阶段：核心功能实现（第3-4周）

##### 网络认证与设备管理实现
- 创建AuthService类，实现网络ID生成和验证
- **实现Access Code生成算法**：包含网络ID、WebRTC连接信息、时间戳和设备标识
- **实现Access Code解析验证**：Base64解码、JSON结构验证、字段有效性检查
- 创建DeviceService类，实现设备ID生成、存储和昵称管理
- 实现IndexedDB数据模型，包含network和device表
- 开发网络认证界面组件（支持Access Code输入和生成）
- 实现设备昵称设置功能
- 开发Access Code显示和复制功能界面

##### 双数据源极简架构实现
- 创建MinimalCardStorage类
- 实现IndexedDB初始化和基本操作
- 集成Yjs，实现CRDT数据同步
- 实现双数据源双向同步机制
- 编写核心数据操作方法：
  - `createCard`: 创建新卡片
  - `updateCard`: 更新卡片内容
  - `deleteCard`: 软删除卡片
  - `getAllCards`: 获取所有非删除状态的卡片
  - `getDeletedCards`: 获取所有已删除卡片
  - `restoreCard`: 恢复已删除卡片
  - `syncFromYjsToIndexedDB`: 从Yjs同步数据到IndexedDB
  - `syncAllCardsFromYjs`: 同步所有卡片
  - `createYjsDocForExistingCard`: 为已有卡片创建Yjs文档

##### 卡片管理功能
- 实现极简CRUD操作
- 添加实时协作编辑支持
- 实现软删除机制
- 添加空列表提示
- 记录修改来源设备ID

##### 用户界面实现
- 网络认证界面（包含Access Code输入、网络ID生成和显示）
- **Access Code生成界面**：实时生成并显示Access Code，支持一键复制
- **Access Code输入界面**：提供Access Code输入框和格式验证
- 网络设置界面（显示网络ID、Access Code生成按钮和设备昵称设置）
- 在线设备列表组件（显示网络中所有设备状态）
- 卡片列表组件（支持实时排序）
- 卡片详情模态框（支持协作编辑）
- 卡片编辑模态框（实时同步）
- 删除确认对话框

#### 2.1.3 第三阶段：网络状态管理与跨平台支持（第5-6周）

##### 实时状态指示
- 开发useSyncStatus钩子函数
- 实现网络连接状态检测
- 显示在线协作者状态
- 添加同步状态指示器
- 实现设备在线状态管理
- 显示设备昵称和最后活动时间
- **开发Access Code状态管理**：跟踪Access Code生成、复制和使用状态

##### 离线模式处理
- 网络断开时自动切换到离线模式
- 重新连接后自动同步变更
- 添加同步状态指示器（在线/离线/同步中）
- 设备重连时的身份验证恢复

##### 跨平台适配层实现
- 创建PlatformAdapter抽象类
- 实现WebPlatformAdapter
- 添加平台检测工具
- 实现通信策略管理器
- 实现Electron平台适配
  - 添加IPC通信支持
  - 集成Node.js网络发现功能
  - 创建Electron主进程代码
- 实现React Native平台适配
  - 集成原生网络发现模块
  - 添加AsyncStorage支持
  - 实现原生事件桥

##### 统一业务逻辑层实现
- 设计统一业务逻辑层接口（卡片管理、同步、认证、网络等）
- 实现平台无关的卡片管理服务（使用TypeScript类）
- 实现同步服务（集成Yjs，支持离线操作和网络同步）
- 实现Web平台适配器（IndexedDB存储、WebSocket网络）

#### 2.1.4 第四阶段：安全与网络优化（第7-8周）

##### 加密实现
- 创建EncryptionService类
- 实现密钥生成功能
- 实现数据加密和解密功能
- 集成加密功能到数据操作流程
- 对网络ID和设备ID存储进行安全处理

##### 认证安全优化
- 增强网络ID生成的随机性
- **Access Code有效期控制**：实现时间戳验证机制（用于确保连接信息新鲜度，非安全目的）
- 实现设备ID的隐私保护措施
- 添加网络连接状态检测
- 优化网络连接稳定性

##### 网络优化
- 实现mDNS/Bonjour服务发现
- 优化NAT穿透
- 添加连接质量监控
- 集成STUN/TURN服务器
- 优化ICE候选收集
- 添加连接质量评估
- 实现智能连接切换

##### 性能优化
- 实现虚拟滚动（大量卡片时）
- 添加防抖处理（搜索、输入）
- 优化图片和媒体资源加载
- 实现懒加载机制
- 优化设备ID生成和验证性能

#### 2.1.5 第五阶段：测试与部署（第9-10周）

##### 测试策略
- 单元测试：核心业务逻辑，包括认证服务和设备服务
- 集成测试：数据存储、同步和网络认证流程
- E2E测试：关键用户流程，包括网络认证、设备加入和协作编辑
- 性能测试：大量数据场景和多设备并发场景
- 安全测试：网络ID和设备ID生成的安全性
- 跨平台测试：Web、Electron、React Native三端一致性

##### 部署配置
- PWA配置优化
- 构建脚本优化
- CDN部署配置
- 监控和错误追踪
- 配置Electron Builder
- 创建React Native项目
- 配置应用签名和发布
- 部署信令服务器到Vercel
- 配置CI/CD流水线

### 2.2 技术选型

#### 2.2.1 Web平台
- **前端框架**: React 18 + TypeScript
- **构建工具**: Vite
- **UI库**: Ant Design
- **样式**: Tailwind CSS
- **状态管理**: Zustand
- **本地存储**: IndexedDB (Dexie.js)
- **数据同步**: Yjs + y-webrtc + y-indexeddb
- **网络发现**: WebSocket + mDNS/Bonjour
- **加密**: Web Crypto API

#### 2.2.2 Electron平台
- **版本**: Electron 25+
- **打包**: Electron Builder
- **原生模块**: Node.js内置模块
- **存储**: SQLite（可选）
- **网络发现**: Node.js mDNS/Bonjour库

#### 2.2.3 React Native平台
- **版本**: React Native 0.72+
- **导航**: React Navigation 6
- **存储**: AsyncStorage + SQLite
- **原生模块**: 自定义原生模块
- **网络发现**: 原生mDNS/Bonjour实现

#### 2.2.4 信令服务器
- **Runtime**: Node.js 18+
- **WebSocket**: ws库
- **部署**: Vercel Serverless Functions
- **监控**: Prometheus + Grafana

### 2.3 资源需求

#### 2.3.1 人力资源
- **前端开发者**: 1名（负责Web端适配）
- **Node.js开发者**: 1名（负责信令服务器）
- **移动端开发者**: 1名（负责React Native）
- **测试工程师**: 1名（负责跨平台测试）

#### 2.3.2 硬件资源
- **开发机器**: Mac（用于iOS开发）+ Windows（用于测试）
- **测试设备**: Android手机、iPhone、各平台电脑
- **服务器**: 云服务器（用于信令服务部署）

#### 2.3.3 软件资源
- **开发工具**: VS Code、Android Studio、Xcode
- **测试工具**: Jest、Cypress、Appium
- **部署工具**: Docker、Vercel CLI

### 2.4 开发里程碑与质量门禁

#### 2.4.1 开发里程碑

| 里程碑 | 时间 | 关键交付物 | 验收标准 |
|--------|------|------------|----------|
| M1 | 第2周末 | 基础框架 | 项目可运行，基础UI完成 |
| M2 | 第4周末 | 核心功能 | 卡片CRUD完整实现 |
| M3 | 第6周末 | 跨平台支持 | 三端基础功能完成 |
| M4 | 第8周末 | 网络优化 | 多设备同步可用，连接优化 |
| M5 | 第10周末 | 测试部署 | 测试通过，各平台部署完成 |

#### 2.4.2 质量门禁

##### 代码质量
- TypeScript零错误
- ESLint零警告
- 单元测试覆盖率>80%
- 关键路径E2E测试通过

##### 性能标准
- 首屏加载<3秒
- 卡片列表渲染<100ms
- 加密/解密操作<500ms
- 同步延迟<2秒
- WebRTC连接建立时间<3秒

##### 用户体验
- 所有交互响应<100ms
- 离线模式可用性100%
- 错误恢复率>99%

### 2.5 风险评估与应对策略

#### 2.5.1 技术风险

##### IndexedDB兼容性问题
- **风险**: 部分旧版浏览器不支持IndexedDB
- **概率**: 低 (现代浏览器支持率>95%)
- **影响**: 高 (无法存储数据)
- **应对策略**:
  - 添加IndexedDB可用性检测
  - 提供降级方案（localStorage）
  - 显示兼容性提示

##### WebRTC连接失败
- **风险**: 网络环境限制WebRTC连接
- **概率**: 中 (企业网络、防火墙限制)
- **影响**: 中 (无法实现多设备同步)
- **应对策略**:
  - 实现连接状态检测
  - 提供手动同步选项
  - 添加网络诊断工具

##### 加密性能问题
- **风险**: 大量数据加密影响性能
- **概率**: 低 (现代硬件性能充足)
- **影响**: 中 (用户体验下降)
- **应对策略**:
  - 实现分批加密处理
  - 使用Web Worker避免阻塞主线程
  - 优化加密算法参数

##### 跨平台兼容性
- **风险**: 不同平台API差异导致功能不一致
- **概率**: 高
- **影响**: 高 (用户体验不统一)
- **应对策略**:
  - 建立统一的适配层
  - 实现平台能力检测
  - 提供降级方案

#### 2.5.2 数据安全

##### 数据丢失风险
- **风险**: 用户误操作或设备故障导致数据丢失
- **概率**: 中
- **影响**: 极高
- **应对策略**:
  - 实现自动备份机制
  - 添加数据导出功能（后续版本）
  - 提供数据恢复工具

##### 密码遗忘风险
- **风险**: 用户忘记密码导致数据无法解密
- **概率**: 高
- **影响**: 极高 (数据永久丢失)
- **应对策略**:
  - 提供密码提示功能
  - 实现密钥恢复机制（需要安全考虑）
  - 添加数据备份建议

#### 2.5.3 用户体验

##### 首次使用复杂度
- **风险**: 首次使用需要设置密码，增加使用门槛
- **概率**: 高
- **影响**: 中 (用户流失)
- **应对策略**:
  - 提供可选的加密设置
  - 优化首次使用引导流程
  - 提供快速开始选项

##### 同步延迟感知
- **风险**: 用户感知到同步延迟，怀疑数据丢失
- **概率**: 中
- **影响**: 中 (用户信任度下降)
- **应对策略**:
  - 添加同步状态指示器
  - 实现实时同步状态反馈
  - 提供手动刷新功能

### 2.6 成功标准

#### 2.6.1 功能标准
- ✅ 支持Web、Electron、React Native三端
- ✅ 跨平台数据同步延迟<2秒
- ✅ 支持离线使用，网络恢复后自动同步
- ✅ 同一账户支持5+设备同时在线
- ✅ 三端设备能够在局域网内自动发现
- ✅ 支持纯离线环境下的实时协作

#### 2.6.2 性能标准
- ✅ 信令服务器支持1万并发连接
- ✅ 移动端应用启动时间<3秒
- ✅ 桌面端应用内存占用<200MB
- ✅ 网络发现成功率>90%
- ✅ 数据传输速率>1MB/s
- ✅ CPU占用率<30%

#### 2.6.3 质量标准
- ✅ 代码覆盖率>80%
- ✅ 关键路径无已知严重bug
- ✅ 用户满意度>4.5/5.0
- ✅ 崩溃率<0.1%

### 2.7 后续扩展规划

#### 2.7.1 功能扩展
- 标签系统（基于需求优先级）
- 全文搜索功能
- 数据导出/导入
- 主题切换
- 回收站功能
- 协作编辑功能
- 更多数据类型同步

#### 2.7.2 技术升级
- 服务端同步备份
- 多端应用（iOS/Android原生）
- AI辅助功能
- 支持更大规模的设备组网（>10台设备）
- 实现更智能的网络质量自适应
- 企业级功能（权限管理、审计日志）

#### 2.7.3 平台扩展
- 支持更多平台（如Flutter）
- 边缘计算和分布式存储
- 音视频、文件共享等更多协作场景
- 构建开放的插件生态系统

### 2.8 成本预算

#### 2.8.1 开发成本
- **人力成本**: 2.5个月 × 4人 × $5,000/月 = $50,000
- **设备成本**: $5,000（测试设备）
- **软件成本**: $1,000（开发工具许可）
- **总计**: $56,000

#### 2.8.2 运营成本（年）
- **信令服务器**: $240（$20/月 × 12月）
- **监控服务**: $600（$50/月 × 12月）
- **CDN和存储**: $360（$30/月 × 12月）
- **总计**: $1,200/年

## 3. 注意事项

### 3.1 实施风险
- 跨平台开发可能遇到API差异，需要预留额外时间解决兼容性问题
- WebRTC连接在某些网络环境下可能不稳定，需要提供备用方案
- 离线优先架构需要仔细处理数据同步冲突，避免数据丢失

### 3.2 资源限制
- 开发团队需要具备跨平台开发经验，特别是React Native和Electron
- 测试需要覆盖多种设备和网络环境，测试资源需求较高
- 信令服务器需要考虑并发连接数和稳定性问题

### 3.3 时间规划
- 总体时间规划较为紧凑，建议预留2-3周的缓冲时间
- 跨平台适配可能需要额外时间，特别是移动端原生功能集成
- 测试阶段需要充分时间，确保各平台功能一致性

## 4. 关联文档

- [需求文档](../01-requirements/0101-requirements.md) - 了解项目需求
- [技术栈文档](0301-tech-stack.md) - 了解项目技术选型
- [技术概念文档](0302-tech-concepts.md) - 了解核心技术概念
- [离线局域网架构](0308-offline-lan-architecture.md) - 了解离线组网方案
- [测试文档](../04-testing/0401-test-overview.md) - 了解测试策略

---

*本实施计划基于当前技术调研和架构设计制定，实施过程中可根据实际情况进行调整优化。*