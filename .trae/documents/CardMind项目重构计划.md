# CardMind项目重构计划

## 1. 项目现状分析

### 1.1 当前代码结构
- 单文件结构，仅包含一个`main.dart`文件
- 简单的Loro库测试页面，用于验证CRDT功能
- 未实现任何实际业务功能

### 1.2 文档要求
- 前后端分离架构：前端Flutter，后端Rust，通过flutter_rust_bridge通信
- 核心功能：卡片管理、协作网络管理、设备管理
- 技术栈：Loro（CRDT）、libp2p（P2P网络）、SQLite（存储）、UUID v7（ID生成）

## 2. 重构目标

### 2.1 架构优化
- 实现前后端分离架构
- 模块化设计，提高代码可维护性
- 清晰的层次结构，便于功能扩展

### 2.2 功能实现
- 完整的卡片管理功能
- 协作网络管理功能
- 设备管理功能
- P2P网络通信
- 数据持久化

### 2.3 代码质量
- 遵循最佳实践和设计模式
- 完善的测试用例
- 清晰的文档

## 3. 重构方案

### 3.1 目录结构设计

```
lib/
├── models/          # 数据模型定义
├── api/             # 前端API封装
├── widgets/         # 自定义组件
├── screens/         # 页面组件
├── services/        # 服务层
├── utils/           # 工具函数
└── main.dart        # 应用入口

rust/
├── src/
│   ├── models/      # 数据模型
│   ├── api/         # API实现
│   ├── storage/     # 数据存储
│   ├── network/     # 网络通信
│   └── lib.rs       # Rust库入口
└── Cargo.toml       # Rust依赖管理
```

### 3.2 核心模块设计

#### 3.2.1 数据模型
- **卡片模型**：id、标题、内容、创建时间、更新时间
- **协作网络模型**：id、昵称、密码、创建时间、更新时间、设备列表
- **设备模型**：id、昵称、创建时间、更新时间

#### 3.2.2 API接口
- **卡片API**：创建、编辑、删除、列表、详情、加入网络、退出网络
- **网络API**：创建、加入、退出、列表、重命名、设置常驻网络
- **设备API**：列表、详情、更新昵称

#### 3.2.3 存储层
- 使用SQLite数据库
- 表结构设计：卡片表、网络表、设备表、网络设备关联表、卡片网络关联表、常驻网络表
- 使用sea-orm和rusqlite库

#### 3.2.4 网络层
- 基于libp2p的P2P网络通信
- mDNS设备发现
- 无需传统信令服务器
- 设备间直接通信

### 3.3 重构步骤

1. **搭建基础架构**
   - 创建项目目录结构
   - 配置Rust开发环境
   - 设置flutter_rust_bridge

2. **实现后端核心**
   - 数据模型定义
   - 数据库操作
   - 业务逻辑实现
   - API接口开发

3. **实现前端界面**
   - 卡片列表和编辑界面
   - 网络设置界面
   - 设备管理界面

4. **实现前后端通信**
   - 定义API接口
   - 生成通信代码
   - 测试通信机制

5. **实现P2P网络**
   - libp2p集成
   - 设备发现
   - 数据同步

6. **测试和优化**
   - 单元测试
   - 功能测试
   - 集成测试
   - 性能优化

## 4. 重构前后对比

| 维度 | 重构前 | 重构后 |
|------|--------|--------|
| 架构 | 单文件测试页面 | 前后端分离，模块化设计 |
| 功能 | 仅Loro测试 | 完整的卡片笔记应用功能 |
| 可维护性 | 低 | 高 |
| 可扩展性 | 差 | 好 |
| 测试覆盖率 | 无 | 完善 |

## 5. 关键技术点

### 5.1 前后端通信
- 使用flutter_rust_bridge实现跨语言调用
- 自动生成通信代码
- 高效的数据序列化

### 5.2 CRDT数据同步
- 基于Loro的CRDT算法
- 每个卡片和网络对应一个LoroDoc
- 增量同步，减少网络带宽消耗

### 5.3 P2P网络通信
- 基于libp2p的设备发现和通信
- 无需中心化服务器
- 支持NAT穿透

### 5.4 数据持久化
- SQLite数据库存储
- 读写分离设计
- 高效的查询性能

## 6. 预期成果

### 6.1 功能实现
- ✅ 卡片管理：创建、编辑、删除、同步
- ✅ 协作网络：创建、加入、退出、管理
- ✅ 设备管理：发现、连接、状态管理
- ✅ P2P通信：设备发现、数据同步
- ✅ 数据持久化：本地存储、数据恢复

### 6.2 代码质量
- ✅ 模块化设计
- ✅ 清晰的层次结构
- ✅ 完善的测试用例
- ✅ 符合最佳实践

### 6.3 性能优化
- ✅ 读写分离
- ✅ 增量同步
- ✅ 高效的数据库操作
- ✅ 优化的网络通信

## 7. 风险与挑战

### 7.1 技术复杂度
- libp2p集成复杂度较高
- 跨语言开发增加调试难度
- CRDT数据同步逻辑复杂

### 7.2 测试难度
- 多设备测试环境搭建
- 网络状态模拟
- 边界情况处理

### 7.3 性能优化
- 大量数据同步时的性能问题
- 网络延迟和稳定性
- 资源占用优化

## 8. 重构文档

### 8.1 架构设计文档
- 详细的架构图
- 模块间依赖关系
- 数据流向图

### 8.2 API接口文档
- 所有API接口定义
- 请求和响应格式
- 错误码定义

### 8.3 测试文档
- 单元测试用例
- 功能测试用例
- 集成测试用例

### 8.4 部署文档
- 开发环境搭建
- 构建流程
- 部署方式

## 9. 重构完成标准

1. ✅ 所有功能实现完成
2. ✅ 测试用例通过
3. ✅ 代码质量符合要求
4. ✅ 文档完整
5. ✅ 性能达到预期
6. ✅ 可维护性良好

## 10. 后续计划

1. 持续优化性能
2. 添加更多功能
3. 完善用户体验
4. 支持更多平台
5. 社区建设

---

通过本次重构，CardMind项目将实现从简单测试页面到完整应用的转变，具备良好的架构设计、完整的功能实现和高质量的代码，为后续的发展奠定坚实的基础。